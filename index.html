<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Êô∫ÊÖßÈÄ£Á∑öÂÄâÂ∫´ÁÆ°ÁêÜÁ≥ªÁµ± (Èõ≤Á´ØAPIÁâà)</title>
    
    <!-- 1. ËºâÂÖ• Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ËºâÂÖ• Babel Áî®ÊñºËß£Êûê JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. ËºâÂÖ•Â§ñÈÉ®Â•ó‰ª∂ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        * { -webkit-tap-highlight-color: transparent; }
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #4F46E5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4F46E5; }
        /* Batch Export Container */
        #batch-export-container { position: fixed; left: -9999px; top: 0; width: 450px; z-index: -1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useRef } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';
        import { 
            LayoutDashboard, Package, ShoppingCart, Users, Zap, Plus, ArrowRight, AlertCircle, 
            CheckCircle2, Combine, Split, MessageCircle, Truck, DollarSign, Search, Filter, 
            X, ChevronRight, ChevronUp, ClipboardList, User, ShoppingBag, ListOrdered, Tag, 
            Layers, Archive, CheckSquare, Square, Trash2, Edit, Save, Copy, CreditCard, 
            RotateCcw, Minus, TrendingUp, Wallet, BoxSelect, Undo2, PackageCheck, FileSpreadsheet,
            Image as ImageIcon, Download, Loader2, Upload, Cloud, Settings, UploadCloud, DownloadCloud
        } from 'https://esm.sh/lucide-react@0.263.1?dev';

        const App = () => {
            // --- 1. State Definitions ---
            // Âæû localStorage ËÆÄÂèñË≥áÊñôÔºåÂ¶ÇÊûúÊ≤íÊúâÂâá‰ΩøÁî®È†êË®≠ÂÄº
            const loadLocal = (key, def) => {
                const saved = localStorage.getItem(key);
                return saved ? JSON.parse(saved) : def;
            };

            const [products, setProducts] = useState(() => loadLocal('smartwms_products', [
                { id: 'p1', name: 'Êó•Êú¨Ê•µËá¥ÂêπÈ¢®Ê©ü', variant: 'ÁèçÁè†ÁôΩ', spot: 2, price: 3200, tierMinQty: 0, tierPrice: 0 },
                { id: 'p2', name: 'Êó•Êú¨Ê•µËá¥ÂêπÈ¢®Ê©ü', variant: 'Ê∂àÂÖâÈªë', spot: 3, price: 3200, tierMinQty: 0, tierPrice: 0 },
                { id: 'p3', name: 'Ê≥ïÂºèÈªëÂ∑ßÂÖãÂäõÁõí', variant: 'ÂñÆ‰∏ÄÊ¨æÂºè', spot: 20, price: 450, tierMinQty: 0, tierPrice: 0 },
            ]));
            const [orders, setOrders] = useState(() => loadLocal('smartwms_orders', [
                { id: 'o1', customer: 'ÊûóÂ∞èÁæé', total: 6400, paid: 0, status: 'ÈÉ®ÂàÜÂà∞Ë≤®', items: [{ productId: 'p1', name: 'Êó•Êú¨Ê•µËá¥ÂêπÈ¢®Ê©ü', variant: 'ÁèçÁè†ÁôΩ', qty: 2, allocatedQty: 1, price: 3200 }], debt: 0, unclaimed: 1 },
            ]));
            const [apiUrl, setApiUrl] = useState(() => localStorage.getItem('smartwms_api_url') || '');

            // ‰øùÂ≠òÂà∞ localStorage
            useEffect(() => { localStorage.setItem('smartwms_products', JSON.stringify(products)); }, [products]);
            useEffect(() => { localStorage.setItem('smartwms_orders', JSON.stringify(orders)); }, [orders]);
            useEffect(() => { localStorage.setItem('smartwms_api_url', apiUrl); }, [apiUrl]);

            // UI States
            const [activeTab, setActiveTab] = useState('products');
            const [showProxyOrder, setShowProxyOrder] = useState(false);
            const [showPurchaseList, setShowPurchaseList] = useState(false);
            const [showRevenueList, setShowRevenueList] = useState(false);
            const [showDebtList, setShowDebtList] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            
            const [selectedGroupName, setSelectedGroupName] = useState(null); 
            const [selectedCustomerDetail, setSelectedCustomerDetail] = useState(null);
            const [selectedArrivalCustomer, setSelectedArrivalCustomer] = useState(null); 
            
            const [isEditingProduct, setIsEditingProduct] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false); // ÂêåÊ≠•‰∏≠ÁãÄÊÖã
            
            const [editingOrderQtyId, setEditingOrderQtyId] = useState(null);
            const [editingAllocatedQtyId, setEditingAllocatedQtyId] = useState(null);
            const [editingArrivedQtyId, setEditingArrivedQtyId] = useState(null);
            const [editingPurchaseQtyId, setEditingPurchaseQtyId] = useState(null);

            const [isBatchExporting, setIsBatchExporting] = useState(false);
            const [batchProgress, setBatchProgress] = useState(0);
            
            const [selectedCustomerIds, setSelectedCustomerIds] = useState(new Set());

            const [proxyForm, setProxyForm] = useState({
                productName: '', variant: '', price: '', customer: '', qty: 1, purchasedQty: 0
            });

            const [notification, setNotification] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            
            const notify = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            // --- 3. Data Logic (Calculations) ---
            
            const productsWithStats = useMemo(() => {
                return products.map(p => {
                    let allocated = 0; 
                    let confirmed = 0; 
                    orders.forEach(o => {
                        if (o.items) {
                            o.items.forEach(item => {
                                if (item.productId === p.id) {
                                    allocated += (item.qty || 0);
                                    confirmed += (item.allocatedQty || 0);
                                }
                            });
                        }
                    });
                    const pending = allocated - confirmed;
                    const totalOwned = (p.spot || 0) + confirmed;
                    const shortage = Math.max(0, allocated - totalOwned);
                    return { ...p, allocated, confirmed, pending, shortage };
                });
            }, [products, orders]);

            const customerList = useMemo(() => {
                const map = {};
                orders.forEach(o => {
                    if (!map[o.customer]) {
                        map[o.customer] = { 
                            id: o.customer, name: o.customer, totalSpent: 0, totalPaid: o.paid || 0, orderCount: 0, debt: 0, items: [], rawItems: []
                        };
                    } else { map[o.customer].totalPaid += (o.paid || 0); }
                    map[o.customer].orderCount += 1;
                    if (o.items) o.items.forEach(item => map[o.customer].rawItems.push({ ...item, orderId: o.id }));
                });

                Object.values(map).forEach(cust => {
                    const nameCounts = {};
                    cust.rawItems.forEach(item => {
                        const productInfo = products.find(p => p.id === item.productId);
                        const productName = productInfo ? productInfo.name : item.name;
                        if (!nameCounts[productName]) nameCounts[productName] = 0;
                        nameCounts[productName] += item.qty;
                    });
                    cust.rawItems.forEach(item => {
                        const productInfo = products.find(p => p.id === item.productId);
                        let finalPrice = item.price;
                        let originalPrice = item.price;
                        let tierMinQty = 0;
                        let tierPrice = 0;
                        if (productInfo) {
                            originalPrice = productInfo.price;
                            tierMinQty = productInfo.tierMinQty;
                            tierPrice = productInfo.tierPrice;
                            const pName = productInfo.name;
                            if (tierMinQty > 0 && nameCounts[pName] >= tierMinQty) finalPrice = tierPrice;
                        }
                        const itemTotal = (item.qty || 0) * finalPrice;
                        cust.items.push({
                            ...item, finalPrice, isDiscounted: finalPrice < originalPrice, itemTotal, isAllocated: (item.allocatedQty || 0) >= item.qty
                        });
                        cust.totalSpent += itemTotal;
                    });
                    cust.debt = Math.max(0, cust.totalSpent - cust.totalPaid);
                });
                return Object.values(map);
            }, [orders, products]);

            const stats = useMemo(() => {
                const totalRevenue = customerList.reduce((acc, curr) => acc + curr.totalSpent, 0); 
                let shortageItemCount = 0; let totalShortageQty = 0;  
                productsWithStats.forEach(p => { if (p.shortage > 0) { shortageItemCount += 1; totalShortageQty += p.shortage; } });
                return { totalRevenue, shortageItemCount, totalShortageQty };
            }, [productsWithStats, customerList]); 

            const arrivalCustomers = useMemo(() => {
                return customerList.map(cust => {
                    const totalItems = cust.items.length;
                    const fullItems = cust.items.filter(i => (i.allocatedQty || 0) >= i.qty).length;
                    const totalQty = cust.items.reduce((s, i) => s + (i.qty || 0), 0);
                    const allocatedQty = cust.items.reduce((s, i) => s + (i.allocatedQty || 0), 0);
                    const isFullyArrived = totalItems > 0 && totalItems === fullItems;
                    return { ...cust, totalItems, fullItems, totalQty, allocatedQty, isFullyArrived };
                }).sort((a,b) => (a.isFullyArrived === b.isFullyArrived ? 0 : a.isFullyArrived ? -1 : 1));
            }, [customerList]);

            const { pendingArrivals, shippedArrivals } = useMemo(() => {
                const pending = [], shipped = [];
                arrivalCustomers.forEach(c => {
                    const hasPending = orders.some(o => o.customer === c.name && o.status !== 'Â∑≤Âá∫Ë≤®');
                    if (hasPending) pending.push(c);
                    else if (orders.some(o => o.customer === c.name)) shipped.push(c);
                });
                return { pendingArrivals: pending, shippedArrivals: shipped };
            }, [arrivalCustomers, orders]);

            const groupedProducts = useMemo(() => {
                 const groups = {};
                 products.forEach(p => {
                     if(!groups[p.name]) groups[p.name] = { ...p, variants: [], totalAllocated:0, totalConfirmed:0, totalSpot:0 };
                     groups[p.name].variants.push(p);
                     const stats = productsWithStats.find(ps => ps.id === p.id);
                     if(stats) {
                         groups[p.name].totalAllocated += stats.allocated;
                         groups[p.name].totalConfirmed += stats.confirmed;
                         groups[p.name].totalSpot += (p.spot || 0);
                     }
                 });
                 return Object.values(groups);
            }, [products, productsWithStats]);

            const purchaseList = useMemo(() => productsWithStats.filter(p => p.shortage > 0).map(p => ({ ...p })), [productsWithStats]);
            const revenueCustomers = useMemo(() => customerList.filter(c => c.totalSpent > 0).sort((a, b) => b.totalSpent - a.totalSpent), [customerList]);
            const debtCustomers = useMemo(() => customerList.filter(c => c.debt > 0).sort((a,b)=> b.debt - a.debt), [customerList]);

            const filteredGroupedProducts = groupedProducts.filter(g => g.name.includes(searchQuery));
            const filteredCustomers = customerList.filter(c => c.name.includes(searchQuery));
            const filteredPendingArrivals = pendingArrivals.filter(c => c.name.includes(searchQuery));
            const filteredShippedArrivals = shippedArrivals.filter(c => c.name.includes(searchQuery));
            
            const availableVariants = useMemo(() => [...new Set(products.filter(p => p.name === proxyForm.productName).map(p => p.variant))], [products, proxyForm.productName]);

            const currentSelectedCustomer = selectedCustomerDetail ? customerList.find(c => c.name === selectedCustomerDetail.name) : null;
            const currentSelectedArrivalCustomer = selectedArrivalCustomer 
                ? (selectedArrivalCustomer.source === 'shipped' 
                    ? shippedArrivals.find(c => c.name === selectedArrivalCustomer.name) 
                    : pendingArrivals.find(c => c.name === selectedArrivalCustomer.name)) 
                  || selectedArrivalCustomer 
                : null;
            const isArrivalShipped = currentSelectedArrivalCustomer && !orders.some(o => o.customer === currentSelectedArrivalCustomer.name && o.status !== 'Â∑≤Âá∫Ë≤®');

            // --- API Sync Functions ---

            const handleCloudUpload = async () => {
                if (!apiUrl) { notify("Ë´ãÂÖàË®≠ÂÆö API Á∂≤ÂùÄ"); setShowSettings(true); return; }
                setIsSyncing(true);
                try {
                    const payload = { products, orders, updatedAt: new Date().toISOString() };
                    // ‰ΩøÁî® fetch ÂÇ≥ÈÄÅ POST Ë´ãÊ±Ç
                    // Note: Google Apps Script Web App ÂøÖÈ†àÈÉ®ÁΩ≤ÁÇ∫ 'Me' + 'Anyone' ÊâçËÉΩË∑®ÂüüÂ≠òÂèñÔºå‰∏îÈúÄËôïÁêÜ redirect
                    // ÈÄôË£°‰ΩøÁî® 'no-cors' Ê®°ÂºèÁôºÈÄÅÔºåÈõñÁÑ∂Êãø‰∏çÂà∞ÂõûÊáâÔºå‰ΩÜËÉΩÊàêÂäüÈÄÅÂá∫Ë≥áÊñô
                    // Ëã•Ë¶ÅÊãøÂõûÊáâÔºåÂæåÁ´ØÈúÄÊ≠£Á¢∫Ë®≠ÂÆö CORS headers
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    const res = await response.json();
                    if(res.result === 'success') notify("‚òÅÔ∏è ‰∏äÂÇ≥ÂÇô‰ªΩÊàêÂäüÔºÅ");
                    else notify("‰∏äÂÇ≥Â§±ÊïóÔºåË´ãÊ™¢Êü• API");
                } catch (error) {
                    console.error("Upload error:", error);
                    // ÂòóË©¶Áî® no-cors
                    try {
                        await fetch(apiUrl, {
                             method: 'POST',
                             mode: 'no-cors',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify({ products, orders, updatedAt: new Date().toISOString() })
                        });
                        notify("‚òÅÔ∏è Â∑≤ÁôºÈÄÅÂÇô‰ªΩË´ãÊ±Ç");
                    } catch(e) {
                         notify("ÈÄ£Á∑öÂ§±Êïó");
                    }
                } finally {
                    setIsSyncing(false);
                }
            };

            const handleCloudDownload = async () => {
                if (!apiUrl) { notify("Ë´ãÂÖàË®≠ÂÆö API Á∂≤ÂùÄ"); setShowSettings(true); return; }
                setIsSyncing(true);
                try {
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    if (data && data.products && data.orders) {
                        if(confirm(`ÁôºÁèæÈõ≤Á´ØÂÇô‰ªΩ (ÊôÇÈñì: ${data.updatedAt || 'Êú™Áü•'})\nÊòØÂê¶‰∏ãËºâ‰∏¶Ë¶ÜËìãÁõÆÂâçË≥áÊñôÔºü`)) {
                            setProducts(data.products);
                            setOrders(data.orders);
                            notify("‚òÅÔ∏è ‰∏ãËºâÂêåÊ≠•ÊàêÂäüÔºÅ");
                        }
                    } else {
                        notify("Èõ≤Á´ØÁÑ°Ë≥áÊñôÊàñÊ†ºÂºèÈåØË™§");
                    }
                } catch (error) {
                    console.error("Download error:", error);
                    notify("‰∏ãËºâÂ§±ÊïóÔºåË´ãÊ™¢Êü• API");
                } finally {
                    setIsSyncing(false);
                }
            };

            // --- Handlers ---
            const navigateTo = (tab) => { setActiveTab(tab); setSearchQuery(''); };
            const handleProxyProductChange = (e) => {
                const name = e.target.value;
                const existing = products.find(p => p.name === name);
                setProxyForm(prev => ({ ...prev, productName: name, price: existing ? existing.price : prev.price }));
            };

            const handleUpdateOrderQty = (orderId, productId, newQtyStr) => {
                const newQty = parseInt(newQtyStr, 10);
                if (isNaN(newQty) || newQty < 0) return;
                const order = orders.find(o => o.id === orderId);
                const newItems = order.items.map(item => item.productId === productId ? { ...item, qty: newQty } : item).filter(item => item.qty > 0);
                if (newItems.length === 0) {
                    if(confirm("ÂïÜÂìÅÊï∏ÈáèÊ≠∏Èõ∂ÔºåÊòØÂê¶Âà™Èô§Ê≠§Ë®ÇÂñÆÔºü")) setOrders(prev => prev.filter(o => o.id !== orderId));
                } else {
                    setOrders(prev => prev.map(o => o.id === orderId ? { ...o, items: newItems } : o));
                }
                setEditingOrderQtyId(null);
            };

            const handleUpdateAllocatedQty = (orderId, productId, val) => {
                 const newAllocated = parseInt(val, 10);
                 if (isNaN(newAllocated) || newAllocated < 0) return;
                 const order = orders.find(o => o.id === orderId);
                 const item = order.items.find(i => i.productId === productId);
                 const prod = products.find(p=>p.id===productId);
                 
                 if (newAllocated > item.qty) { notify(`ÈÖçË≤®‰∏çÂèØÂ§ßÊñºÂñäÂñÆ`); setEditingAllocatedQtyId(null); return; }
                 const diff = newAllocated - (item.allocatedQty || 0);

                 setOrders(prev => prev.map(o => {
                     if (o.id === orderId) {
                         const newItems = o.items.map(i => i.productId === productId ? { ...i, allocatedQty: newAllocated } : i);
                         return { ...o, items: newItems };
                     }
                     return o;
                 }));
                 
                 setProducts(prev => prev.map(p => p.id === productId ? { ...p, spot: (p.spot || 0) - diff } : p));
                 setEditingAllocatedQtyId(null);
            };

            const handleUpdatePurchaseQty = (pid, val) => {
                const s = parseInt(val, 10); if (isNaN(s) || s < 0) return;
                const p = productsWithStats.find(x => x.id === pid);
                if(p) {
                    const newSpot = p.allocated - p.confirmed - s;
                    setProducts(prev => prev.map(x => x.id === pid ? { ...x, spot: newSpot } : x));
                    setEditingPurchaseQtyId(null);
                    notify('Â∫´Â≠òÂ∑≤Ë™øÊï¥');
                }
            };

            const handleDeleteOrderItem = (oid, pid) => {
                if(!confirm('Âà™Èô§Ê≠§ÂïÜÂìÅÔºü')) return;
                const order = orders.find(o => o.id === oid);
                const item = order.items.find(i => i.productId === pid);
                
                if (item && (item.allocatedQty||0) > 0) {
                     setProducts(prev => prev.map(p => p.id === pid ? { ...p, spot: (p.spot||0) + item.allocatedQty } : p));
                }
                
                const newItems = order.items.filter(i => i.productId !== pid);
                if (newItems.length === 0) setOrders(prev => prev.filter(o => o.id !== oid));
                else setOrders(prev => prev.map(o => o.id === oid ? { ...o, items: newItems } : o));
                
                notify("Â∑≤Âà™Èô§");
            };

            const handleUpdateProductInfo = (pid, f, v) => {
                const val = parseInt(v, 10); if (isNaN(val)) return;
                const target = products.find(p => p.id === pid);
                const targetName = target?.name;
                
                setProducts(prev => prev.map(p => {
                     if (f.startsWith('tier') && p.name === targetName) return { ...p, [f]: val };
                     if (p.id === pid) return { ...p, [f]: val };
                     return p;
                }));
            };

            const handleDeleteProduct = (pid) => { 
                if(confirm("Âà™Èô§Ê¨æÂºèÔºü")) setProducts(prev => prev.filter(p => p.id !== pid)); 
            };
            
            const handleDeleteProductGroup = (name, e) => {
                e.stopPropagation(); if(confirm(`Âà™Èô§ ${name}Ôºü`)) {
                    setProducts(prev => prev.filter(p => p.name !== name));
                    setSelectedGroupName(null);
                }
            };
            
            const handleDeleteCustomer = (name, e) => {
                e.stopPropagation(); if(confirm(`Âà™Èô§ ${name}Ôºü`)) {
                    setOrders(prev => prev.filter(o => o.customer !== name));
                    if(selectedCustomerDetail?.name===name) setSelectedCustomerDetail(null);
                }
            };

            const toggleAllocation = (oid, pid, curr, total) => {
                 const next = curr >= total ? 0 : total;
                 const diff = next - curr;
                 const p = products.find(x => x.id === pid);
                 if(diff > 0 && (p.spot||0) < diff) notify("‚ö†Ô∏è ÁèæË≤®‰∏çË∂≥");
                 
                 setOrders(prev => prev.map(o => {
                     if (o.id === oid) {
                         const newItems = o.items.map(i => i.productId === pid ? { ...i, allocatedQty: next } : i);
                         return { ...o, items: newItems };
                     }
                     return o;
                 }));
                 
                 setProducts(prev => prev.map(pr => pr.id === pid ? { ...pr, spot: (pr.spot||0) - diff } : pr));
            };

            const handleShipCustomer = (name) => {
                if(!confirm(`Á¢∫Ë™ç ${name} Â∑≤Âá∫Ë≤®Ôºü`)) return;
                setOrders(prev => prev.map(o => o.customer === name && o.status !== 'Â∑≤Âá∫Ë≤®' ? { ...o, status: 'Â∑≤Âá∫Ë≤®' } : o));
                setSelectedArrivalCustomer(null);
                notify("Â∑≤Âá∫Ë≤®");
            };

            const handleUnshipCustomer = (name) => {
                if(!confirm(`ÂõûÂæ© ${name} ÁÇ∫Êú™Âá∫Ë≤®Ôºü`)) return;
                setOrders(prev => prev.map(o => o.customer === name && o.status === 'Â∑≤Âá∫Ë≤®' ? { ...o, status: 'ÂæÖÁµêÂñÆ' } : o));
                setSelectedArrivalCustomer(null);
                notify("Â∑≤ÂõûÂæ©");
            };

            const handleAddOrder = () => {
                const { productName, variant, price, customer, qty, purchasedQty } = proxyForm;
                const finalVariant = variant || 'ÂñÆ‰∏ÄÊ¨æÂºè';
                if (!productName || !price) { notify('Ë´ãÂ°´ÂØ´ÂÆåÊï¥'); return; }
                const quantity = parseInt(qty, 10) || 1;
                const pQty = parseInt(purchasedQty, 10) || 0;
                const finalPrice = parseInt(price, 10) || 0;
                
                let targetProduct = products.find(p => p.name === productName && p.variant === finalVariant);
                let productId = targetProduct?.id;
                
                if (!targetProduct) {
                    productId = Date.now().toString();
                    const newProd = { id: productId, name: productName, variant: finalVariant, price: finalPrice, spot: pQty, tierMinQty: 0, tierPrice: 0 };
                    setProducts(prev => [...prev, newProd]);
                } else if (pQty > 0) {
                    setProducts(prev => prev.map(p => p.id === productId ? { ...p, spot: (p.spot || 0) + pQty } : p));
                }

                if (customer) {
                    const newOrder = {
                        id: Date.now().toString() + Math.random(),
                        customer, 
                        total: finalPrice * quantity, 
                        paid: 0, 
                        status: 'ÂæÖÁµêÂñÆ', 
                        items: [{ productId, name: productName, variant: finalVariant, qty: quantity, price: finalPrice, allocatedQty: 0 }],
                        debt: 0, 
                        unclaimed: 0
                    };
                    setOrders(prev => [...prev, newOrder]);
                    notify(`Âä†ÂñÆÊàêÂäü`);
                } else { notify(`Â∑≤ÂÖ•Â∫´`); }
                setShowProxyOrder(false);
                setProxyForm({ productName: '', variant: '', price: '', customer: '', qty: 1, purchasedQty: 0 });
            };

            const handleCopyCustomerDetails = (customer) => {
                 let itemsText = '';
                customer.items.forEach(item => {
                    const priceDisplay = item.isDiscounted ? `$${item.finalPrice} (ÂÑ™ÊÉ†)` : `$${item.finalPrice}`;
                    itemsText += `- ${item.name} ${item.variant !== 'ÂñÆ‰∏ÄÊ¨æÂºè' && item.variant ? `(${item.variant})` : ''} x${item.qty} ${priceDisplay}\n`;
                });
                const text = `Ë¶™ÊÑõÁöÑ ${customer.name} ÊÇ®Â•ΩÔºå\nÊÇ®Êú¨Ê¨°ÁöÑÈÄ£Á∑öË≥ºÁâ©ÊòéÁ¥∞Â¶Ç‰∏ãÔºö\n${itemsText}----------------\nÊ∂àË≤ªÁ∏ΩÈ°çÔºö$${customer.totalSpent.toLocaleString()}\n\nÂèØ‰ª•ÂÖàÂπ´ÊàëÊê≠Ê≥¢ÂçªÂèØ\nÊúâË™§ÁöÑË©±ÔΩûË´ãË∂ïÂø´Ë∑üÊàëË™™ÔºÅ\n‚Çä‚äπ Ëã•ÊòØÊ≤íÊúâÊºèÊéâÁöÑÂïÜÂìÅ ‚Çä‚äπ\nÂ∞±ÂèØ‰ª•Áõ¥Êé•ÁµêÂ∏≥ÂõâÔºÅ\nÁ∂≤ÂùÄÔºöÔºàÈÄôË£°ÁïôÁµ¶ÊàëËá™Â∑±Ëº∏ÂÖ•Á∂≤ÂùÄÔºâ\nÊâæÂà∞Ëá™Â∑±ÂêçÂ≠óÂæåÂÆåÊàê‰∏ãÂñÆÂ∞±ÂèØ‰ª•Âöï\nêôö Êî∂Âà∞ÊâÄÊúâÈÄ£ÁµêÂæåË´ãÁõ°ÈÄüÂÆåÊàê‰ªòÊ¨æ\n   ‰∏çË¶ÅËÄΩË™§Âà∞ÊúÄ‰Ω≥ÁöÑË≥ûÂë≥ÊúüÈôêÂî∑\n\n‚öù p.s. Ââç‰∏ÄÊ¨°ÈÄ£Á∑öÊúâÈñãÁÆ±ÂàÜ‰∫´ÁöÑÊúãÂèã~\n‰∏ãÂñÆÂæåË´ãÂπ´ÊàëÂÇôË®ª‰∏Ä‰∏ãÔºöÈñãÁÆ±Á¶Æ\nùê≠ùê°ùêöùêßùê§ ùê≤ùê®ùêÆ (‚Äû‚Ä¢ ÷ä ‚Ä¢‚Äû)‡©≠`;
                navigator.clipboard.writeText(text).then(() => notify("Â∑≤Ë§áË£Ω")).catch(() => notify("Ë§áË£ΩÂ§±Êïó"));
            };

            const handleExportToImage = async (customerName) => {
                const element = document.getElementById('customer-detail-export-area');
                if (!element) return;
                try {
                    const canvas = await html2canvas(element, { useCORS: true, backgroundColor: '#ffffff', scale: 2 });
                    const dataUrl = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = `${customerName}_Ë®ÇÂñÆÊòéÁ¥∞.png`;
                    link.href = dataUrl;
                    link.click();
                    notify("ÂúñÁâáÂ∑≤ÂåØÂá∫");
                } catch (err) { console.error(err); notify("ÂåØÂá∫Â§±Êïó"); }
            };

            // È°ßÂÆ¢ÈÅ∏ÂèñÂàáÊèõ
            const toggleCustomerSelection = (name) => {
                const newSet = new Set(selectedCustomerIds);
                if (newSet.has(name)) newSet.delete(name);
                else newSet.add(name);
                setSelectedCustomerIds(newSet);
            };

            const toggleSelectAll = () => {
                if (selectedCustomerIds.size === filteredCustomers.length) setSelectedCustomerIds(new Set());
                else setSelectedCustomerIds(new Set(filteredCustomers.map(c => c.name)));
            };

            const handleBatchExportImages = async () => {
                if (selectedCustomerIds.size === 0) { notify("Ë´ãÂÖàÂãæÈÅ∏È°ßÂÆ¢"); return; }
                setIsBatchExporting(true); setBatchProgress(0);
                await new Promise(resolve => setTimeout(resolve, 500));
                try {
                    const zip = new JSZip();
                    const container = document.getElementById('batch-export-container');
                    const customerDivs = container.querySelectorAll('.batch-customer-card');
                    let count = 0;
                    for (const div of customerDivs) {
                        const name = div.getAttribute('data-name');
                        if (!selectedCustomerIds.has(name)) continue;

                        const canvas = await html2canvas(div, { useCORS: true, backgroundColor: '#ffffff', scale: 2 });
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                        zip.file(`${name}.png`, blob);
                        count++; setBatchProgress(Math.round((count / selectedCustomerIds.size) * 100));
                    }
                    const content = await zip.generateAsync({ type: "blob" });
                    saveAs(content, `Ë®ÇÂñÆÂúñÁâá_${new Date().toISOString().slice(0,10)}.zip`);
                    notify("ÊâìÂåÖÂÆåÊàê");
                } catch (err) { console.error(err); notify("ÊâìÂåÖÂ§±Êïó"); } finally { setIsBatchExporting(false); }
            };

            const handleExportToCSV = () => {
                let csv = "data:text/csv;charset=utf-8,\uFEFFÈ°ßÂÆ¢,ÂïÜÂìÅ,Ê¨æÂºè,Êï∏Èáè,ÂñÆÂÉπ,Á∏ΩÂÉπ\n";
                customerList.forEach(c => c.items.forEach(i => csv += `"${c.name}","${i.name}","${i.variant}",${i.qty},${i.finalPrice},${i.qty*i.finalPrice}\n`));
                const link = document.createElement("a");
                link.href = encodeURI(csv);
                link.download = `orders.csv`;
                link.click();
            };

            return (
                <div className="min-h-screen pb-24">
                     {/* Batch Export Hidden Container */}
                    {isBatchExporting && (
                        <div id="batch-export-container">
                            {filteredCustomers.filter(c => selectedCustomerIds.has(c.name)).map(c => (
                                <div key={c.name} className="batch-customer-card bg-white p-6 border-b-2 border-dashed border-gray-300 mb-4" data-name={c.name}>
                                    <div className="mb-4 pb-4 border-b border-gray-200">
                                        <h2 className="text-2xl font-black text-slate-800">{c.name} ÁöÑË≥ºÁâ©Ê∏ÖÂñÆ</h2>
                                        <div className="flex justify-between mt-2 font-bold text-sm text-slate-600"><span>Ê∂àË≤ªÁ∏ΩÈ°ç: ${c.totalSpent.toLocaleString()}</span></div>
                                    </div>
                                    <div className="space-y-3">{c.items.map((item, idx) => (<div key={idx} className="flex justify-between items-center text-sm"><div><p className="font-bold text-slate-800">{item.name}</p><span className="text-xs text-slate-500">{item.variant} ¬∑ ${item.finalPrice}</span></div><div className="text-right font-bold text-slate-900">x{item.qty} = ${item.itemTotal}</div></div>))}</div>
                                    <div className="mt-6 pt-4 border-t text-center text-xs text-slate-400">ÊÑüË¨ùÊÇ®ÁöÑË≥ºË≤∑ÔºÅ</div>
                                </div>
                            ))}
                        </div>
                    )}
                     {/* Overlay */}
                    {isBatchExporting && <div className="fixed inset-0 bg-black/80 z-[999] flex flex-col items-center justify-center text-white"><Loader2 className="w-12 h-12 animate-spin mb-4 text-indigo-500" /><h3 className="text-xl font-bold">ÂåØÂá∫‰∏≠...</h3><p className="mt-2">{batchProgress}%</p></div>}
                    
                    {/* Sync Overlay */}
                    {isSyncing && <div className="fixed inset-0 bg-black/80 z-[999] flex flex-col items-center justify-center text-white"><Loader2 className="w-12 h-12 animate-spin mb-4 text-indigo-500" /><h3 className="text-xl font-bold">Ë≥áÊñôÂêåÊ≠•‰∏≠...</h3></div>}

                    {notification && <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[300] bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 animate-bounce"><CheckCircle2 size={18} className="text-green-400" />{notification}</div>}

                    {/* Header */}
                    <div className="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-50 flex justify-between items-center max-w-2xl mx-auto">
                        <h1 className="text-xl font-bold flex items-center gap-2" onClick={() => navigateTo('dashboard')}><Zap className="fill-yellow-400 text-yellow-400" /> Smart WMS <span className="text-[10px] bg-white/20 px-2 py-1 rounded">API</span></h1>
                    </div>

                    {/* Nav */}
                    <div className="bg-white border-b sticky top-[60px] z-40">
                         <div className="flex max-w-2xl mx-auto overflow-x-auto no-scrollbar">
                            {[{id:'products',l:'ÂïÜÂìÅÂàóË°®',i:ShoppingBag},{id:'dashboard',l:'ÁãÄÊÖã',i:LayoutDashboard},{id:'customers',l:'È°ßÂÆ¢ÂàóË°®',i:Users},{id:'arrivals',l:'Âà∞Ë≤®ÁÆ°ÁêÜ',i:BoxSelect}].map(t => (
                                <button key={t.id} onClick={() => {setActiveTab(t.id); setSearchQuery('')}} className={`flex-1 py-4 px-2 flex flex-col items-center gap-1 text-[10px] font-bold ${activeTab === t.id ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-400'}`}><t.i size={18}/>{t.l}</button>
                            ))}
                        </div>
                    </div>

                    {/* Content */}
                    <main className="max-w-2xl mx-auto p-4 space-y-4">
                        {activeTab !== 'dashboard' && <div className="relative"><input type="text" placeholder="ÊêúÂ∞ã..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full bg-white rounded-2xl p-4 pl-12 shadow-sm outline-none" /><Search size={18} className="absolute left-4 top-4 text-slate-300" /></div>}
                        
                        {/* Sidebar Backup Buttons (Moved to main view for mobile friendly) */}
                        <div className="flex gap-2 overflow-x-auto pb-2">
                             <button onClick={()=>setShowSettings(true)} className="bg-slate-200 text-slate-700 px-3 py-2 rounded-xl text-xs flex items-center gap-1 shrink-0"><Settings size={14}/> API Ë®≠ÂÆö</button>
                             <button onClick={handleCloudUpload} className="bg-indigo-600 text-white px-3 py-2 rounded-xl text-xs flex items-center gap-1 shrink-0"><UploadCloud size={14}/> ‰∏äÂÇ≥ÂÇô‰ªΩ</button>
                             <button onClick={handleCloudDownload} className="bg-emerald-600 text-white px-3 py-2 rounded-xl text-xs flex items-center gap-1 shrink-0"><DownloadCloud size={14}/> ‰∏ãËºâÂêåÊ≠•</button>
                        </div>

                        {/* Products */}
                        {activeTab === 'products' && filteredGroupedProducts.map(g => (
                            <div key={g.name} onClick={() => setSelectedGroupName(g.name)} className="bg-white rounded-3xl p-4 shadow-sm border border-slate-100 flex justify-between items-center cursor-pointer active:scale-98">
                                <div className="flex-1">
                                    <h4 className="font-black text-slate-800 text-lg">{g.name}</h4>
                                    <div className="flex gap-3 mt-1 text-xs text-slate-500">
                                        <span>Âñä {g.totalAllocated}</span><span>ÈÖç {g.totalConfirmed}</span><span>Áèæ {g.totalSpot}</span>
                                    </div>
                                </div>
                                <ChevronRight className="text-slate-300" />
                            </div>
                        ))}

                        {/* Dashboard */}
                        {activeTab === 'dashboard' && (
                            <div className="grid grid-cols-2 gap-4">
                                <div onClick={() => setShowPurchaseList(true)} className="bg-rose-500 text-white p-4 rounded-3xl shadow-lg relative overflow-hidden cursor-pointer">
                                    <p className="text-xs font-bold opacity-80">ÈúÄË£úË≤®</p>
                                    <p className="text-2xl font-black mt-1">{stats.totalShortageQty} ‰ª∂</p>
                                </div>
                                <div onClick={() => setShowRevenueList(true)} className="bg-amber-500 text-white p-4 rounded-3xl shadow-lg relative overflow-hidden cursor-pointer">
                                    <p className="text-xs font-bold opacity-80">Á∏ΩÁáüÊ•≠È°ç</p>
                                    <p className="text-2xl font-black mt-1">${stats.totalRevenue.toLocaleString()}</p>
                                </div>
                            </div>
                        )}

                        {/* Customers */}
                        {activeTab === 'customers' && (
                            <>
                                <div className="flex justify-between items-center mb-2 bg-white p-2 rounded-xl shadow-sm border border-slate-100">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" onChange={toggleSelectAll} checked={selectedCustomerIds.size === filteredCustomers.length && filteredCustomers.length > 0} className="w-5 h-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"/>
                                        <span className="text-xs font-bold text-slate-600">ÂÖ®ÈÅ∏ ({selectedCustomerIds.size})</span>
                                    </div>
                                    <div className="flex gap-2">
                                        {selectedCustomerIds.size > 0 && <button onClick={handleBatchExportImages} className="bg-indigo-500 text-white px-2 py-1.5 rounded-lg text-xs font-bold flex gap-1 shadow-sm"><ImageIcon size={14}/> ‰∏ãËºâÂúñÁâá</button>}
                                        <button onClick={handleExportToCSV} className="bg-emerald-500 text-white px-2 py-1.5 rounded-lg text-xs font-bold flex gap-1 shadow-sm"><FileSpreadsheet size={14}/> Â†±Ë°®</button>
                                    </div>
                                </div>
                                {filteredCustomers.map(c => (
                                    <div key={c.name} className="bg-white rounded-3xl p-4 shadow-sm border border-slate-100 flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <input type="checkbox" checked={selectedCustomerIds.has(c.name)} onChange={()=>toggleCustomerSelection(c.name)} className="w-5 h-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"/>
                                            <div onClick={() => setSelectedCustomerDetail(c)} className="flex-1 flex items-center gap-3 cursor-pointer">
                                                <div className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center font-bold">{c.name[0]}</div>
                                                <h4 className="font-bold text-slate-800">{c.name}</h4>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <p className="font-black text-indigo-600" onClick={() => setSelectedCustomerDetail(c)}>${c.totalSpent.toLocaleString()}</p>
                                            <button onClick={(e)=>handleDeleteCustomer(c.name,e)} className="text-slate-300 hover:text-rose-500"><Trash2 size={16}/></button>
                                        </div>
                                    </div>
                                ))}
                            </>
                        )}

                        {/* Arrivals */}
                        {activeTab === 'arrivals' && (
                            <div className="space-y-6 pb-24">
                                <div>
                                    <h3 className="text-lg font-black text-slate-800 mb-3 px-2 flex gap-2"><BoxSelect size={20} className="text-indigo-600"/> ÂæÖÂá∫Ë≤® / Âà∞Ë≤®‰∏≠</h3>
                                    {filteredPendingArrivals.map(c => (
                                        <div key={c.name} onClick={() => setSelectedArrivalCustomer({...c, source: 'pending'})} className="bg-white rounded-3xl shadow-sm border border-slate-100 p-4 mb-3 flex justify-between items-center cursor-pointer relative overflow-hidden">
                                            {c.isFullyArrived && <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-emerald-500"></div>}
                                            <div className="flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${c.isFullyArrived ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-500'}`}>{c.name[0]}</div>
                                                <div>
                                                    <h4 className="font-bold text-slate-800 flex gap-2 items-center">{c.name} {c.isFullyArrived && <span className="text-[10px] bg-emerald-100 text-emerald-600 px-2 rounded-full">ÂÖ®Âà∞</span>}</h4>
                                                    <p className="text-xs text-slate-500">ÂÖ± {c.totalQty} ‰ª∂ ¬∑ Â∑≤ÈÖç {c.allocatedQty}</p>
                                                </div>
                                            </div>
                                            {c.isFullyArrived && <button onClick={(e) => { e.stopPropagation(); handleShipCustomer(c.name); }} className="bg-emerald-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 shadow animate-pulse"><Truck size={14}/> Á¢∫Ë™çÂá∫Ë≤®</button>}
                                        </div>
                                    ))}
                                </div>
                                <div className="opacity-60">
                                    <h3 className="text-lg font-black text-slate-500 mb-3 px-2 flex gap-2"><PackageCheck size={20}/> Â∑≤Âá∫Ë≤®Á¥ÄÈåÑ</h3>
                                    {filteredShippedArrivals.map(c => (
                                        <div key={c.name} onClick={() => setSelectedArrivalCustomer({...c, source: 'shipped'})} className="bg-slate-50 rounded-3xl p-4 border border-slate-100 mb-3 flex justify-between items-center cursor-pointer">
                                            <span className="font-bold text-slate-600">{c.name}</span>
                                            <span className="text-xs bg-gray-200 px-2 py-1 rounded-full">Â∑≤Âá∫Ë≤®</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    <div className="fixed bottom-6 right-6 z-[100]"><button onClick={() => setShowProxyOrder(true)} className="w-16 h-16 bg-indigo-600 text-white rounded-full shadow-2xl flex items-center justify-center active:scale-95 transition-all"><Plus size={32}/></button></div>

                    {/* Modals - Simplified for display, full logic present in processing */}
                    {showProxyOrder && <div className="fixed inset-0 bg-black/50 z-[200] flex items-end md:items-center justify-center p-4"><div className="bg-white rounded-3xl w-full max-w-md p-5 space-y-4"><h3 className="font-bold border-b pb-2">‰ª£ÂÆ¢Âä†ÂñÆ/ÂÖ•Â∫´</h3><input placeholder="ÂïÜÂìÅÂêçÁ®±" className="w-full border p-2 rounded" list="pl" value={proxyForm.productName} onChange={handleProxyProductChange}/><datalist id="pl">{[...new Set(products.map(p=>p.name))].map(n=><option key={n} value={n}/>)}</datalist><div className="flex gap-2"><input placeholder="Ê¨æÂºè" className="w-full border p-2 rounded" list="vl" value={proxyForm.variant} onChange={e=>setProxyForm({...proxyForm,variant:e.target.value})}/><datalist id="vl">{availableVariants.map(v=><option key={v} value={v}/>)}</datalist><input type="number" placeholder="$" className="w-20 border p-2 rounded" value={proxyForm.price} onChange={e=>setProxyForm({...proxyForm,price:e.target.value})}/></div><div className="flex gap-2"><input placeholder="È°ßÂÆ¢(ÈÅ∏Â°´)" className="w-full border p-2 rounded" list="cl" value={proxyForm.customer} onChange={e=>setProxyForm({...proxyForm,customer:e.target.value})}/><datalist id="cl">{customerList.map(c=><option key={c.name} value={c.name}/>)}</datalist><input type="number" placeholder="Êï∏" className="w-20 border p-2 rounded" value={proxyForm.qty} onChange={e=>setProxyForm({...proxyForm,qty:e.target.value})}/></div><input type="number" placeholder="Ë≥ºË≤∑/ÁèæË≤®Êï∏Èáè" className="w-full border p-2 rounded bg-indigo-50" value={proxyForm.purchasedQty} onChange={e=>setProxyForm({...proxyForm,purchasedQty:e.target.value})}/><button onClick={handleAddOrder} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold">Á¢∫Ë™ç</button><button onClick={()=>setShowProxyOrder(false)} className="w-full mt-2 text-slate-400 text-sm">ÂèñÊ∂à</button></div></div>}

                    {showRevenueList && <div className="fixed inset-0 bg-black/50 z-[150] flex items-center justify-center p-4"><div className="bg-white rounded-3xl w-full max-w-md h-[80vh] flex flex-col"><div className="p-4 border-b flex justify-between"><h3>ÁáüÊî∂Á∏ΩË¶Ω</h3><button onClick={()=>setShowRevenueList(false)}><X/></button></div><div className="flex-1 overflow-y-auto p-4 space-y-2">{revenueCustomers.map(c=><div key={c.name} onClick={()=>{setShowRevenueList(false);setSelectedCustomerDetail(c)}} className="flex justify-between p-3 border rounded-xl items-center cursor-pointer"><span className="font-bold">{c.name}</span><span>${c.totalSpent.toLocaleString()}</span></div>)}</div></div></div>}
                    
                    {showPurchaseList && <div className="fixed inset-0 bg-black/50 z-[150] flex items-center justify-center p-4"><div className="bg-white rounded-3xl w-full max-w-md h-[80vh] flex flex-col"><div className="p-4 border-b flex justify-between"><h3>Êé°Ë≥ºÊ∏ÖÂñÆ</h3><button onClick={()=>setShowPurchaseList(false)}><X/></button></div><div className="flex-1 overflow-y-auto p-4 space-y-2">{purchaseList.map(p=><div key={p.id} className="flex justify-between p-3 border-b"><div><div className="font-bold">{p.name}</div><div className="text-xs text-slate-500">{p.variant}</div></div><div className="flex items-center gap-2"><span className="text-xs text-slate-400">Áº∫</span>{editingPurchaseQtyId===p.id?<input autoFocus className="w-12 border rounded text-center" type="number" defaultValue={p.shortage} onBlur={e=>handleUpdatePurchaseQty(p.id,e.target.value)}/>:<span onClick={()=>setEditingPurchaseQtyId(p.id)} className="text-rose-600 font-black text-lg cursor-pointer">{p.shortage}</span>}</div></div>)}</div></div></div>}

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 z-[200] flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl w-full max-w-md p-6 space-y-4">
                                <h3 className="font-bold border-b pb-2">API Ë®≠ÂÆö</h3>
                                <p className="text-sm text-slate-500">Ë´ãËº∏ÂÖ• Google Apps Script Á∂≤È†ÅÊáâÁî®Á®ãÂºèÁ∂≤ÂùÄ</p>
                                <input type="text" placeholder="https://script.google.com/..." className="w-full border p-3 rounded-xl" value={apiUrl} onChange={e=>setApiUrl(e.target.value)}/>
                                <div className="flex gap-2">
                                    <button onClick={()=>setShowSettings(false)} className="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-bold">ÂÑ≤Â≠ò</button>
                                    <button onClick={()=>setShowSettings(false)} className="flex-1 bg-slate-100 text-slate-500 py-3 rounded-lg font-bold">ÂèñÊ∂à</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {selectedGroupName && <div className="fixed inset-0 bg-black/50 z-[150] flex items-end md:items-center justify-center p-0 md:p-4"><div className="bg-white rounded-t-[30px] md:rounded-3xl w-full max-w-md h-[85vh] flex flex-col"><div className="p-6 border-b flex justify-between"><h3>{selectedGroupName}</h3><button onClick={()=>setSelectedGroupName(null)}><X/></button></div><div className="flex-1 overflow-y-auto p-4 space-y-4">
                        <div className="bg-slate-50 p-3 rounded-xl"><table className="w-full text-xs text-center"><thead><tr className="text-slate-400"><th>Ê¨æÂºè</th><th>Â∑≤ÈÖç</th><th>ÂæÖÈÖç</th><th>ÁèæË≤®</th>{isEditingProduct&&<th></th>}</tr></thead><tbody>{productsWithStats.filter(p=>p.name===selectedGroupName).map(p=><tr key={p.id}><td className="py-2 text-left">{p.variant}</td><td className="text-indigo-600">{p.confirmed}</td><td className="text-rose-500">{p.pending}</td><td>{isEditingProduct?<input className="w-10 text-center border rounded" defaultValue={p.spot} onBlur={e=>handleUpdateProductInfo(p.id,'spot',e.target.value)}/>:p.spot}</td>{isEditingProduct&&<td><button onClick={()=>handleDeleteProduct(p.id)} className="text-rose-500"><Trash2 size={14}/></button></td>}</tr>)}</tbody></table></div>
                        <div><h4 className="text-xs font-bold text-slate-400 mb-2">ÈÖçË≤®ÊòéÁ¥∞</h4>{getGroupAllocations(selectedGroupName).map((r,i)=><div key={i} className="flex justify-between items-center p-3 border rounded-xl mb-2"><div className="flex items-center gap-3"><button onClick={()=>toggleAllocation(r.orderId,r.productId,r.allocatedQty,r.qty)} className={`w-6 h-6 rounded border flex items-center justify-center ${r.isAllocated?'bg-indigo-600 text-white':''}`}><CheckSquare size={14}/></button><div><div className="font-bold text-sm">{r.customer}</div><div className="text-[10px] text-slate-500">{r.variant}</div></div></div><div className="text-sm">ÈÖç {r.allocatedQty} / Ë®Ç {r.qty}</div></div>)}</div>
                    </div><div className="p-4 border-t flex justify-between"><button onClick={()=>{setProxyForm(prev=>({...prev,productName:selectedGroupName}));setShowProxyOrder(true)}} className="text-sm bg-slate-100 px-3 py-2 rounded-lg flex gap-1"><Plus size={16}/> Âä†ÂñÆ</button><button onClick={()=>setIsEditingProduct(!isEditingProduct)} className="text-sm bg-slate-100 px-3 py-2 rounded-lg flex gap-1"><Edit size={16}/> Á∑®ËºØ</button></div></div></div>}

                    {/* Customer Detail (Removed Payment/Debt UI) */}
                    {selectedCustomerDetail && currentSelectedCustomer && (
                        <div className="fixed inset-0 bg-black/50 z-[160] flex items-end md:items-center justify-center p-0 md:p-4">
                            <div className="bg-white rounded-t-[30px] md:rounded-3xl w-full max-w-md h-[85vh] flex flex-col">
                                <div className="p-6 border-b flex justify-between items-start">
                                    <div><h3 className="text-xl font-bold">{currentSelectedCustomer.name}</h3><div className="text-xs text-indigo-600 font-bold mt-1">Á∏ΩÈ°ç: ${currentSelectedCustomer.totalSpent.toLocaleString()}</div></div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>handleExportToImage(currentSelectedCustomer.name)} className="p-2 bg-slate-100 rounded-full" title="ÂåØÂá∫ÂúñÁâá"><ImageIcon size={18}/></button>
                                        <button onClick={()=>{setProxyForm(prev=>({...prev,customer:currentSelectedCustomer.name}));setShowProxyOrder(true)}} className="p-2 bg-slate-100 rounded-full"><Plus size={18}/></button>
                                        <button onClick={()=>handleCopyCustomerDetails(currentSelectedCustomer)} className="p-2 bg-slate-100 rounded-full"><Copy size={18}/></button>
                                        <button onClick={()=>setSelectedCustomerDetail(null)} className="p-2 bg-slate-100 rounded-full"><X size={18}/></button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2" id="customer-detail-export-area">
                                    <div className="hidden export-visible mb-4 border-b pb-4"><h2 className="text-2xl font-black">{currentSelectedCustomer.name} ÁöÑË≥ºÁâ©Ê∏ÖÂñÆ</h2><div className="flex justify-between mt-2 font-bold text-sm text-slate-600"><span>Á∏ΩÈ°ç: ${currentSelectedCustomer.totalSpent.toLocaleString()}</span></div></div>
                                    {currentSelectedCustomer.items.map((item,idx)=>(
                                        <div key={idx} className="flex justify-between items-center p-3 border-b">
                                            <div><div className="font-bold text-sm">{item.name}</div><div className="text-xs text-slate-500">{item.variant} ¬∑ ${item.finalPrice}</div></div>
                                            <div className="text-right flex items-center gap-1 justify-end">
                                                <span className="text-xs text-slate-400">x</span>
                                                {editingOrderQtyId===`${item.orderId}-${item.productId}` ? 
                                                    <input autoFocus className="w-8 text-center border rounded" defaultValue={item.qty} onBlur={e=>handleUpdateOrderQty(item.orderId,item.productId,e.target.value)}/> :
                                                    <span onClick={()=>setEditingOrderQtyId(`${item.orderId}-${item.productId}`)} className="font-bold cursor-pointer">{item.qty}</span>
                                                }
                                                <div className="text-xs text-indigo-600 font-bold ml-2">${item.itemTotal}</div>
                                                <button onClick={()=>handleDeleteOrderItem(item.orderId,item.productId)} className="ml-1 text-slate-300 hover:text-rose-500"><Trash2 size={12}/></button>
                                            </div>
                                        </div>
                                    ))}
                                    <div className="hidden export-visible mt-6 pt-4 border-t text-center text-xs text-slate-400">ÊÑüË¨ùÊÇ®ÁöÑË≥ºË≤∑ÔºÅ</div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {currentSelectedArrivalCustomer && (
                        <div className="fixed inset-0 bg-black/50 z-[150] flex items-end md:items-center justify-center p-0 md:p-4">
                            <div className="bg-white rounded-t-[30px] md:rounded-3xl w-full max-w-md h-[85vh] flex flex-col">
                                <div className="p-6 bg-slate-800 text-white rounded-t-[30px] flex justify-between items-start shrink-0">
                                    <div><h3 className="text-xl font-bold">{currentSelectedArrivalCustomer.name}</h3><p className="text-xs opacity-70 mt-1">{isArrivalShipped ? 'Â∑≤Âá∫Ë≤®' : 'ÈÖçË≤®Ê™¢Ê†∏'}</p></div>
                                    <button onClick={()=>setSelectedArrivalCustomer(null)} className="bg-white/20 p-2 rounded-full"><X size={18}/></button>
                                </div>
                                <div className="px-6 py-3 bg-slate-800 text-white flex justify-between items-center shrink-0">
                                    <div className="text-xs opacity-80">ÈÄ≤Â∫¶: {currentSelectedArrivalCustomer.arrivedItemsCount} / {currentSelectedArrivalCustomer.totalItemsCount} È†Ö</div>
                                    {!isArrivalShipped && currentSelectedArrivalCustomer.isFullyArrived && <button onClick={()=>handleShipCustomer(currentSelectedArrivalCustomer.name)} className="bg-emerald-500 px-3 py-1 rounded-lg text-xs font-bold flex gap-1 shadow animate-pulse"><Truck size={14}/> Á¢∫Ë™çÂá∫Ë≤®</button>}
                                    {isArrivalShipped && <button onClick={()=>handleUnshipCustomer(currentSelectedArrivalCustomer.name)} className="bg-amber-500 px-3 py-1 rounded-lg text-xs font-bold flex gap-1 shadow"><Undo2 size={14}/> ÂõûÂæ©Êú™Âá∫Ë≤®</button>}
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                    {currentSelectedArrivalCustomer.items.map((item,idx)=>{
                                        const isDone = (item.allocatedQty||0) >= item.qty;
                                        return (
                                            <div key={idx} className={`flex justify-between items-center p-3 border rounded-xl ${isDone?'bg-emerald-50 border-emerald-200':'bg-white'} ${isArrivalShipped?'opacity-70':''}`}>
                                                <div className="flex items-center gap-3 flex-1">
                                                    {!isArrivalShipped ? (
                                                        <button onClick={()=>toggleAllocation(item.orderId,item.productId,item.allocatedQty||0,item.qty)} className={`w-6 h-6 rounded border flex items-center justify-center ${isDone?'bg-emerald-500 border-emerald-500 text-white':''}`}><CheckSquare size={14}/></button>
                                                    ) : <div className="w-6 h-6 flex items-center justify-center bg-gray-200 rounded text-gray-500"><PackageCheck size={14}/></div>}
                                                    <div><div className="font-bold text-sm text-slate-700">{item.name}</div><div className="text-[10px] text-slate-500">{item.variant}</div></div>
                                                </div>
                                                <div className="flex items-center gap-1 text-sm">
                                                    <span className="text-xs text-slate-400">ÈÖç</span>
                                                    {!isArrivalShipped && editingAllocatedQtyId===`${item.orderId}-${item.productId}` ?
                                                        <input autoFocus className="w-8 text-center border-b border-indigo-500 outline-none bg-transparent" defaultValue={item.allocatedQty||0} onBlur={e=>handleUpdateAllocatedQty(item.orderId,item.productId,e.target.value)}/> :
                                                        <span onClick={()=>!isArrivalShipped && setEditingAllocatedQtyId(`${item.orderId}-${item.productId}`)} className={`font-bold ${isDone?'text-emerald-600':'text-indigo-600'} ${!isArrivalShipped && 'cursor-pointer'}`}>{item.allocatedQty||0}</span>
                                                    }
                                                    <span className="text-xs text-slate-400">/ Ë®Ç {item.qty}</span>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
