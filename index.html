<!DOCTYPE html>
<html lang="zh-TW" class="light">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>MyMoney - 個人理財管家</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#6324eb",
                        "primary-hover": "#501ac2",
                        "background-light": "#f6f6f8",
                        "background-dark": "#161121",
                        "card-light": "#ffffff",
                        "card-dark": "#1c162d",
                        "text-main": "#120e1b",
                        "text-sub": "#654d99",
                        "success": "#10b981",
                        "danger": "#f43f5e",
                        "warning": "#f59e0b",
                    },
                    fontFamily: {
                        "display": ["Inter", "Noto Sans TC", "sans-serif"]
                    }
                },
            },
        }
    </script>

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; -webkit-font-smoothing: antialiased; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .sidebar-fixed { width: 260px; transition: transform 0.3s ease; }
        .main-content { transition: margin-left 0.3s ease; }
        
        /* Mobile handling */
        @media (max-width: 768px) {
            .sidebar-fixed { transform: translateX(-100%); z-index: 50; }
            .sidebar-fixed.open { transform: translateX(0); }
            .main-content { margin-left: 0 !important; }
            .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; }
            .overlay.active { display: block; }
        }
        @media (min-width: 769px) {
            .main-content { margin-left: 260px; }
        }

        /* Calculator Styles */
        .calc-btn { user-select: none; }
        .calc-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-100 h-screen flex overflow-hidden font-display selection:bg-primary selection:text-white">

    <!-- Data Logic Script (Core) -->
    <script>
        // --- State Management ---
        const DB_KEY = 'mymoney_db_v1';
        
        // Global view states
        let currentDashboardDate = new Date();
        let transactionFilter = { type: 'all', start: null, end: null }; // For filtering transaction list

        const defaultData = {
            settings: {
                cycleStartDay: 1, // 每月1號結帳
                currency: 'TWD',
                darkMode: false
            },
            accounts: [
                { id: 'acc_1', name: '現金錢包', type: 'cash', balance: 5000, color: 'bg-green-100 text-green-600' },
                { id: 'acc_2', name: '中國信託', type: 'bank', balance: 150000, color: 'bg-blue-100 text-blue-600' },
                { id: 'acc_3', name: '台新信用卡', type: 'credit', balance: -12500, color: 'bg-rose-100 text-rose-600' }
            ],
            categories: {
                expense: ['餐飲食品', '交通運輸', '休閒娛樂', '居家生活', '購物採買', '醫療保健', '其他支出'],
                income: ['薪資收入', '獎金', '投資理財', '兼職收入', '其他收入']
            },
            budgets: [
                { id: 'bdg_1', category: '餐飲食品', limit: 15000 },
                { id: 'bdg_2', category: '交通運輸', limit: 5000 },
                { id: 'bdg_3', category: '休閒娛樂', limit: 8000 }
            ],
            transactions: [
                // Init with some dummy data if empty
            ]
        };

        // Initialize Data
        let appData = JSON.parse(localStorage.getItem(DB_KEY)) || (() => {
            // Seed initial transactions if new
            const now = new Date();
            const seed = JSON.parse(JSON.stringify(defaultData));
            seed.transactions.push(
                { id: 'tx_init_1', date: new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0], type: 'income', amount: 50000, category: '薪資收入', accountId: 'acc_2', note: '本月薪資' },
                { id: 'tx_init_2', date: new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0], type: 'expense', amount: 120, category: '餐飲食品', accountId: 'acc_1', note: '午餐' },
                { id: 'tx_init_3', date: new Date(now.getFullYear(), now.getMonth(), now.getDate()-1).toISOString().split('T')[0], type: 'expense', amount: 1200, category: '休閒娛樂', accountId: 'acc_3', note: '健身房月費' }
            );
            return seed;
        })();

        // --- Core Functions ---
        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(appData));
            updateUI(); // Trigger reactivity
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(amount);
        }

        // Logic: Calculate Cycle Range based on settings
        function getCycleRange(referenceDate) {
            const startDay = parseInt(appData.settings.cycleStartDay);
            const year = referenceDate.getFullYear();
            const month = referenceDate.getMonth(); // 0-11
            const day = referenceDate.getDate();

            let startDate, endDate;

            if (day >= startDay) {
                // Current month cycle
                startDate = new Date(year, month, startDay);
                endDate = new Date(year, month + 1, startDay - 1); // rough approximation logic
                // Better end date logic:
                let nextMonth = new Date(year, month + 1, startDay);
                nextMonth.setDate(nextMonth.getDate() - 1);
                endDate = nextMonth;
            } else {
                // Previous month cycle logic (e.g. today is 2nd, start day is 5th. Cycle is Prev Month 5th to This Month 4th)
                startDate = new Date(year, month - 1, startDay);
                let currentMonthEnd = new Date(year, month, startDay);
                currentMonthEnd.setDate(currentMonthEnd.getDate() - 1);
                endDate = currentMonthEnd;
            }
            
            // Set times to boundary
            startDate.setHours(0,0,0,0);
            endDate.setHours(23,59,59,999);

            return { start: startDate, end: endDate };
        }

        function formatDate(dateObj) {
            return `${dateObj.getFullYear()}/${(dateObj.getMonth()+1).toString().padStart(2, '0')}/${dateObj.getDate().toString().padStart(2, '0')}`;
        }

        // Logic: Calculate Account Balances Dynamically
        function getAccountBalance(accountId) {
            const acc = appData.accounts.find(a => a.id === accountId);
            if (!acc) return 0;
            return acc.balance;
        }

        // Logic: Get Dashboard Stats (Specific Range)
        function getStatsForRange(range) {
            let income = 0;
            let expense = 0;

            appData.transactions.forEach(tx => {
                const txDate = new Date(tx.date);
                // Adjust txDate to match comparison (ignore time)
                txDate.setHours(12,0,0,0);
                
                if (txDate >= range.start && txDate <= range.end) {
                    if (tx.type === 'income') income += parseFloat(tx.amount);
                    if (tx.type === 'expense') expense += parseFloat(tx.amount);
                }
            });

            return { income, expense, balance: income - expense };
        }

        // Logic: Budget Progress
        function getBudgetProgress(category, range) {
            const spent = appData.transactions
                .filter(tx => {
                    const txDate = new Date(tx.date);
                    txDate.setHours(12,0,0,0);
                    return tx.category === category && tx.type === 'expense' && txDate >= range.start && txDate <= range.end;
                })
                .reduce((sum, tx) => sum + parseFloat(tx.amount), 0);
            
            return spent;
        }

        // Logic: Add Transaction
        function addTransaction(tx) {
            tx.id = tx.id || generateId();
            appData.transactions.unshift(tx);

            // Update Account Balances
            const amount = parseFloat(tx.amount);
            if (tx.type === 'expense') {
                const acc = appData.accounts.find(a => a.id === tx.accountId);
                if (acc) acc.balance -= amount;
            } else if (tx.type === 'income') {
                const acc = appData.accounts.find(a => a.id === tx.accountId);
                if (acc) acc.balance += amount;
            } else if (tx.type === 'transfer') {
                const fromAcc = appData.accounts.find(a => a.id === tx.accountId);
                const toAcc = appData.accounts.find(a => a.id === tx.toAccountId);
                if (fromAcc) fromAcc.balance -= amount;
                if (toAcc) toAcc.balance += amount;
            }

            saveData();
        }

        // Logic: Delete Transaction
        function deleteTransaction(id) {
            const txIndex = appData.transactions.findIndex(t => t.id === id);
            if (txIndex === -1) return;

            const tx = appData.transactions[txIndex];
            const amount = parseFloat(tx.amount);

            // Revert Balance
            if (tx.type === 'expense') {
                const acc = appData.accounts.find(a => a.id === tx.accountId);
                if (acc) acc.balance += amount;
            } else if (tx.type === 'income') {
                const acc = appData.accounts.find(a => a.id === tx.accountId);
                if (acc) acc.balance -= amount;
            } else if (tx.type === 'transfer') {
                const fromAcc = appData.accounts.find(a => a.id === tx.accountId);
                const toAcc = appData.accounts.find(a => a.id === tx.toAccountId);
                if (fromAcc) fromAcc.balance += amount;
                if (toAcc) toAcc.balance -= amount;
            }

            appData.transactions.splice(txIndex, 1);
            saveData();
        }

        function changeCycleStartDay() {
            const current = appData.settings.cycleStartDay;
            const newVal = prompt("請輸入每月的結帳起始日 (1-31):", current);
            if (newVal !== null) {
                const day = parseInt(newVal);
                if (day >= 1 && day <= 31) {
                    appData.settings.cycleStartDay = day;
                    saveData();
                    alert(`設定已更新：每月 ${day} 號為週期起始日`);
                } else {
                    alert("請輸入有效的日期 (1-31)");
                }
            }
        }

    </script>

    <!-- Sidebar Overlay for Mobile -->
    <div id="mobile-overlay" class="overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar-fixed fixed inset-y-0 left-0 bg-white dark:bg-card-dark border-r border-gray-200 dark:border-gray-800 flex flex-col z-50">
        <div class="p-6 flex items-center gap-3">
            <div class="size-10 bg-primary rounded-xl flex items-center justify-center text-white shadow-lg shadow-primary/30">
                <span class="material-symbols-outlined">account_balance_wallet</span>
            </div>
            <div>
                <h1 class="font-bold text-lg text-text-main dark:text-white leading-none">MyMoney</h1>
                <p class="text-xs text-text-sub mt-1">智慧理財管家</p>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-1 overflow-y-auto">
            <a href="#" onclick="switchView('dashboard')" class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl bg-primary/10 text-primary transition-colors">
                <span class="material-symbols-outlined">dashboard</span>
                儀表板
            </a>
            <a href="#" onclick="switchView('transactions', true)" class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-white/5 transition-colors">
                <span class="material-symbols-outlined">receipt_long</span>
                交易紀錄
            </a>
            <a href="#" onclick="switchView('budgets')" class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-white/5 transition-colors">
                <span class="material-symbols-outlined">pie_chart</span>
                預算規劃
            </a>
            <a href="#" onclick="switchView('accounts')" class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-white/5 transition-colors">
                <span class="material-symbols-outlined">account_balance</span>
                帳戶管理
            </a>
        </nav>

        <div class="p-4 border-t border-gray-100 dark:border-gray-800">
            <div class="flex items-center gap-3 p-2 rounded-lg bg-gray-50 dark:bg-white/5">
                <div class="size-8 rounded-full bg-gradient-to-tr from-primary to-purple-400"></div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold text-text-main dark:text-white truncate">使用者</p>
                    <p class="text-xs text-text-sub truncate">Pro Plan</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content flex-1 flex flex-col h-full relative overflow-hidden bg-background-light dark:bg-background-dark">
        <!-- Header -->
        <header class="h-16 flex items-center justify-between px-6 bg-white/80 dark:bg-card-dark/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 sticky top-0 z-30">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="md:hidden p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <h2 id="page-title" class="text-xl font-bold text-text-main dark:text-white">儀表板</h2>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openModal()" class="flex items-center gap-2 bg-primary hover:bg-primary-hover text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg shadow-primary/20 transition-all active:scale-95">
                    <span class="material-symbols-outlined text-[20px]">add</span>
                    <span class="hidden sm:inline">快速記帳</span>
                </button>
            </div>
        </header>

        <!-- Dynamic Content Container -->
        <div id="content-area" class="flex-1 overflow-y-auto p-6 scroll-smooth">
            <!-- Content Injected via JS -->
        </div>
    </main>

    <!-- Add Transaction Modal -->
    <div id="transaction-modal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
            <div class="bg-white dark:bg-card-dark w-full max-w-4xl h-[90vh] md:h-auto rounded-2xl shadow-2xl flex flex-col md:flex-row overflow-hidden pointer-events-auto transform transition-all scale-100">
                
                <!-- Left Form -->
                <div class="flex-1 p-6 flex flex-col overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-text-main dark:text-white">新增交易</h3>
                        <button onclick="closeModal()" class="md:hidden text-gray-500"><span class="material-symbols-outlined">close</span></button>
                    </div>

                    <!-- Type Switcher -->
                    <div class="flex bg-gray-100 dark:bg-white/5 p-1 rounded-xl mb-6">
                        <button onclick="setTxType('expense')" id="btn-type-expense" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all bg-white dark:bg-gray-700 text-danger shadow-sm">支出</button>
                        <button onclick="setTxType('income')" id="btn-type-income" class="flex-1 py-2 rounded-lg text-sm font-bold text-gray-500 transition-all">收入</button>
                        <button onclick="setTxType('transfer')" id="btn-type-transfer" class="flex-1 py-2 rounded-lg text-sm font-bold text-gray-500 transition-all">轉帳</button>
                    </div>

                    <!-- Amount Display (Linked to Calculator) -->
                    <div class="mb-6">
                        <label class="text-xs font-bold text-gray-500 uppercase">金額</label>
                        <div class="relative mt-1">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-2xl font-bold text-gray-400">$</span>
                            <input id="input-amount" type="text" readonly class="w-full pl-10 pr-4 py-3 bg-gray-50 dark:bg-black/20 border border-gray-200 dark:border-gray-700 rounded-xl text-3xl font-bold text-text-main dark:text-white outline-none focus:border-primary text-right font-mono" value="0">
                        </div>
                    </div>

                    <!-- Form Fields -->
                    <div class="space-y-4 flex-1">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">日期</label>
                                <input id="input-date" type="date" class="w-full p-2 bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-gray-700 rounded-lg dark:text-white outline-none focus:ring-2 focus:ring-primary/50">
                            </div>
                            <!-- Category (Hidden for Transfer) -->
                            <div id="field-category">
                                <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">分類</label>
                                <select id="input-category" class="w-full p-2 bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-gray-700 rounded-lg dark:text-white outline-none">
                                    <!-- Options filled by JS -->
                                </select>
                            </div>
                        </div>

                        <!-- Account Selection -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label id="label-acc-from" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">支付帳戶</label>
                                <select id="input-account" class="w-full p-2 bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-gray-700 rounded-lg dark:text-white outline-none">
                                    <!-- Accounts filled by JS -->
                                </select>
                            </div>
                            <div id="field-acc-to" class="hidden">
                                <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">轉入帳戶</label>
                                <select id="input-account-to" class="w-full p-2 bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-gray-700 rounded-lg dark:text-white outline-none">
                                    <!-- Accounts filled by JS -->
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">備註</label>
                            <input id="input-note" type="text" class="w-full p-2 bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-gray-700 rounded-lg dark:text-white outline-none placeholder-gray-400" placeholder="輸入備註...">
                        </div>

                        <div class="flex items-center gap-2 pt-2">
                            <input type="checkbox" id="input-recurring" class="w-4 h-4 text-primary rounded focus:ring-primary border-gray-300">
                            <label for="input-recurring" class="text-sm text-gray-600 dark:text-gray-400">設為定期交易 (每月)</label>
                        </div>
                    </div>

                    <div class="mt-6 flex gap-3">
                        <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 dark:bg-white/5 text-gray-600 dark:text-gray-300 font-bold rounded-xl hover:bg-gray-200 transition-colors">取消</button>
                        <button onclick="submitTransaction()" class="flex-1 py-3 bg-primary text-white font-bold rounded-xl shadow-lg shadow-primary/25 hover:bg-primary-hover transition-colors">確認儲存</button>
                    </div>
                </div>

                <!-- Calculator Sidebar -->
                <div class="w-full md:w-80 bg-gray-50 dark:bg-[#131313] border-l border-gray-200 dark:border-gray-800 p-6 flex flex-col">
                    <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">計算機</div>
                    <div class="grid grid-cols-4 gap-2 flex-1 h-full">
                        <button onclick="calcInput('7')" class="calc-btn bg-white dark:bg-gray-800 rounded-lg shadow-sm text-xl font-bold dark:text-white hover:bg-gray-100">7</button>
                        <button onclick="calcInput('8')" class="calc-btn bg-white dark:bg-gray-800 rounded-lg shadow-sm text-xl font-bold dark:text-white hover:bg-gray-100">8</button>
                        <button onclick="calcInput('9')" class="calc-btn bg-white dark:bg-gray-800 rounded-lg shadow-sm text-xl font-bold dark:text-white hover:bg-gray-100">9</button>
                        <button onclick="calcInput('/')" class="calc-btn bg-primary/10 text-primary rounded-lg font-bold text-xl hover:bg-primary/20">÷</button>
                        
                        <button onclick="calcInput('4')" class="calc-btn bg-white dark:bg-gray-800 rounded-lg shadow-sm text-xl font-bold dark:text-white hover:bg-gray-100">4</button>
                        <button onclick="calcInput('5')" class="calc-btn bg-white dark:bg-gray-800 rounded-lg shadow-sm text-xl font-bold dark:text-white hover:bg-gray-100">5</button>
                        <button onclick="calcInput('6')" class="calc-btn bg-white dark:bg-gray-800 rounded-lg shadow-sm text-xl font-bold dark:text-white hover:bg-gray-100">6</button>
                        <button onclick="calcInput('*')" class="calc-btn bg-primary/10 text-primary rounded-lg font-bold text-xl hover:bg-primary/20">×</button>
                        
                        <button onclick="calcInput('1')" class="calc-btn bg-white dark:bg-gray-800 rounded-lg shadow-sm text-xl font-bold dark:text-white hover:bg-gray-100">1</button>
                        <button onclick="calcInput('2')" class="calc-btn bg-white dark:bg-gray-800 rounded-lg shadow-sm text-xl font-bold dark:text-white hover:bg-gray-100">2</button>
                        <button onclick="calcInput('3')" class="calc-btn bg-white dark:bg-gray-800 rounded-lg shadow-sm text-xl font-bold dark:text-white hover:bg-gray-100">3</button>
                        <button onclick="calcInput('-')" class="calc-btn bg-primary/10 text-primary rounded-lg font-bold text-xl hover:bg-primary/20">-</button>
                        
                        <button onclick="calcInput('0')" class="calc-btn col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm text-xl font-bold dark:text-white hover:bg-gray-100">0</button>
                        <button onclick="calcInput('.')" class="calc-btn bg-white dark:bg-gray-800 rounded-lg shadow-sm text-xl font-bold dark:text-white hover:bg-gray-100">.</button>
                        <button onclick="calcInput('+')" class="calc-btn bg-primary/10 text-primary rounded-lg font-bold text-xl hover:bg-primary/20">+</button>
                        
                        <button onclick="calcClear()" class="calc-btn col-span-2 py-3 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold rounded-lg hover:bg-gray-300">C</button>
                        <button onclick="calcBackspace()" class="calc-btn col-span-2 py-3 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold rounded-lg hover:bg-gray-300 flex items-center justify-center">
                            <span class="material-symbols-outlined">backspace</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- UI Logic Script -->
    <script>
        // --- Navigation ---
        let currentView = 'dashboard';

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('mobile-overlay').classList.toggle('active');
        }

        function switchView(viewName, resetFilter = true) {
            currentView = viewName;
            
            if (resetFilter) {
                // Reset filter when navigating via sidebar
                transactionFilter = { type: 'all', start: null, end: null };
            }

            // Update Sidebar Active State
            document.querySelectorAll('.nav-item').forEach(el => {
                if(el.getAttribute('onclick').includes(`'${viewName}'`)) {
                    el.className = 'nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl bg-primary/10 text-primary transition-colors';
                } else {
                    el.className = 'nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-white/5 transition-colors';
                }
            });

            // Update Header Title
            const titles = {
                'dashboard': '儀表板',
                'transactions': '交易紀錄',
                'budgets': '預算規劃',
                'accounts': '帳戶管理'
            };
            document.getElementById('page-title').innerText = titles[viewName];

            // Close sidebar on mobile
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('mobile-overlay').classList.remove('active');

            updateUI();
        }

        // --- View Filtering Logic (Dashboard specific) ---
        function shiftDashboardCycle(offset) {
            // Shift currentDashboardDate by months
            const newDate = new Date(currentDashboardDate);
            newDate.setMonth(newDate.getMonth() + offset);
            currentDashboardDate = newDate;
            updateUI();
        }

        function viewFilteredTransactions(type) {
            // Triggered from Dashboard Cards
            const cycle = getCycleRange(currentDashboardDate);
            transactionFilter = {
                type: type,
                start: cycle.start,
                end: cycle.end,
                displayRange: `${formatDate(cycle.start)} - ${formatDate(cycle.end)}`
            };
            switchView('transactions', false);
        }


        // --- Render Functions ---
        function updateUI() {
            const container = document.getElementById('content-area');
            container.innerHTML = '';

            if (currentView === 'dashboard') renderDashboard(container);
            else if (currentView === 'transactions') renderTransactions(container);
            else if (currentView === 'budgets') renderBudgets(container);
            else if (currentView === 'accounts') renderAccounts(container);
        }

        function renderDashboard(container) {
            const cycle = getCycleRange(currentDashboardDate);
            const stats = getStatsForRange(cycle);
            
            // Cycle UI Label
            const cycleLabel = `${formatDate(cycle.start)} - ${formatDate(cycle.end)}`;

            const html = `
                <!-- Cycle Selector Header -->
                <div class="flex flex-col sm:flex-row items-center justify-between mb-8 gap-4">
                    <div class="flex items-center gap-4 bg-white dark:bg-card-dark p-2 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                        <button onclick="shiftDashboardCycle(-1)" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg text-gray-500">
                            <span class="material-symbols-outlined">chevron_left</span>
                        </button>
                        <div class="text-center min-w-[200px]">
                            <p class="text-xs text-gray-400 font-bold uppercase tracking-wider">目前檢視週期</p>
                            <p class="text-sm font-bold text-text-main dark:text-white">${cycleLabel}</p>
                        </div>
                        <button onclick="shiftDashboardCycle(1)" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg text-gray-500">
                            <span class="material-symbols-outlined">chevron_right</span>
                        </button>
                    </div>
                    
                    <button onclick="changeCycleStartDay()" class="flex items-center gap-2 text-sm text-gray-500 hover:text-primary transition-colors px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5">
                        <span class="material-symbols-outlined text-[18px]">settings</span>
                        設定週期起始日 (${appData.settings.cycleStartDay}號)
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Income (Clickable) -->
                    <div onclick="viewFilteredTransactions('income')" class="cursor-pointer bg-white dark:bg-card-dark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 relative overflow-hidden group hover:border-success/30 transition-colors">
                        <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                            <span class="material-symbols-outlined text-[80px] text-success">trending_up</span>
                        </div>
                        <div class="flex items-center gap-2 mb-1">
                            <p class="text-sm font-medium text-gray-500">本週期收入</p>
                            <span class="material-symbols-outlined text-[16px] text-gray-300">open_in_new</span>
                        </div>
                        <h3 class="text-3xl font-extrabold text-text-main dark:text-white">${formatMoney(stats.income)}</h3>
                    </div>
                    <!-- Expense (Clickable) -->
                    <div onclick="viewFilteredTransactions('expense')" class="cursor-pointer bg-white dark:bg-card-dark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 relative overflow-hidden group hover:border-danger/30 transition-colors">
                        <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                            <span class="material-symbols-outlined text-[80px] text-danger">trending_down</span>
                        </div>
                         <div class="flex items-center gap-2 mb-1">
                            <p class="text-sm font-medium text-gray-500">本週期支出</p>
                            <span class="material-symbols-outlined text-[16px] text-gray-300">open_in_new</span>
                        </div>
                        <h3 class="text-3xl font-extrabold text-text-main dark:text-white">${formatMoney(stats.expense)}</h3>
                    </div>
                    <!-- Balance -->
                    <div class="bg-white dark:bg-card-dark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:scale-110 transition-transform">
                            <span class="material-symbols-outlined text-[80px] text-primary">account_balance_wallet</span>
                        </div>
                        <p class="text-sm font-medium text-gray-500 mb-1">週期結餘</p>
                        <h3 class="text-3xl font-extrabold ${stats.balance >= 0 ? 'text-primary' : 'text-danger'}">${formatMoney(stats.balance)}</h3>
                    </div>
                </div>

                <!-- Expanded Budget Section (No Recent Transactions) -->
                <div class="bg-white dark:bg-card-dark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg text-text-main dark:text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">pie_chart</span>
                            預算執行狀況
                        </h3>
                        <button onclick="switchView('budgets')" class="text-primary text-sm font-bold hover:underline">管理預算</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
                        ${renderBudgetBars(cycle)}
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function renderBudgetBars(range) {
            if (appData.budgets.length === 0) return '<p class="col-span-full text-gray-400 text-sm text-center py-4">尚未設定預算</p>';
            
            // If range is not provided (e.g. from Budget View), calculate for current cycle
            if (!range) range = getCycleRange(new Date());

            return appData.budgets.map(b => {
                const spent = getBudgetProgress(b.category, range);
                const percent = Math.min(100, Math.round((spent / b.limit) * 100));
                const isOver = spent > b.limit;
                const colorClass = isOver || percent > 90 ? 'bg-danger' : 'bg-primary';
                const textClass = isOver || percent > 90 ? 'text-danger' : 'text-primary';
                
                return `
                <div class="flex flex-col gap-2">
                    <div class="flex justify-between items-end">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-700 dark:text-gray-200">${b.category}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-bold ${textClass}">${percent}%</span>
                        </div>
                    </div>
                    <div class="h-3 w-full bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                        <div class="h-full ${colorClass} transition-all duration-500" style="width: ${percent}%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span>已用 ${formatMoney(spent)}</span>
                        <span>上限 ${formatMoney(b.limit)}</span>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderTransactions(container) {
            // Apply Filters (Global Filter State)
            let filteredTx = appData.transactions.filter(tx => {
                let pass = true;
                
                // Type filter
                if (transactionFilter.type !== 'all' && tx.type !== transactionFilter.type) pass = false;
                
                // Date Range filter
                if (transactionFilter.start && transactionFilter.end) {
                    const txDate = new Date(tx.date);
                    txDate.setHours(12,0,0,0);
                    if (txDate < transactionFilter.start || txDate > transactionFilter.end) pass = false;
                }
                
                return pass;
            });

            // Group by Date
            const groups = {};
            filteredTx.forEach(tx => {
                if (!groups[tx.date]) groups[tx.date] = [];
                groups[tx.date].push(tx);
            });
            
            const sortedDates = Object.keys(groups).sort((a, b) => new Date(b) - new Date(a));
            
            let listHtml = sortedDates.map(date => {
                const dayTotal = groups[date].reduce((acc, tx) => {
                    if (tx.type === 'income') return acc + parseFloat(tx.amount);
                    if (tx.type === 'expense') return acc - parseFloat(tx.amount);
                    return acc;
                }, 0);

                const items = groups[date].map(tx => {
                     const isExpense = tx.type === 'expense';
                     const color = isExpense ? 'text-danger' : (tx.type === 'income' ? 'text-success' : 'text-gray-500');
                     const sign = isExpense ? '-' : (tx.type === 'income' ? '+' : '');
                     const accName = appData.accounts.find(a => a.id === tx.accountId)?.name || '未知帳戶';
                     
                     return `
                        <div class="flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-white/5 border-b border-gray-100 dark:border-gray-800 last:border-0 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="size-10 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-600">
                                    <span class="material-symbols-outlined">${tx.type === 'transfer' ? 'sync_alt' : 'receipt'}</span>
                                </div>
                                <div>
                                    <p class="font-bold text-text-main dark:text-white">${tx.note || tx.category}</p>
                                    <p class="text-xs text-gray-500">${accName} ${tx.toAccountId ? '-> ' + (appData.accounts.find(a => a.id === tx.toAccountId)?.name) : ''}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold ${color}">${sign}${formatMoney(tx.amount)}</p>
                                <button onclick="deleteTransaction('${tx.id}')" class="text-xs text-red-400 hover:text-red-600 underline">刪除</button>
                            </div>
                        </div>
                     `;
                }).join('');

                return `
                    <div class="mb-6">
                        <div class="flex justify-between items-center px-2 mb-2">
                            <h4 class="font-bold text-gray-500 dark:text-gray-400">${date}</h4>
                            <span class="text-xs font-bold ${dayTotal >= 0 ? 'text-success' : 'text-danger'}">單日: ${formatMoney(dayTotal)}</span>
                        </div>
                        <div class="bg-white dark:bg-card-dark rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 overflow-hidden">
                            ${items}
                        </div>
                    </div>
                `;
            }).join('');

            if (filteredTx.length === 0) listHtml = `<div class="flex flex-col items-center justify-center h-64 text-gray-400"><span class="material-symbols-outlined text-4xl mb-2">filter_alt_off</span><p>此條件下無交易紀錄</p></div>`;

            // Filter status text
            let filterStatus = "顯示所有交易";
            if (transactionFilter.type !== 'all' || transactionFilter.start) {
                const typeMap = { 'income': '收入', 'expense': '支出', 'transfer': '轉帳', 'all': '所有' };
                filterStatus = `篩選中: ${typeMap[transactionFilter.type]} ${transactionFilter.displayRange ? '('+transactionFilter.displayRange+')' : ''}`;
            }

            container.innerHTML = `
                <div class="max-w-3xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div class="bg-primary/10 text-primary px-3 py-1 rounded-lg text-sm font-bold">
                            ${filterStatus}
                        </div>
                         <div class="flex items-center gap-2">
                             ${transactionFilter.start ? `<button onclick="switchView('transactions', true)" class="text-xs bg-gray-200 dark:bg-gray-700 px-3 py-1.5 rounded-full hover:bg-gray-300">清除篩選</button>` : ''}
                        </div>
                    </div>
                    ${listHtml}
                </div>
            `;
        }

        function renderBudgets(container) {
            container.innerHTML = `
                <div class="max-w-3xl mx-auto">
                    <div class="bg-white dark:bg-card-dark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 p-8 text-center mb-6">
                        <h3 class="text-2xl font-bold text-primary mb-2">預算管理</h3>
                        <p class="text-gray-500">設定每月各類別的支出上限，精準控管金流。</p>
                    </div>
                    <div class="bg-white dark:bg-card-dark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 p-6 space-y-8">
                        ${renderBudgetBars()}
                    </div>
                </div>
            `;
        }

        function renderAccounts(container) {
            const items = appData.accounts.map(acc => `
                <div class="bg-white dark:bg-card-dark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="size-12 rounded-xl ${acc.color || 'bg-gray-100'} flex items-center justify-center">
                            <span class="material-symbols-outlined text-xl">account_balance</span>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-text-main dark:text-white">${acc.name}</h4>
                            <p class="text-xs text-gray-400 uppercase tracking-wider">${acc.type === 'credit' ? '信用卡' : '資產帳戶'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-bold ${acc.balance < 0 ? 'text-danger' : 'text-primary'}">${formatMoney(acc.balance)}</p>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="max-w-4xl mx-auto grid grid-cols-1 gap-4">
                    ${items}
                    <button class="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl p-6 flex items-center justify-center text-gray-400 font-bold hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                        + 新增帳戶 (功能開發中)
                    </button>
                </div>
            `;
        }


        // --- Calculator & Modal Logic ---
        let calcValue = "0";
        let calcOp = null;
        let prevCalcValue = null;
        let activeTxType = 'expense'; // expense, income, transfer

        function openModal() {
            // Set Date to Today
            document.getElementById('input-date').valueAsDate = new Date();
            
            // Populate Categories
            updateCategoryOptions();

            // Populate Accounts
            updateAccountOptions();
            
            // Reset Calc
            calcValue = "0";
            updateCalcDisplay();

            // Reset Fields
            document.getElementById('input-note').value = '';
            document.getElementById('input-recurring').checked = false;

            setTxType('expense');

            document.getElementById('transaction-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('transaction-modal').classList.add('hidden');
        }

        function setTxType(type) {
            activeTxType = type;
            
            // Button Styles
            const resetBtn = "flex-1 py-2 rounded-lg text-sm font-bold text-gray-500 transition-all bg-transparent shadow-none";
            const activeClass = "flex-1 py-2 rounded-lg text-sm font-bold transition-all bg-white dark:bg-gray-700 shadow-sm";
            
            document.getElementById('btn-type-expense').className = resetBtn;
            document.getElementById('btn-type-income').className = resetBtn;
            document.getElementById('btn-type-transfer').className = resetBtn;

            const activeBtn = document.getElementById(`btn-type-${type}`);
            activeBtn.className = activeClass;
            
            if(type === 'expense') activeBtn.classList.add('text-danger');
            if(type === 'income') activeBtn.classList.add('text-success');
            if(type === 'transfer') activeBtn.classList.add('text-primary');

            // Toggle Fields
            if (type === 'transfer') {
                document.getElementById('field-category').classList.add('hidden');
                document.getElementById('field-acc-to').classList.remove('hidden');
                document.getElementById('label-acc-from').innerText = "轉出帳戶";
            } else {
                document.getElementById('field-category').classList.remove('hidden');
                document.getElementById('field-acc-to').classList.add('hidden');
                document.getElementById('label-acc-from').innerText = "帳戶";
                updateCategoryOptions();
            }
        }

        function updateCategoryOptions() {
            const select = document.getElementById('input-category');
            select.innerHTML = '';
            const cats = activeTxType === 'income' ? appData.categories.income : appData.categories.expense;
            cats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                select.appendChild(opt);
            });
        }

        function updateAccountOptions() {
            const fill = (id) => {
                const select = document.getElementById(id);
                select.innerHTML = '';
                appData.accounts.forEach(a => {
                    const opt = document.createElement('option');
                    opt.value = a.id;
                    opt.text = `${a.name} (${formatMoney(a.balance)})`;
                    select.appendChild(opt);
                });
            };
            fill('input-account');
            fill('input-account-to');
        }

        // Calculator Logic
        function calcInput(key) {
            if (['+', '-', '*', '/'].includes(key)) {
                // Operator
                if (prevCalcValue !== null && calcOp) {
                    // Execute pending
                    calcValue = eval(`${prevCalcValue} ${calcOp} ${calcValue}`).toString();
                }
                prevCalcValue = calcValue;
                calcOp = key;
                calcValue = "0"; // Reset for next number
            } else {
                // Number
                if (calcValue === "0" && key !== '.') calcValue = key;
                else calcValue += key;
            }
            updateCalcDisplay();
        }

        function calcClear() {
            calcValue = "0";
            prevCalcValue = null;
            calcOp = null;
            updateCalcDisplay();
        }

        function calcBackspace() {
            calcValue = calcValue.slice(0, -1);
            if (calcValue === "") calcValue = "0";
            updateCalcDisplay();
        }

        function updateCalcDisplay() {
            let display = calcValue;
            if (prevCalcValue && calcOp) {
                // Show intermediate state if desired, but for now just show current input
            }
            document.getElementById('input-amount').value = display;
        }

        function submitTransaction() {
            // Final calculation check
            let finalAmount = calcValue;
            if (prevCalcValue && calcOp) {
                try {
                    finalAmount = eval(`${prevCalcValue} ${calcOp} ${calcValue}`);
                } catch(e) {
                    finalAmount = calcValue;
                }
            }

            if (parseFloat(finalAmount) === 0) {
                alert("金額不能為 0");
                return;
            }

            const tx = {
                date: document.getElementById('input-date').value,
                type: activeTxType,
                amount: parseFloat(finalAmount),
                accountId: document.getElementById('input-account').value,
                note: document.getElementById('input-note').value,
                isRecurring: document.getElementById('input-recurring').checked
            };

            if (activeTxType === 'transfer') {
                tx.toAccountId = document.getElementById('input-account-to').value;
                if (tx.accountId === tx.toAccountId) {
                    alert("轉出與轉入帳戶不能相同");
                    return;
                }
                tx.category = '轉帳';
            } else {
                tx.category = document.getElementById('input-category').value;
            }

            addTransaction(tx);
            closeModal();
            updateUI();
        }

        // Init App
        window.onload = function() {
            updateUI();
        }

    </script>
</body>
</html>
