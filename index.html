<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§é€£ç·šå€‰åº«ç®¡ç†ç³»çµ±</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ Babel ç”¨æ–¼è§£æ JSX (èˆ‡ ESM é…åˆ) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* å‹•ç•«æ•ˆæœå®šç¾© */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        /* é˜²æ­¢ iOS safari é»æ“Šæ™‚çš„é–ƒçˆ */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4F46E5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4F46E5;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';
        import { 
            LayoutDashboard, 
            Package, 
            ShoppingCart, 
            Users, 
            Zap, 
            Plus, 
            ArrowRight, 
            AlertCircle, 
            CheckCircle2, 
            Combine, 
            Split, 
            MessageCircle, 
            Truck, 
            DollarSign, 
            Search, 
            Filter, 
            X, 
            ChevronRight, 
            ChevronUp,
            ClipboardList, 
            User, 
            ShoppingBag, 
            ListOrdered, 
            Tag, 
            Layers, 
            Archive, 
            CheckSquare, 
            Square, 
            Trash2, 
            Edit, 
            Save,
            Copy,
            CreditCard,
            RotateCcw,
            Minus,
            TrendingUp,
            Wallet,
            BoxSelect,
            Undo2,
            PackageCheck,
            FileSpreadsheet
        } from 'https://esm.sh/lucide-react@0.263.1?dev';

        const App = () => {
            const [activeTab, setActiveTab] = useState('products');
            const [showProxyOrder, setShowProxyOrder] = useState(false);
            const [showPurchaseList, setShowPurchaseList] = useState(false);
            const [showRevenueList, setShowRevenueList] = useState(false);
            
            // è©³æƒ…å½ˆçª—ç‹€æ…‹
            const [selectedGroupName, setSelectedGroupName] = useState(null); 
            const [selectedCustomerDetail, setSelectedCustomerDetail] = useState(null);
            
            // åˆ°è²¨ç®¡ç†é¸ä¸­çš„é¡§å®¢ (åŒ…å« source: 'pending' | 'shipped')
            const [selectedArrivalCustomer, setSelectedArrivalCustomer] = useState(null); 
            
            // ç·¨è¼¯èˆ‡æ”¶æ¬¾æ¨¡å¼ç‹€æ…‹
            const [isEditingProduct, setIsEditingProduct] = useState(false);
            const [showPaymentInput, setShowPaymentInput] = useState(false);
            const [paymentAmount, setPaymentAmount] = useState('');
            
            // ç·¨è¼¯æ•¸é‡ç‹€æ…‹ ID (æ ¼å¼: orderId-productId)
            const [editingOrderQtyId, setEditingOrderQtyId] = useState(null);
            const [editingAllocatedQtyId, setEditingAllocatedQtyId] = useState(null);
            const [editingPurchaseQtyId, setEditingPurchaseQtyId] = useState(null);

            // ä»£å®¢åŠ å–®è¡¨å–®ç‹€æ…‹
            const [proxyForm, setProxyForm] = useState({
                productName: '',
                variant: '', 
                price: '',
                customer: '',
                qty: 1,
                purchasedQty: 0
            });

            const [notification, setNotification] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');

            // 1. ç‹€æ…‹ç®¡ç†ï¼šåº«å­˜
            const [products, setProducts] = useState([
                { id: 'A1', name: 'æ—¥æœ¬æ¥µè‡´å¹é¢¨æ©Ÿ', variant: 'çç ç™½', spot: 2, price: 3200, tierMinQty: 0, tierPrice: 0 },
                { id: 'A2', name: 'æ—¥æœ¬æ¥µè‡´å¹é¢¨æ©Ÿ', variant: 'æ¶ˆå…‰é»‘', spot: 3, price: 3200, tierMinQty: 0, tierPrice: 0 },
                { id: 'B2', name: 'æ³•å¼é»‘å·§å…‹åŠ›ç›’', variant: 'å–®ä¸€æ¬¾å¼', spot: 20, price: 450, tierMinQty: 0, tierPrice: 0 },
                { id: 'C3', name: 'éŸ“åœ‹é™å®šé‹å‹•é‹', variant: '24cm', spot: 0, price: 2800, tierMinQty: 0, tierPrice: 0 },
                { id: 'D4', name: 'è† åŸè›‹ç™½ç²‰', variant: 'ç½è£', spot: 30, price: 980, tierMinQty: 0, tierPrice: 0 },
                { id: 'E5', name: 'ç’°ä¿è³¼ç‰©è¢‹', variant: 'è—è‰²', spot: 2, price: 150, tierMinQty: 0, tierPrice: 0 },
            ]);

            // 2. ç‹€æ…‹ç®¡ç†ï¼šè¨‚å–®
            const [orders, setOrders] = useState([
                { id: 'ORD001', customer: 'æ—å°ç¾', total: 6400, paid: 3200, status: 'éƒ¨åˆ†åˆ°è²¨', items: [{ productId: 'A1', name: 'æ—¥æœ¬æ¥µè‡´å¹é¢¨æ©Ÿ', variant: 'çç ç™½', qty: 2, allocatedQty: 2, price: 3200 }], debt: 3200, unclaimed: 1 },
                { id: 'ORD002', customer: 'ç‹å¤§åŒ', total: 450, paid: 0, status: 'å¾…çµå–®', items: [{ productId: 'B2', name: 'æ³•å¼é»‘å·§å…‹åŠ›ç›’', variant: 'å–®ä¸€æ¬¾å¼', qty: 1, allocatedQty: 0, price: 450 }], debt: 450, unclaimed: 0 },
                { id: 'ORD003', customer: 'å¼µé›…å©·', total: 5600, paid: 5600, status: 'å¾…å‡ºè²¨', items: [{ productId: 'C3', name: 'éŸ“åœ‹é™å®šé‹å‹•é‹', variant: '24cm', qty: 2, allocatedQty: 2, price: 2800 }], debt: 0, unclaimed: 2 },
            ]);

            const notify = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            // ==========================================
            //  æ ¸å¿ƒé‹ç®—å€ (é †åºå¾ˆé‡è¦)
            // ==========================================

            // 1. å•†å“çµ±è¨ˆ (Products Stats)
            const productsWithStats = useMemo(() => {
                return products.map(p => {
                    let allocated = 0; // ç¸½å–Šå–®
                    let confirmed = 0; // å·²é…å–® (Allocated/Supply)

                    orders.forEach(o => {
                        o.items.forEach(item => {
                            if (item.productId === p.id) {
                                allocated += item.qty;
                                confirmed += (item.allocatedQty || 0);
                            }
                        });
                    });

                    const pending = allocated - confirmed;
                    const totalOwned = p.spot + confirmed;
                    const shortage = Math.max(0, allocated - totalOwned);

                    return { ...p, allocated, confirmed, pending, shortage };
                });
            }, [products, orders]);

            // 2. é¡§å®¢æ¸…å–® (Customer List)
            const customerList = useMemo(() => {
                const map = {};
                
                orders.forEach(o => {
                    if (!map[o.customer]) {
                        map[o.customer] = { 
                            name: o.customer, 
                            totalSpent: 0, 
                            totalPaid: 0,
                            orderCount: 0, 
                            debt: 0, 
                            items: [],
                            rawItems: []
                        };
                    }
                    map[o.customer].totalPaid += o.paid;
                    map[o.customer].orderCount += 1;
                    
                    o.items.forEach(item => {
                        map[o.customer].rawItems.push({
                            ...item,
                            orderId: o.id
                        });
                    });
                });

                // è¨ˆç®—å„ªæƒ èˆ‡ç¸½é¡
                Object.values(map).forEach(cust => {
                    const nameCounts = {};
                    cust.rawItems.forEach(item => {
                        const productInfo = products.find(p => p.id === item.productId);
                        const productName = productInfo ? productInfo.name : item.name;
                        if (!nameCounts[productName]) nameCounts[productName] = 0;
                        nameCounts[productName] += item.qty;
                    });

                    cust.rawItems.forEach(item => {
                        const productInfo = products.find(p => p.id === item.productId);
                        let finalPrice = item.price;
                        let originalPrice = item.price;
                        let tierMinQty = 0;
                        let tierPrice = 0;

                        if (productInfo) {
                            originalPrice = productInfo.price;
                            tierMinQty = productInfo.tierMinQty;
                            tierPrice = productInfo.tierPrice;
                            
                            const pName = productInfo.name;
                            if (tierMinQty > 0 && nameCounts[pName] >= tierMinQty) {
                                finalPrice = tierPrice;
                            }
                        }

                        const itemTotal = item.qty * finalPrice;
                        
                        cust.items.push({
                            ...item,
                            finalPrice, 
                            isDiscounted: finalPrice < originalPrice, 
                            itemTotal,
                            isAllocated: (item.allocatedQty || 0) >= item.qty
                        });
                        cust.totalSpent += itemTotal;
                    });

                    cust.debt = Math.max(0, cust.totalSpent - cust.totalPaid);
                });

                return Object.values(map);
            }, [orders, products]);

            // 3. å…¨åŸŸçµ±è¨ˆ (Stats)
            const stats = useMemo(() => {
                const totalDebt = customerList.reduce((acc, curr) => acc + curr.debt, 0);
                const totalRevenue = customerList.reduce((acc, curr) => acc + curr.totalSpent, 0); 

                let shortageItemCount = 0; 
                let totalShortageQty = 0;  

                productsWithStats.forEach(p => {
                    if (p.shortage > 0) {
                        shortageItemCount += 1;
                        totalShortageQty += p.shortage;
                    }
                });

                return {
                    totalDebt,
                    totalRevenue, 
                    shortageItemCount,
                    totalShortageQty,
                    pendingShipment: orders.filter(o => o.status === 'å¾…å‡ºè²¨').length
                };
            }, [orders, productsWithStats, customerList]); 

            // 4. åˆ°è²¨ç®¡ç†è³‡æ–™ (Split into Pending and Shipped)
            const { pendingArrivalCustomers, shippedArrivalCustomers } = useMemo(() => {
                const pendingMap = {};
                const shippedMap = {};

                orders.forEach(o => {
                    // å·²å‡ºè²¨çš„è¨‚å–®é€²å…¥ shippedMapï¼Œå…¶é¤˜é€²å…¥ pendingMap
                    const targetMap = o.status === 'å·²å‡ºè²¨' ? shippedMap : pendingMap;
                    
                    if (!targetMap[o.customer]) {
                        targetMap[o.customer] = { name: o.customer, items: [] };
                    }
                    o.items.forEach(item => {
                        targetMap[o.customer].items.push({
                            ...item,
                            orderId: o.id,
                            isShipped: o.status === 'å·²å‡ºè²¨'
                        });
                    });
                });

                const processMap = (map, source) => {
                    return Object.values(map).map(cust => {
                        const totalItemsCount = cust.items.length; 
                        const arrivedItemsCount = cust.items.filter(i => (i.allocatedQty || 0) >= i.qty).length; 
                        
                        const totalQty = cust.items.reduce((sum, i) => sum + i.qty, 0); 
                        const allocatedQty = cust.items.reduce((sum, i) => sum + (i.allocatedQty || 0), 0);

                        const isFullyArrived = totalItemsCount > 0 && totalItemsCount === arrivedItemsCount;
                        
                        return {
                            ...cust,
                            source, // æ¨™è¨˜ä¾†æº
                            totalItemsCount,
                            arrivedItemsCount,
                            totalQty,
                            allocatedQty,
                            isFullyArrived
                        };
                    }).sort((a, b) => {
                        // å…¨åˆ°è²¨çš„æ’å‰é¢
                        if (a.isFullyArrived && !b.isFullyArrived) return -1;
                        if (!a.isFullyArrived && b.isFullyArrived) return 1;
                        return 0;
                    });
                };

                return {
                    pendingArrivalCustomers: processMap(pendingMap, 'pending'),
                    shippedArrivalCustomers: processMap(shippedMap, 'shipped')
                };
            }, [orders, products]); // ä¾è³´ orders å’Œ products (å–å¾—åç¨±è®Šé«”)

            // 5. æœå°‹èˆ‡éæ¿¾
            const purchaseList = useMemo(() => productsWithStats.filter(p => p.shortage > 0).map(p => ({ ...p })), [productsWithStats]);
            
            const revenueCustomers = useMemo(() => {
                return customerList.filter(c => c.totalSpent > 0).sort((a, b) => b.totalSpent - a.totalSpent);
            }, [customerList]);

            const groupedProducts = useMemo(() => {
                const groups = {};
                productsWithStats.forEach(p => {
                    if (!groups[p.name]) {
                        groups[p.name] = { name: p.name, price: p.price, totalAllocated: 0, totalConfirmed: 0, totalSpot: 0, variants: [] };
                    }
                    groups[p.name].totalAllocated += p.allocated;
                    groups[p.name].totalConfirmed += p.confirmed;
                    groups[p.name].totalSpot += p.spot;
                    groups[p.name].variants.push(p);
                });
                return Object.values(groups);
            }, [productsWithStats]);

            const filteredGroupedProducts = groupedProducts.filter(g => g.name.includes(searchQuery));
            const filteredCustomers = customerList.filter(c => c.name.includes(searchQuery));
            
            // æœå°‹éæ¿¾åˆ°è²¨ç®¡ç†
            const filteredPendingArrivals = pendingArrivalCustomers.filter(c => c.name.includes(searchQuery));
            const filteredShippedArrivals = shippedArrivalCustomers.filter(c => c.name.includes(searchQuery));
            
            const filteredOrders = orders.filter(o => o.customer.includes(searchQuery) || o.id.includes(searchQuery));
            const unsettledOrders = filteredOrders.filter(o => o.status !== 'å¾…å‡ºè²¨' && o.status !== 'å·²å‡ºè²¨');
            const settledOrders = filteredOrders.filter(o => o.status === 'å¾…å‡ºè²¨');

            const availableVariants = useMemo(() => {
                if (!proxyForm.productName) return [];
                return [...new Set(products.filter(p => p.name === proxyForm.productName).map(p => p.variant))];
            }, [products, proxyForm.productName]);

            // --- Handlers ---
            const navigateTo = (tab) => { setActiveTab(tab); setSearchQuery(''); };
            const handleProxyProductChange = (e) => {
                const name = e.target.value;
                const existing = products.find(p => p.name === name);
                setProxyForm(prev => ({ ...prev, productName: name, price: existing ? existing.price : prev.price }));
            };

            const handleExportToCSV = () => {
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                csvContent += "é¡§å®¢æš±ç¨±,å•†å“åç¨±,æ¬¾å¼,æ•¸é‡,å–®åƒ¹,ç¸½åƒ¹\n";
                customerList.forEach(cust => {
                    cust.items.forEach(item => {
                        const row = [`"${cust.name}"`, `"${item.name}"`, `"${item.variant}"`, item.qty, item.finalPrice, item.qty * item.finalPrice].join(",");
                        csvContent += row + "\n";
                    });
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `åœ˜è³¼è¨‚å–®å ±è¡¨_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                notify("å ±è¡¨å·²åŒ¯å‡º");
            };

            // ç¢ºèªå‡ºè²¨åŠŸèƒ½
            const handleShipCustomer = (customerName) => {
                if(!window.confirm(`ç¢ºèªå°‡ ${customerName} çš„æ‰€æœ‰å•†å“æ¨™è¨˜ç‚ºã€Œå·²å‡ºè²¨ã€å—ï¼Ÿ`)) return;

                setOrders(prev => prev.map(o => {
                    // åªæ›´æ–°è©²é¡§å®¢ä¸”å°šæœªå‡ºè²¨çš„è¨‚å–®
                    if (o.customer === customerName && o.status !== 'å·²å‡ºè²¨') {
                        return { ...o, status: 'å·²å‡ºè²¨' };
                    }
                    return o;
                }));
                
                // é—œé–‰è¦–çª—ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°åˆ—è¡¨è®Šå‹•
                setSelectedArrivalCustomer(null);
                notify(`${customerName} çš„è¨‚å–®å·²ç§»è‡³å‡ºè²¨ç´€éŒ„`);
            };

            // å–æ¶ˆå‡ºè²¨ (å›å¾©) åŠŸèƒ½
            const handleUnshipCustomer = (customerName) => {
                if(!window.confirm(`ç¢ºå®šè¦å–æ¶ˆ ${customerName} çš„å‡ºè²¨ç‹€æ…‹ï¼Œä¸¦å›å¾©ç‚ºã€Œå¾…å‡ºè²¨ã€å—ï¼Ÿ`)) return;

                setOrders(prev => prev.map(o => {
                    if (o.customer === customerName && o.status === 'å·²å‡ºè²¨') {
                        return { ...o, status: 'å¾…å‡ºè²¨' }; // å›å¾©åˆ°å¾…å‡ºè²¨ç‹€æ…‹ (æˆ–ä¹‹å‰çš„ç‹€æ…‹ï¼Œé€™è£¡ç°¡åŒ–ç‚ºå¾…å‡ºè²¨)
                    }
                    return o;
                }));
                
                setSelectedArrivalCustomer(null);
                notify(`${customerName} å·²å›å¾©ç‚ºå¾…å‡ºè²¨`);
            };

            const handleUpdateOrderQty = (orderId, productId, newQtyStr) => {
                const newQty = parseInt(newQtyStr, 10);
                if (isNaN(newQty) || newQty < 0) return;
                setOrders(prev => prev.map(o => {
                    if (o.id === orderId) {
                        const newItems = o.items.map(item => item.productId === productId ? { ...item, qty: newQty } : item).filter(item => item.qty > 0);
                        return { ...o, items: newItems };
                    }
                    return o;
                }));
                setEditingOrderQtyId(null);
                notify("æ•¸é‡å·²æ›´æ–°");
            };

            const handleUpdateAllocatedQty = (orderId, productId, newAllocatedQtyStr) => {
                const newAllocated = parseInt(newAllocatedQtyStr, 10);
                if (isNaN(newAllocated) || newAllocated < 0) return;
                const order = orders.find(o => o.id === orderId);
                const item = order?.items.find(i => i.productId === productId);
                if (!item) return;
                if (newAllocated > item.qty) { notify(`ä¸å¯å¤§æ–¼å–Šå–®æ•¸é‡`); setEditingAllocatedQtyId(null); return; }
                const diff = newAllocated - (item.allocatedQty || 0);
                setOrders(prev => prev.map(o => {
                    if (o.id === orderId) {
                        const newItems = o.items.map(i => i.productId === productId ? { ...i, allocatedQty: newAllocated } : i);
                        return { ...o, items: newItems };
                    }
                    return o;
                }));
                setProducts(prev => prev.map(p => p.id === productId ? { ...p, spot: p.spot - diff } : p));
                setEditingAllocatedQtyId(null);
            };
            
            const handleUpdatePurchaseQty = (productId, newShortageStr) => {
                const newShortage = parseInt(newShortageStr, 10);
                if (isNaN(newShortage) || newShortage < 0) return;
                const product = productsWithStats.find(p => p.id === productId);
                if (!product) return;
                const newSpot = product.allocated - product.confirmed - newShortage;
                setProducts(prev => prev.map(p => p.id === productId ? { ...p, spot: newSpot } : p));
                setEditingPurchaseQtyId(null);
                notify(`åº«å­˜å·²èª¿æ•´`);
            };

            const handleDeleteOrderItem = (orderId, productId) => {
                if(!window.confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å•†å“å—ï¼Ÿ')) return;
                setOrders(prev => prev.map(o => {
                    if (o.id === orderId) {
                        const itemToRemove = o.items.find(i => i.productId === productId);
                        const newItems = o.items.filter(i => i.productId !== productId);
                        if (itemToRemove && (itemToRemove.allocatedQty || 0) > 0) {
                            setProducts(currProducts => currProducts.map(p => p.id === productId ? { ...p, spot: p.spot + itemToRemove.allocatedQty } : p));
                        }
                        return { ...o, items: newItems };
                    }
                    return o;
                }).filter(o => o.items.length > 0));
                notify("å·²åˆªé™¤å•†å“");
            };

            const handleUpdateProductInfo = (productId, field, value) => {
                const val = parseInt(value, 10);
                if (isNaN(val)) return;
                const targetProduct = products.find(p => p.id === productId);
                const targetName = targetProduct ? targetProduct.name : '';
                setProducts(prev => prev.map(p => {
                    if ((field === 'tierMinQty' || field === 'tierPrice') && p.name === targetName) return { ...p, [field]: val };
                    if (p.id === productId) return { ...p, [field]: val };
                    return p;
                }));
            };

            const handleDeleteProductGroup = (groupName, e) => {
                e.stopPropagation();
                if (window.confirm(`ç¢ºå®šè¦åˆªé™¤å•†å“ã€Œ${groupName}ã€å—ï¼Ÿ`)) {
                    setProducts(prev => prev.filter(p => p.name !== groupName));
                    if (selectedGroupName === groupName) setSelectedGroupName(null);
                    notify(`å·²åˆªé™¤å•†å“`);
                }
            };
            
            const handleDeleteProduct = (productId) => {
                if(window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ¬¾å¼å—ï¼Ÿ')) {
                    setProducts(prev => prev.filter(p => p.id !== productId));
                    notify("å·²åˆªé™¤æ¬¾å¼");
                }
            };

            const handleDeleteCustomer = (customerName, e) => {
                e.stopPropagation();
                if (window.confirm(`ç¢ºå®šè¦åˆªé™¤é¡§å®¢ã€Œ${customerName}ã€çš„è³‡æ–™å—ï¼Ÿ`)) {
                    setOrders(prev => prev.filter(o => o.customer !== customerName));
                    if (selectedCustomerDetail?.name === customerName) setSelectedCustomerDetail(null);
                    notify(`å·²åˆªé™¤é¡§å®¢`);
                }
            };

            const toggleAllocation = (orderId, productId, currentAllocated, totalQty) => {
                const newAllocated = currentAllocated >= totalQty ? 0 : totalQty;
                const diff = newAllocated - currentAllocated;
                const product = products.find(p => p.id === productId);
                if (diff > 0 && product && product.spot < diff) notify("âš ï¸ ç¾è²¨ä¸è¶³ï¼Œåº«å­˜å°‡è®Šè² ");
                setOrders(prev => prev.map(o => {
                    if (o.id === orderId) {
                        const newItems = o.items.map(item => item.productId === productId ? { ...item, allocatedQty: newAllocated } : item);
                        return { ...o, items: newItems };
                    }
                    return o;
                }));
                setProducts(prev => prev.map(p => p.id === productId ? { ...p, spot: p.spot - diff } : p));
            };

            const handleAddOrder = () => {
                const { productName, variant, price, customer, qty, purchasedQty } = proxyForm;
                const finalVariant = variant || 'å–®ä¸€æ¬¾å¼';
                if (!productName || !price) { notify('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š'); return; }

                const quantity = parseInt(qty, 10) || 1;
                const purchasedQuantity = parseInt(purchasedQty, 10) || 0;
                const finalPrice = parseInt(price, 10) || 0;

                let targetProduct = products.find(p => p.name === productName && p.variant === finalVariant);
                let isNewProduct = false;
                let targetId = targetProduct?.id;

                if (!targetProduct) {
                    isNewProduct = true;
                    targetId = `N${Math.floor(Math.random() * 10000)}`;
                    targetProduct = { id: targetId, name: productName, variant: finalVariant, price: finalPrice, spot: 0, tierMinQty: 0, tierPrice: 0 };
                }

                setProducts(prev => {
                    if (isNewProduct) return [{ ...targetProduct, spot: purchasedQuantity }, ...prev];
                    else return prev.map(p => p.id === targetId ? { ...p, spot: p.spot + purchasedQuantity } : p);
                });

                if (customer) {
                    const newOrder = {
                        id: `ORD${Math.floor(Math.random() * 10000)}`,
                        customer: customer,
                        total: finalPrice * quantity,
                        paid: 0,
                        status: 'å¾…çµå–®',
                        items: [{ productId: targetId, name: productName, variant: finalVariant, qty: quantity, price: finalPrice, allocatedQty: 0 }],
                        debt: 0,
                        unclaimed: 0
                    };
                    setOrders(prev => [newOrder, ...prev]);
                    notify(`åŠ å–®æˆåŠŸ`);
                } else {
                    notify(`å·²å…¥åº«`);
                }
                setShowProxyOrder(false);
                setProxyForm({ productName: '', variant: '', price: '', customer: '', qty: 1, purchasedQty: 0 });
            };

            const handleCustomerPayment = () => {
                const amount = parseInt(paymentAmount, 10);
                if (isNaN(amount) || amount === 0) {
                    notify("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ”¶æ¬¾é‡‘é¡");
                    return;
                }

                if (!selectedCustomerDetail) return;

                const customerName = selectedCustomerDetail.name;
                
                setOrders(prevOrders => {
                    let remaining = Math.abs(amount);
                    const isRefund = amount < 0;
                    
                    return prevOrders.map(order => {
                        if (order.customer !== customerName || remaining <= 0) return order;

                        if (!isRefund && order.debt > 0) {
                            const payAmount = Math.min(order.debt, remaining);
                            remaining -= payAmount;
                            return { ...order, paid: order.paid + payAmount, debt: order.debt - payAmount };
                        } else if (isRefund && order.paid > 0) {
                            const refundAmount = Math.min(order.paid, remaining);
                            remaining -= refundAmount;
                            return { ...order, paid: order.paid - refundAmount, debt: order.debt + refundAmount };
                        }
                        return order;
                    });
                });

                setPaymentAmount('');
                setShowPaymentInput(false);
                notify(amount > 0 ? `å·²æ”¶æ¬¾ $${amount}` : `å·²é€€æ¬¾ $${Math.abs(amount)}`);
            };

            const handleCopyCustomerDetails = (customer) => {
                let itemsText = '';
                customer.items.forEach(item => {
                    const priceDisplay = item.isDiscounted ? `$${item.finalPrice} (å„ªæƒ )` : `$${item.finalPrice}`;
                    itemsText += `- ${item.name} ${item.variant !== 'å–®ä¸€æ¬¾å¼' && item.variant ? `(${item.variant})` : ''} x${item.qty} ${priceDisplay}\n`;
                });
                const text = `è¦ªæ„›çš„ ${customer.name} æ‚¨å¥½ï¼Œ\næ‚¨æœ¬æ¬¡çš„é€£ç·šè³¼ç‰©æ˜ç´°å¦‚ä¸‹ï¼š\n${itemsText}----------------\næ¶ˆè²»ç¸½é¡ï¼š$${customer.totalSpent.toLocaleString()}\n\nå¯ä»¥å…ˆå¹«æˆ‘æ­æ³¢å»å¯\næœ‰èª¤çš„è©±ï½è«‹è¶•å¿«è·Ÿæˆ‘èªªï¼\nâ‚ŠâŠ¹ è‹¥æ˜¯æ²’æœ‰æ¼æ‰çš„å•†å“ â‚ŠâŠ¹\nå°±å¯ä»¥ç›´æ¥çµå¸³å›‰ï¼\nç¶²å€ï¼šï¼ˆé€™è£¡ç•™çµ¦æˆ‘è‡ªå·±è¼¸å…¥ç¶²å€ï¼‰\næ‰¾åˆ°è‡ªå·±åå­—å¾Œå®Œæˆä¸‹å–®å°±å¯ä»¥åš•\nğ™š æ”¶åˆ°æ‰€æœ‰é€£çµå¾Œè«‹ç›¡é€Ÿå®Œæˆä»˜æ¬¾\n   ä¸è¦è€½èª¤åˆ°æœ€ä½³çš„è³å‘³æœŸé™å”·\n\nâš p.s. å‰ä¸€æ¬¡é€£ç·šæœ‰é–‹ç®±åˆ†äº«çš„æœ‹å‹~\nä¸‹å–®å¾Œè«‹å¹«æˆ‘å‚™è¨»ä¸€ä¸‹ï¼šé–‹ç®±ç¦®\nğ­ğ¡ğšğ§ğ¤ ğ²ğ¨ğ® (â€â€¢ ÖŠ â€¢â€)à©­`;
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try { document.execCommand('copy'); notify("å·²è¤‡è£½é€šçŸ¥æ–‡æ¡ˆï¼"); } catch (err) { notify("è¤‡è£½å¤±æ•—"); }
                document.body.removeChild(textArea);
            };

            const handleCheckout = (orderId) => {
                setOrders(prev => prev.map(o => o.id === orderId ? { ...o, status: 'å¾…å‡ºè²¨', paid: o.total, debt: 0 } : o));
                notify("çµå–®æˆåŠŸ");
            };

            const getGroupAllocations = (groupName) => {
                const variants = products.filter(p => p.name === groupName);
                const result = [];
                variants.forEach(variant => {
                    orders.forEach(o => {
                        o.items.forEach(item => {
                            if (item.productId === variant.id) {
                                result.push({
                                    orderId: o.id,
                                    productId: variant.id,
                                    customer: o.customer,
                                    qty: item.qty,
                                    variant: variant.variant,
                                    allocatedQty: item.allocatedQty || 0,
                                    isAllocated: (item.allocatedQty || 0) >= item.qty
                                });
                            }
                        });
                    });
                });
                return result;
            };

            // ç¢ºä¿é¸ä¸­ç‰©ä»¶æ›´æ–° (ä½¿ç”¨ useMemo ä¸­çš„ arrivalCustomers ä¾†æŸ¥æ‰¾ï¼Œç¢ºä¿ source æ­£ç¢º)
            const currentSelectedCustomer = selectedCustomerDetail 
                ? customerList.find(c => c.name === selectedCustomerDetail.name) || selectedCustomerDetail
                : null;
            
            // ä¿®æ­£ï¼šåœ¨æ¸²æŸ“æ™‚å‹•æ…‹æŸ¥æ‰¾å°æ‡‰æ¸…å–®ä¸­çš„é¡§å®¢ç‰©ä»¶
            // é€™è§£æ±ºäº†ã€Œé»æ“Šæ²’åæ‡‰ã€æˆ–ã€Œè³‡æ–™ä¸æ›´æ–°ã€çš„å•é¡Œ
            const currentSelectedArrivalCustomer = selectedArrivalCustomer
                ? (
                    // å…ˆçœ‹èƒ½ä¸èƒ½åœ¨å¾…å‡ºè²¨æ‰¾åˆ°
                    pendingArrivalCustomers.find(c => c.name === selectedArrivalCustomer.name) ||
                    // å†çœ‹èƒ½ä¸èƒ½åœ¨å·²å‡ºè²¨æ‰¾åˆ°
                    shippedArrivalCustomers.find(c => c.name === selectedArrivalCustomer.name) ||
                    // è‹¥éƒ½æ‰¾ä¸åˆ° (å¯èƒ½å‰›å¥½ç‹€æ…‹åˆ‡æ›)ï¼Œå›å‚³åŸæœ¬çš„ï¼Œé¿å…å´©æ½°
                    selectedArrivalCustomer
                  )
                : null;

            return (
                <div className="min-h-screen pb-24">
                    {/* é€šçŸ¥ */}
                    {notification && (
                        <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[300] bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 animate-bounce transition-all">
                            <CheckCircle2 size={18} className="text-green-400" />
                            {notification}
                        </div>
                    )}

                    {/* Header */}
                    <div className="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-50">
                        <div className="flex justify-between items-center max-w-2xl mx-auto">
                            <h1 className="text-xl font-bold flex items-center gap-2 cursor-pointer" onClick={() => navigateTo('dashboard')}>
                                <Zap className="fill-yellow-400 text-yellow-400" /> Smart WMS
                            </h1>
                            <div className="bg-indigo-500/50 px-3 py-1 rounded-full text-[10px] font-bold tracking-wider flex items-center gap-1">
                                <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                é€£ç·šä¸­
                            </div>
                        </div>
                    </div>

                    {/* Nav */}
                    <div className="bg-white border-b sticky top-[60px] z-40">
                        <div className="flex max-w-2xl mx-auto overflow-x-auto no-scrollbar">
                            {[
                                { id: 'products', label: 'å•†å“åˆ—è¡¨', icon: ShoppingBag },
                                { id: 'dashboard', label: 'ç‹€æ…‹', icon: LayoutDashboard },
                                { id: 'customers', label: 'é¡§å®¢åˆ—è¡¨', icon: Users },
                                { id: 'arrivals', label: 'åˆ°è²¨ç®¡ç†', icon: BoxSelect },
                            ].map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => navigateTo(item.id)}
                                    className={`flex-1 py-4 px-2 flex flex-col items-center gap-1 text-[10px] font-bold transition-all whitespace-nowrap
                                        ${activeTab === item.id ? 'text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/50' : 'text-slate-400 opacity-70'}`}
                                >
                                    <item.icon size={18} />
                                    {item.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Main Content */}
                    <main className="max-w-2xl mx-auto p-4 space-y-4">
                        {/* æœå°‹æ¬„ä½ */}
                        {activeTab !== 'dashboard' && (
                            <div className="relative animate-in">
                                <input 
                                    type="text" 
                                    placeholder={`æœå°‹${activeTab === 'products' ? 'å•†å“' : activeTab === 'customers' ? 'é¡§å®¢' : 'è¨‚å–®'}...`} 
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="w-full bg-white border-none rounded-2xl p-4 pl-12 shadow-sm focus:ring-2 focus:ring-indigo-500 transition-all text-sm outline-none"
                                />
                                <Search size={18} className="absolute left-4 top-4 text-slate-300" />
                                {searchQuery && <X size={18} className="absolute right-4 top-4 text-slate-300 cursor-pointer" onClick={() => setSearchQuery('')} />}
                            </div>
                        )}

                        {/* View 1: å•†å“åˆ—è¡¨ */}
                        {activeTab === 'products' && (
                            <div className="space-y-3 pb-20">
                                {filteredGroupedProducts.map(g => {
                                    const totalOwned = g.totalSpot + g.totalConfirmed;
                                    const shortage = Math.max(0, g.totalAllocated - totalOwned);
                                    
                                    return (
                                        <div 
                                            key={g.name} 
                                            onClick={() => { setSelectedGroupName(g.name); setIsEditingProduct(false); }}
                                            className="bg-white rounded-3xl p-4 flex justify-between items-center shadow-sm border border-slate-100 hover:border-indigo-300 transition-all cursor-pointer active:scale-98 relative overflow-hidden"
                                        >
                                            {shortage > 0 && <div className="absolute left-0 top-0 bottom-0 w-1 bg-rose-500"></div>}
                                            <div className="flex-1 pl-2">
                                                <div className="flex justify-between items-start mb-1">
                                                    <div>
                                                        <h4 className="font-black text-slate-800 text-lg">{g.name}</h4>
                                                        <span className="bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded-full font-bold">{g.variants.length} æ¬¾å¼</span>
                                                    </div>
                                                    <div className="flex items-start gap-3">
                                                        <div className="text-right">
                                                            <span className="block text-lg font-black text-slate-700">${g.price}</span>
                                                            <span className="text-[10px] text-slate-400">å–®åƒ¹</span>
                                                        </div>
                                                        <button 
                                                            onClick={(e) => handleDeleteProductGroup(g.name, e)}
                                                            className="text-slate-300 hover:text-rose-500 p-3 -mr-2"
                                                        >
                                                            <Trash2 size={20} />
                                                        </button>
                                                    </div>
                                                </div>
                                                <div className="flex gap-4 items-center mt-2 border-t border-slate-50 pt-2">
                                                    <div className="text-xs">
                                                        <span className="text-slate-400">ç¸½å–Šå–® </span>
                                                        <span className="font-bold text-slate-800 text-lg">{g.totalAllocated}</span>
                                                    </div>
                                                    <div className="text-xs">
                                                        <span className="text-slate-400">å·²é… </span>
                                                        <span className={`font-bold text-lg ${g.totalConfirmed > 0 ? 'text-indigo-600' : 'text-slate-300'}`}>{g.totalConfirmed}</span>
                                                    </div>
                                                    <div className="text-xs">
                                                        <span className="text-slate-400">ç¸½ç¾è²¨ </span>
                                                        <span className={`font-bold text-lg ${g.totalSpot < 0 ? 'text-rose-500' : 'text-slate-800'}`}>{g.totalSpot}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}

                        {/* View 2: Dashboard */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-4 animate-in pb-20">
                                <div className="grid grid-cols-2 gap-4">
                                    <div 
                                        onClick={() => setShowPurchaseList(true)}
                                        className="bg-rose-500 text-white p-4 rounded-3xl shadow-lg shadow-rose-100 relative overflow-hidden cursor-pointer active:scale-95 transition-all"
                                    >
                                        <p className="text-[10px] font-bold opacity-80 relative z-10">éœ€è£œè²¨çµ±è¨ˆ (é»æ“ŠæŸ¥çœ‹)</p>
                                        <div className="mt-1 relative z-10">
                                            <p className="text-3xl font-black">{stats.shortageItemCount} <span className="text-sm font-bold opacity-80">æ¬¾</span></p>
                                            <p className="text-xs opacity-90 mt-1 font-bold">å…±ç¼º {stats.totalShortageQty} ä»¶</p>
                                        </div>
                                        <div className="absolute -right-4 -bottom-4 bg-white/10 w-24 h-24 rounded-full blur-2xl"></div>
                                    </div>
                                    <div 
                                        onClick={() => setShowRevenueList(true)}
                                        className="bg-amber-500 text-white p-4 rounded-3xl shadow-lg shadow-amber-100 cursor-pointer active:scale-95 transition-all relative overflow-hidden"
                                    >
                                        <div className="relative z-10">
                                            <p className="text-[10px] font-bold opacity-80 mb-1">ç¸½ç‡Ÿæ¥­é¡ (é»æ“ŠæŸ¥çœ‹)</p>
                                            <div className="space-y-1">
                                                <div className="flex justify-between items-baseline">
                                                    <span className="text-xl font-bold">${stats.totalRevenue.toLocaleString()}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="absolute -right-4 -bottom-4 bg-white/10 w-24 h-24 rounded-full blur-2xl"></div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* View 3: é¡§å®¢åˆ—è¡¨ */}
                        {activeTab === 'customers' && (
                            <div className="space-y-3 pb-20">
                                <div className="flex justify-end mb-2">
                                    <button onClick={handleExportToCSV} className="bg-emerald-500 text-white px-3 py-1.5 rounded-xl text-xs font-bold flex items-center gap-1 shadow-sm active:scale-95 transition-all">
                                        <FileSpreadsheet size={14}/> åŒ¯å‡ºå ±è¡¨
                                    </button>
                                </div>
                                {filteredCustomers.map((cust, idx) => (
                                    <div key={idx} onClick={() => setSelectedCustomerDetail(cust)} className="bg-white rounded-3xl p-4 shadow-sm border border-slate-100 flex justify-between items-center cursor-pointer active:scale-98">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center font-bold text-sm">{cust.name.charAt(0)}</div>
                                            <div>
                                                <h4 className="font-black text-slate-800">{cust.name}</h4>
                                                <p className="text-[10px] text-slate-400 font-bold">{cust.orderCount} ç­†è¨‚å–®</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <div className="text-right">
                                                <p className="text-lg font-black text-indigo-600">${cust.totalSpent.toLocaleString()}</p>
                                            </div>
                                            {/* é¡§å®¢åˆªé™¤æŒ‰éˆ• */}
                                            <button 
                                                onClick={(e) => handleDeleteCustomer(cust.name, e)}
                                                className="text-slate-300 hover:text-rose-500 p-3 -mr-2"
                                            >
                                                <Trash2 size={20} />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* View 4: åˆ°è²¨ç®¡ç† (åˆ†æµç‚º å¾…å‡ºè²¨ / å·²å‡ºè²¨) */}
                        {activeTab === 'arrivals' && (
                            <div className="space-y-6 pb-24">
                                
                                {/* å€å¡Šä¸€ï¼šå¾…å‡ºè²¨ / åˆ°è²¨ä¸­ */}
                                <div>
                                    <div className="flex items-center gap-2 mb-3 px-2">
                                        <Package size={20} className="text-indigo-600" />
                                        <h3 className="text-lg font-black text-slate-800">ğŸ“¦ å¾…å‡ºè²¨ / åˆ°è²¨ä¸­</h3>
                                    </div>
                                    <div className="space-y-4">
                                        {filteredPendingArrivals.length === 0 ? (
                                            <div className="text-center p-8 bg-white rounded-3xl border border-dashed border-slate-200 text-slate-400 text-sm">
                                                ç›®å‰æ²’æœ‰å¾…è™•ç†è¨‚å–®
                                            </div>
                                        ) : (
                                            filteredPendingArrivals.map((cust, idx) => {
                                                const progress = cust.totalQty > 0 ? (cust.allocatedQty / cust.totalQty) * 100 : 0;
                                                
                                                return (
                                                    <div key={idx} onClick={() => setSelectedArrivalCustomer(cust)} className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden cursor-pointer active:scale-98 relative">
                                                        {/* ç¢ºèªå‡ºè²¨æŒ‰éˆ• (åƒ…å…¨åˆ°è²¨æ™‚é¡¯ç¤º) */}
                                                        {cust.isFullyArrived && (
                                                            <button 
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    handleShipCustomer(cust.name);
                                                                }}
                                                                className="absolute right-3 bottom-3 bg-emerald-500 text-white px-3 py-1.5 rounded-xl text-xs font-bold shadow-lg shadow-emerald-200 z-10 flex items-center gap-1 active:scale-95 transition-all animate-bounce"
                                                            >
                                                                <Truck size={14} /> ç¢ºèªå‡ºè²¨
                                                            </button>
                                                        )}

                                                        <div className="p-4 flex justify-between items-center">
                                                            <div className="flex items-center gap-3">
                                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${cust.isFullyArrived ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-500'}`}>
                                                                    {cust.name.charAt(0)}
                                                                </div>
                                                                <div>
                                                                    <h4 className="font-black text-lg text-slate-800 flex items-center gap-2">
                                                                        {cust.name}
                                                                        {cust.isFullyArrived && <span className="text-[10px] bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full font-bold">å…¨åˆ°è²¨</span>}
                                                                    </h4>
                                                                    <div className="text-[10px] text-slate-500 font-bold mt-1 flex flex-col">
                                                                        <span>å…± {cust.totalQty} ä»¶å•†å“ Â· å·²é… {cust.allocatedQty} ä»¶</span>
                                                                        <span className="text-slate-400">å…± {cust.totalItemsCount} é … Â· å·²åˆ° {cust.arrivedItemsCount} é …</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className="text-right">
                                                                <ChevronRight className="text-slate-300" size={20} />
                                                            </div>
                                                </div>
                                                <div className="h-1.5 w-full bg-slate-50">
                                                    <div 
                                                        className={`h-full transition-all duration-500 ${cust.isFullyArrived ? 'bg-emerald-500' : 'bg-indigo-500'}`} 
                                                        style={{ width: `${progress}%` }}
                                                    ></div>
                                                </div>
                                            </div>
                                            );
                                        })
                                    )}
                                    </div>
                                </div>

                                {/* å€å¡ŠäºŒï¼šå·²å‡ºè²¨ç´€éŒ„ */}
                                <div>
                                    <div className="flex items-center gap-2 mb-3 px-2 mt-6 opacity-60">
                                        <PackageCheck size={20} className="text-slate-500" />
                                        <h3 className="text-lg font-black text-slate-500">âœ… å·²å‡ºè²¨ç´€éŒ„</h3>
                                    </div>
                                    <div className="space-y-4 opacity-70">
                                        {filteredShippedArrivals.length === 0 ? (
                                            <div className="text-center p-4 text-slate-300 text-xs">å°šç„¡å‡ºè²¨ç´€éŒ„</div>
                                        ) : (
                                            filteredShippedArrivals.map((cust, idx) => (
                                                <div key={idx} onClick={() => setSelectedArrivalCustomer(cust)} className="bg-slate-50 rounded-3xl p-4 border border-slate-100 cursor-pointer flex justify-between items-center">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center font-bold text-sm text-gray-500">
                                                            {cust.name.charAt(0)}
                                                        </div>
                                                        <div>
                                                            <h4 className="font-bold text-slate-600">{cust.name}</h4>
                                                            <p className="text-[10px] text-slate-400">å…± {cust.totalQty} ä»¶å•†å“</p>
                                                        </div>
                                                    </div>
                                                    <span className="text-xs bg-gray-200 text-gray-500 px-2 py-1 rounded-full font-bold">å·²å‡ºè²¨</span>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>

                            </div>
                        )}
                    </main>

                    {/* Footer Quick Action */}
                    <div className="fixed bottom-6 right-6 flex flex-col gap-4 z-[100]">
                        <button 
                            onClick={() => setShowPurchaseList(true)}
                            className="w-12 h-12 bg-slate-800 text-white rounded-full shadow-xl shadow-slate-300 flex items-center justify-center active:scale-95 transition-all"
                        >
                            <Truck size={20} />
                            {stats.outOfStockCount > 0 && <span className="absolute -top-1 -right-1 bg-rose-500 text-white w-5 h-5 rounded-full text-[10px] flex items-center justify-center border-2 border-white">{stats.outOfStockCount}</span>}
                        </button>
                        <button 
                            onClick={() => setShowProxyOrder(true)}
                            className="w-16 h-16 bg-indigo-600 text-white rounded-full shadow-2xl shadow-indigo-300 flex items-center justify-center active:scale-95 transition-all"
                        >
                            <Plus size={32} />
                        </button>
                    </div>

                    {/* Modal: åˆ°è²¨æª¢æ ¸ (Arrival Check) - ä¿®æ”¹ç‚ºç·¨è¼¯åˆ°è²¨æ•¸é‡ */}
                    {selectedArrivalCustomer && currentSelectedArrivalCustomer && (
                         <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-end md:items-center justify-center z-[150] p-0 md:p-4 animate-in">
                            <div className="bg-white rounded-t-[30px] md:rounded-[30px] w-full max-w-md shadow-2xl h-[85vh] flex flex-col">
                                <div className="p-6 bg-slate-800 text-white shrink-0 relative rounded-t-[30px]">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h3 className="text-xl font-black">{currentSelectedArrivalCustomer.name}</h3>
                                            <p className="text-slate-400 text-xs font-bold mt-1">
                                                {currentSelectedArrivalCustomer.source === 'shipped' ? 'å·²å‡ºè²¨è¨‚å–®æ˜ç´°' : 'åˆ°è²¨æª¢æ ¸æ¸…å–® (å‹¾é¸å³é…è²¨)'}
                                            </p>
                                        </div>
                                        <button onClick={() => setSelectedArrivalCustomer(null)} className="bg-white/10 p-2 rounded-full text-white"><X size={18}/></button>
                                    </div>
                                    
                                    {/* ç‹€æ…‹åˆ—èˆ‡æ“ä½œ */}
                                    <div className="mt-4 flex gap-2">
                                        <div className="flex-1 bg-white/10 rounded-xl p-3 flex justify-between items-center">
                                            <div className="text-xs text-slate-300">é…è²¨é€²åº¦</div>
                                            <div className="font-bold text-white">
                                                {currentSelectedArrivalCustomer.arrivedItemsCount} / {currentSelectedArrivalCustomer.totalItemsCount}
                                            </div>
                                        </div>
                                        {/* å–æ¶ˆå‡ºè²¨/å›å¾©æŒ‰éˆ• */}
                                        {currentSelectedArrivalCustomer.source === 'shipped' && (
                                            <button 
                                                onClick={() => handleUnshipCustomer(currentSelectedArrivalCustomer.name)}
                                                className="bg-amber-500 text-white px-3 rounded-xl font-bold text-xs flex items-center gap-1 shadow-lg"
                                            >
                                                <Undo2 size={14} /> å›å¾©æœªå‡ºè²¨
                                            </button>
                                        )}
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto p-4 space-y-2 no-scrollbar pb-20">
                                    {currentSelectedArrivalCustomer.items.map((item, idx) => {
                                        const isFullyArrivedItem = (item.allocatedQty || 0) >= item.qty;
                                        // æª¢æŸ¥æ˜¯å¦å·²å‡ºè²¨ç‹€æ…‹ (ç¦æ­¢ç·¨è¼¯)
                                        const isShipped = currentSelectedArrivalCustomer.source === 'shipped';

                                        return (
                                            <div 
                                                key={idx} 
                                                className={`flex justify-between items-center p-3 border rounded-2xl shadow-sm transition-all ${isShipped ? 'bg-gray-100 border-gray-200 opacity-70' : isFullyArrivedItem ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-slate-100'}`}
                                            >
                                                <div className="flex items-center gap-3 flex-1 min-w-0">
                                                    {/* å…¨åˆ°è²¨ä¸€éµæŒ‰éˆ• (å·²å‡ºè²¨å‰‡éš±è—æˆ–ä¸å¯é») */}
                                                    {!isShipped && (
                                                        <div 
                                                            className={`w-6 h-6 rounded-lg flex items-center justify-center border transition-all shrink-0 cursor-pointer ${isFullyArrivedItem ? 'bg-emerald-500 border-emerald-500 text-white' : 'bg-white border-slate-300 text-transparent'}`}
                                                            onClick={() => toggleAllocation(item.orderId, item.productId, item.allocatedQty || 0, item.qty)}
                                                        >
                                                            <CheckSquare size={14} />
                                                        </div>
                                                    )}
                                                    {isShipped && (
                                                        <div className="w-6 h-6 rounded-lg flex items-center justify-center bg-gray-300 text-white shrink-0">
                                                            <PackageCheck size={14} />
                                                        </div>
                                                    )}

                                                    <div className="min-w-0">
                                                        <div className="flex items-center gap-2 flex-wrap">
                                                            <span className="font-bold text-slate-700 text-sm">{item.name}</span>
                                                            <span className="text-[10px] bg-white border border-slate-200 text-slate-500 px-1.5 py-0.5 rounded whitespace-nowrap">{item.variant}</span>
                                                        </div>
                                                        <span className={`text-[10px] font-bold ${isShipped ? 'text-gray-500' : isFullyArrivedItem ? 'text-emerald-600' : 'text-slate-400'}`}>
                                                            {isShipped ? 'å·²å‡ºè²¨' : isFullyArrivedItem ? 'å·²é…è²¨' : 'å¾…æ’å–®'}
                                                        </span>
                                                    </div>
                                                </div>

                                                {/* åˆ°è²¨æ•¸é‡ç·¨è¼¯å€å¡Š (å·²å‡ºè²¨ä¸å¯ç·¨è¼¯) */}
                                                {!isShipped && (
                                                    <div className="flex items-center gap-2 pl-2">
                                                        <div className="flex items-center gap-1 bg-white border border-slate-200 rounded-lg px-2 py-1 shadow-sm">
                                                            <span className="text-xs text-slate-400 font-bold">é…:</span>
                                                            {editingAllocatedQtyId === `${item.orderId}-${item.productId}` ? (
                                                                <input 
                                                                    autoFocus
                                                                    type="number"
                                                                    className="w-10 text-center font-black text-lg p-0 outline-none border-b-2 border-indigo-500 text-indigo-600"
                                                                    defaultValue={item.allocatedQty || 0}
                                                                    onBlur={(e) => handleUpdateAllocatedQty(item.orderId, item.productId, e.target.value)}
                                                                    onKeyDown={(e) => {
                                                                        if (e.key === 'Enter') handleUpdateAllocatedQty(item.orderId, item.productId, e.target.value);
                                                                    }}
                                                                    onClick={(e) => e.stopPropagation()} 
                                                                />
                                                            ) : (
                                                                <span 
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        setEditingAllocatedQtyId(`${item.orderId}-${item.productId}`);
                                                                    }}
                                                                    className={`font-black text-lg cursor-pointer border-b-2 border-transparent hover:border-indigo-300 ${isFullyArrivedItem ? 'text-emerald-600' : 'text-indigo-600'}`}
                                                                >
                                                                    {item.allocatedQty || 0}
                                                                </span>
                                                            )}
                                                        </div>
                                                        <span className="text-xs text-slate-400 font-bold">/ è¨‚: {item.qty}</span>
                                                    </div>
                                                )}
                                                
                                                {isShipped && (
                                                     <div className="flex items-center gap-2 pl-2">
                                                         <span className="font-bold text-gray-500">{item.allocatedQty} / {item.qty}</span>
                                                     </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal: ä»£å®¢åŠ å–® ... */}
                    {/* ... (åŒä¸Šï¼Œä¿æŒä¸è®Š) ... */}
                    {/* Modal: ç‡Ÿæ”¶æ¸…å–® ... */}
                    {/* ... (åŒä¸Šï¼Œä¿æŒä¸è®Š) ... */}
                    {/* Modal: å•†å“è©³æƒ… ... */}
                    {/* ... (åŒä¸Šï¼Œä¿æŒä¸è®Š) ... */}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
