<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cuibo WMS æ™ºæ…§é€£ç·šå€‰åº«ç®¡ç†ç³»çµ±</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ Babel ç”¨æ–¼è§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. è¼‰å…¥å¤–éƒ¨å¥—ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- 4. è¨­å®šè‡ªå®šç¾©é¡è‰² (Tailwind Config) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cream: {
                            50: '#FFFBF5',  // è¼¸å…¥æ¡†/æ¥µæ·ºåº•
                            100: '#FCF4E9', // å…¨åŸŸä¸»èƒŒæ™¯
                            200: '#EBE0D6', // é‚Šæ¡†/åˆ†éš”ç·š
                            300: '#D3C5BC', // å¤±æ•ˆæ–‡å­—
                        },
                        latte: {
                            400: '#B5A496', // è¼”åŠ©æ–‡å­—
                            500: '#957E6B', // ä¸»å¼·èª¿è‰² (Brand Color)
                            600: '#8C6A5D', // æ·±ä¸€é»çš„å¼·èª¿
                            800: '#5E4B41', // ä¸»è¦æ–‡å­— (æ·±å’–å•¡)
                            900: '#4A3B32', // æ¥µæ·±è‰²
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -5px rgba(149, 126, 107, 0.1)',
                        'inner-soft': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.02)',
                    }
                }
            }
        }
    </script>

    <style>
        /* å…¨åŸŸæ¨£å¼è¨­å®š */
        body {
            background-color: #FCF4E9; /* ä¸»è‰²èª¿ */
            color: #5E4B41; /* ä¸»è¦æ–‡å­—é¡è‰² */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }

        /* éš±è—å·è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* å‹•ç•« */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* ç§»é™¤é»æ“Šé«˜äº® */
        * { -webkit-tap-highlight-color: transparent; }

        /* --- åœ–ç‰‡åŒ¯å‡ºå°ˆç”¨æ¨£å¼ (éš±è—å€å¡Š) --- */
        #hidden-receipt-container {
            position: fixed;
            top: 0;
            left: -9999px;
            width: 500px;
            background-color: #FCF4E9; /* ç¢ºä¿åŒ¯å‡ºåœ–ç‰‡èƒŒæ™¯è‰²ä¸€è‡´ */
            z-index: -100;
            padding: 40px;
            box-sizing: border-box;
            font-family: sans-serif;
            color: #5E4B41;
            line-height: 1.5;
        }
        
        .receipt-card {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(149, 126, 107, 0.15);
            border: 1px solid #EBE0D6;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed #D3C5BC;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        .receipt-title { font-size: 24px; font-weight: 900; margin-bottom: 5px; color: #5E4B41; letter-spacing: 1px; }
        .receipt-subtitle { font-size: 14px; color: #957E6B; }
        
        .receipt-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 700;
            color: #8C6A5D;
        }

        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .receipt-table th { text-align: left; font-size: 12px; color: #957E6B; padding-bottom: 8px; border-bottom: 1px solid #EBE0D6; }
        .receipt-table td { padding: 12px 0; border-bottom: 1px dashed #EBE0D6; vertical-align: top; }
        
        .item-name { font-size: 14px; font-weight: 700; color: #5E4B41; display: block; margin-bottom: 2px; }
        .item-spec { font-size: 12px; color: #B5A496; }
        
        .receipt-summary {
            background-color: #FFFBF5;
            padding: 20px;
            border-radius: 12px;
            text-align: right;
            border: 1px solid #EBE0D6;
        }
        .summary-total { display: flex; justify-content: space-between; font-size: 20px; font-weight: 900; color: #957E6B; margin-top: 10px; border-top: 1px solid #EBE0D6; padding-top: 10px; }
        
        .receipt-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: #B5A496;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useRef } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';
        import { 
            LayoutDashboard, Package, ShoppingCart, Users, Zap, Plus, ArrowRight, AlertCircle, 
            CheckCircle2, Combine, Split, MessageCircle, Truck, DollarSign, Search, Filter, 
            X, ChevronRight, ChevronUp, ClipboardList, User, ShoppingBag, ListOrdered, Tag, 
            Layers, Archive, CheckSquare, Square, Trash2, Edit, Save, Copy, CreditCard, 
            RotateCcw, Minus, TrendingUp, Wallet, BoxSelect, Undo2, PackageCheck, FileSpreadsheet,
            Image as ImageIcon, Download, Loader2, Upload, Cloud, Settings, UploadCloud, DownloadCloud, FileJson
        } from 'https://esm.sh/lucide-react@0.263.1?dev';

        const App = () => {
            // --- æ ¸å¿ƒé‚è¼¯ä¿æŒä¸è®Š ---
            
            // 1. è³‡æ–™è®€å–èˆ‡ç‹€æ…‹
            const loadLocal = (key, def) => {
                const saved = localStorage.getItem(key);
                return saved ? JSON.parse(saved) : def;
            };

            const [products, setProducts] = useState(() => loadLocal('smartwms_products', [
                { id: 'p1', name: 'æ—¥æœ¬æ¥µè‡´å¹é¢¨æ©Ÿ', variant: 'çç ç™½', spot: 2, price: 3200, tierMinQty: 0, tierPrice: 0 },
                { id: 'p2', name: 'æ—¥æœ¬æ¥µè‡´å¹é¢¨æ©Ÿ', variant: 'æ¶ˆå…‰é»‘', spot: 3, price: 3200, tierMinQty: 0, tierPrice: 0 },
                { id: 'p3', name: 'æ³•å¼é»‘å·§å…‹åŠ›ç›’', variant: 'å–®ä¸€æ¬¾å¼', spot: 20, price: 450, tierMinQty: 0, tierPrice: 0 },
            ]));
            const [orders, setOrders] = useState(() => loadLocal('smartwms_orders', [
                { id: 'o1', customer: 'æ—å°ç¾', total: 6400, paid: 0, status: 'éƒ¨åˆ†åˆ°è²¨', items: [{ productId: 'p1', name: 'æ—¥æœ¬æ¥µè‡´å¹é¢¨æ©Ÿ', variant: 'çç ç™½', qty: 2, allocatedQty: 1, price: 3200 }], debt: 0, unclaimed: 1 },
            ]));
            
            const [apiUrl, setApiUrl] = useState(() => localStorage.getItem('smartwms_api_url') || '');

            // Local Storage Persistence
            useEffect(() => { localStorage.setItem('smartwms_products', JSON.stringify(products)); }, [products]);
            useEffect(() => { localStorage.setItem('smartwms_orders', JSON.stringify(orders)); }, [orders]);
            useEffect(() => { localStorage.setItem('smartwms_api_url', apiUrl); }, [apiUrl]);

            // UI States
            const [activeTab, setActiveTab] = useState('products');
            const [showProxyOrder, setShowProxyOrder] = useState(false);
            const [showPurchaseList, setShowPurchaseList] = useState(false);
            const [showRevenueList, setShowRevenueList] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            
            const [selectedGroupName, setSelectedGroupName] = useState(null); 
            const [selectedCustomerDetail, setSelectedCustomerDetail] = useState(null);
            const [selectedArrivalCustomer, setSelectedArrivalCustomer] = useState(null); 
            
            const [isEditingProduct, setIsEditingProduct] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            
            const [editingOrderQtyId, setEditingOrderQtyId] = useState(null);
            const [editingAllocatedQtyId, setEditingAllocatedQtyId] = useState(null);
            const [editingPurchaseQtyId, setEditingPurchaseQtyId] = useState(null);
            
            const [exportTargetCustomer, setExportTargetCustomer] = useState(null); 
            
            // æ‰¹æ¬¡ä¸‹è¼‰ç‹€æ…‹
            const [isBatchMode, setIsBatchMode] = useState(false);
            const [batchSelection, setBatchSelection] = useState(new Set());
            const [isProcessingBatch, setIsProcessingBatch] = useState(false);

            const [proxyForm, setProxyForm] = useState({
                productName: '', variant: '', price: '', customer: '', qty: 1, purchasedQty: 0
            });

            const [notification, setNotification] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            
            const fileInputRef = useRef(null);

            const notify = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            // 2. æ•¸æ“šè¨ˆç®— (Data Calculations)
            const productsWithStats = useMemo(() => {
                return products.map(p => {
                    let allocated = 0; let confirmed = 0; 
                    orders.forEach(o => {
                        if (o.items) {
                            o.items.forEach(item => {
                                if (item.productId === p.id) {
                                    allocated += (item.qty || 0);
                                    confirmed += (item.allocatedQty || 0);
                                }
                            });
                        }
                    });
                    const pending = allocated - confirmed;
                    const totalOwned = (p.spot || 0) + confirmed;
                    const shortage = Math.max(0, allocated - totalOwned);
                    return { ...p, allocated, confirmed, pending, shortage };
                });
            }, [products, orders]);

            const customerList = useMemo(() => {
                const map = {};
                orders.forEach(o => {
                    if (!map[o.customer]) {
                        map[o.customer] = { id: o.customer, name: o.customer, totalSpent: 0, totalPaid: o.paid || 0, orderCount: 0, debt: 0, items: [], rawItems: [] };
                    } else { map[o.customer].totalPaid += (o.paid || 0); }
                    map[o.customer].orderCount += 1;
                    if (o.items) o.items.forEach(item => map[o.customer].rawItems.push({ ...item, orderId: o.id }));
                });

                Object.values(map).forEach(cust => {
                    const nameCounts = {};
                    cust.rawItems.forEach(item => {
                        const productInfo = products.find(p => p.id === item.productId);
                        const productName = productInfo ? productInfo.name : item.name;
                        if (!nameCounts[productName]) nameCounts[productName] = 0;
                        nameCounts[productName] += item.qty;
                    });
                    cust.rawItems.forEach(item => {
                        const productInfo = products.find(p => p.id === item.productId);
                        let finalPrice = item.price;
                        let originalPrice = item.price;
                        let tierMinQty = 0;
                        let tierPrice = 0;
                        if (productInfo) {
                            originalPrice = productInfo.price;
                            tierMinQty = productInfo.tierMinQty;
                            tierPrice = productInfo.tierPrice;
                            const pName = productInfo.name;
                            if (tierMinQty > 0 && tierPrice > 0 && nameCounts[pName] >= tierMinQty) {
                                finalPrice = tierPrice;
                            }
                        }
                        const itemTotal = (item.qty || 0) * finalPrice;
                        cust.items.push({
                            ...item, finalPrice, isDiscounted: finalPrice < originalPrice, itemTotal, isAllocated: (item.allocatedQty || 0) >= item.qty
                        });
                        cust.totalSpent += itemTotal;
                    });
                    cust.debt = Math.max(0, cust.totalSpent - cust.totalPaid);
                });
                return Object.values(map);
            }, [orders, products]);

            const stats = useMemo(() => {
                const totalRevenue = customerList.reduce((acc, curr) => acc + curr.totalSpent, 0); 
                let shortageItemCount = 0; let totalShortageQty = 0;  
                productsWithStats.forEach(p => { if (p.shortage > 0) { shortageItemCount += 1; totalShortageQty += p.shortage; } });
                return { totalRevenue, shortageItemCount, totalShortageQty };
            }, [productsWithStats, customerList]); 

            const arrivalCustomers = useMemo(() => {
                return customerList.map(cust => {
                    const totalItems = cust.items.length;
                    const fullItems = cust.items.filter(i => (i.allocatedQty || 0) >= i.qty).length;
                    const totalQty = cust.items.reduce((s, i) => s + (i.qty || 0), 0);
                    const allocatedQty = cust.items.reduce((s, i) => s + (i.allocatedQty || 0), 0);
                    const isFullyArrived = totalItems > 0 && totalItems === fullItems;
                    return { ...cust, totalItems, fullItems, totalQty, allocatedQty, isFullyArrived };
                }).sort((a,b) => (a.isFullyArrived === b.isFullyArrived ? 0 : a.isFullyArrived ? -1 : 1));
            }, [customerList]);

            const { pendingArrivals, shippedArrivals } = useMemo(() => {
                const pending = [], shipped = [];
                arrivalCustomers.forEach(c => {
                    const hasPending = orders.some(o => o.customer === c.name && o.status !== 'å·²å‡ºè²¨');
                    if (hasPending) pending.push(c);
                    else if (orders.some(o => o.customer === c.name)) shipped.push(c);
                });
                return { pendingArrivals: pending, shippedArrivals: shipped };
            }, [arrivalCustomers, orders]);

            const groupedProducts = useMemo(() => {
                 const groups = {};
                 products.forEach(p => {
                     if(!groups[p.name]) groups[p.name] = { ...p, variants: [], totalAllocated:0, totalConfirmed:0, totalSpot:0 };
                     groups[p.name].variants.push(p);
                     const stats = productsWithStats.find(ps => ps.id === p.id);
                     if(stats) {
                         groups[p.name].totalAllocated += stats.allocated;
                         groups[p.name].totalConfirmed += stats.confirmed;
                         groups[p.name].totalSpot += (p.spot || 0);
                     }
                 });
                 return Object.values(groups);
            }, [products, productsWithStats]);
            
            const getGroupAllocations = (groupName) => {
                 let allocations = [];
                 orders.forEach(o => {
                     o.items.forEach(item => {
                         if(item.name === groupName) {
                            allocations.push({
                                orderId: o.id,
                                customer: o.customer,
                                productId: item.productId,
                                variant: item.variant,
                                qty: item.qty,
                                allocatedQty: item.allocatedQty || 0,
                                isAllocated: (item.allocatedQty || 0) >= item.qty
                            });
                         }
                     });
                 });
                 return allocations;
            };

            const purchaseList = useMemo(() => productsWithStats.filter(p => p.shortage > 0).map(p => ({ ...p })), [productsWithStats]);
            const revenueCustomers = useMemo(() => customerList.filter(c => c.totalSpent > 0).sort((a, b) => b.totalSpent - a.totalSpent), [customerList]);

            const filteredGroupedProducts = groupedProducts.filter(g => g.name.includes(searchQuery));
            const filteredCustomers = customerList.filter(c => c.name.includes(searchQuery));
            const filteredPendingArrivals = pendingArrivals.filter(c => c.name.includes(searchQuery));
            const filteredShippedArrivals = shippedArrivals.filter(c => c.name.includes(searchQuery));
            
            // --- å„ªåŒ–å¾Œçš„æ¬¾å¼å»ºè­°é‚è¼¯ (Smart Variants) ---
            const availableVariants = useMemo(() => {
                const exactMatch = products.filter(p => p.name === proxyForm.productName);
                if (exactMatch.length > 0) {
                    return [...new Set(exactMatch.map(p => p.variant))];
                }
                return [...new Set(products.map(p => p.variant))];
            }, [products, proxyForm.productName]);

            // 3. äº‹ä»¶è™•ç† (Handlers)
            const handleExportBackup = () => {
                const data = { products, orders, timestamp: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                saveAs(blob, `CuiboWMS_Backup_${new Date().toISOString().slice(0,10)}.json`);
                notify("å‚™ä»½æª”å·²ä¸‹è¼‰");
            };

            const handleImportBackup = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.products && data.orders) {
                            if(confirm(`ç¢ºå®šè¦é‚„åŸå‚™ä»½è³‡æ–™å—ï¼Ÿ\nå‚™ä»½æ™‚é–“: ${data.timestamp || 'æœªçŸ¥'}\nç›®å‰çš„è³‡æ–™å°‡è¢«è¦†è“‹ï¼`)) {
                                setProducts(data.products);
                                setOrders(data.orders);
                                notify("è³‡æ–™é‚„åŸæˆåŠŸï¼");
                            }
                        } else {
                            notify("ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆæ ¼å¼");
                        }
                    } catch (err) { console.error(err); notify("è®€å–æª”æ¡ˆå¤±æ•—"); }
                    event.target.value = '';
                };
                reader.readAsText(file);
            };

            const handleExportToImage = async (customer) => {
                if (!customer) return;
                setExportTargetCustomer(customer);
                await new Promise(resolve => setTimeout(resolve, 100));
                const element = document.getElementById('hidden-receipt-container');
                if (!element) return;
                try {
                    const canvas = await html2canvas(element, { useCORS: true, backgroundColor: '#FCF4E9', scale: 2 });
                    const dataUrl = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = `${customer.name}_è¨‚å–®æ˜ç´°.png`;
                    link.href = dataUrl;
                    link.click();
                    notify("åœ–ç‰‡å·²åŒ¯å‡º");
                } catch (err) { console.error(err); notify("åŒ¯å‡ºå¤±æ•—"); } finally { setExportTargetCustomer(null); }
            };

            // è¤‡è£½è¨‚å–®æ–‡æ¡ˆå‡½å¼
            const handleCopyOrderText = (customer) => {
                if (!customer) return;
                let text = `è¦ªæ„›çš„ ${customer.name} æ‚¨å¥½ï¼Œ\n`;
                text += `æ‚¨æœ¬æ¬¡çš„é€£ç·šè³¼ç‰©æ˜ç´°å¦‚ä¸‹ï¼š\n\n`;
                
                customer.items.forEach(item => {
                    text += `${item.name} ${item.variant !== 'å–®ä¸€æ¬¾å¼' ? `(${item.variant})` : ''} x ${item.qty} $${item.itemTotal}\n`;
                });
                
                text += `----------------\n`;
                text += `æ¶ˆè²»ç¸½é¡ï¼š$${customer.totalSpent.toLocaleString()}\n\n`;
                
                text += `å¯ä»¥å…ˆå¹«æˆ‘æ­æ³¢å»å¯\n`;
                text += `æœ‰èª¤çš„è©±ï½è«‹è¶•å¿«è·Ÿæˆ‘èªªï¼\n`;
                text += `â‚ŠâŠ¹ è‹¥æ˜¯æ²’æœ‰æ¼æ‰çš„å•†å“ â‚ŠâŠ¹\n`;
                text += `å°±å¯ä»¥ç›´æ¥çµå¸³å›‰ï¼\n`;
                text += `ç¶²å€ï¼šï¼ˆé€™è£¡ç•™çµ¦æˆ‘è‡ªå·±è¼¸å…¥ç¶²å€ï¼‰\n`;
                text += `æ‰¾åˆ°è‡ªå·±åå­—å¾Œå®Œæˆä¸‹å–®å°±å¯ä»¥åš•\n`;
                text += `ğ™š æ”¶åˆ°æ‰€æœ‰é€£çµå¾Œè«‹ç›¡é€Ÿå®Œæˆä»˜æ¬¾\n`;
                text += `   ä¸è¦è€½èª¤åˆ°æœ€ä½³çš„è³å‘³æœŸé™å”·\n\n`;
                
                text += `âš p.s. å‰ä¸€æ¬¡é€£ç·šæœ‰é–‹ç®±åˆ†äº«çš„æœ‹å‹~\n`;
                text += `ä¸‹å–®å¾Œè«‹å¹«æˆ‘å‚™è¨»ä¸€ä¸‹ï¼šé–‹ç®±ç¦®\n`;
                text += `ğ­ğ¡ğšğ§ğ¤ ğ²ğ¨ğ® (â€â€¢ ÖŠ â€¢â€)à©­`;
                
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    notify("è¨‚å–®æ˜ç´°å·²è¤‡è£½");
                } catch (err) {
                    console.error('Copy failed', err);
                    notify("è¤‡è£½å¤±æ•—");
                }
                document.body.removeChild(textArea);
            };

            // æ‰¹æ¬¡åŒ¯å‡ºåœ–ç‰‡é‚è¼¯
            const handleBatchExportImages = async () => {
                if (batchSelection.size === 0) return notify("è«‹å…ˆå‹¾é¸é¡§å®¢");
                
                setIsProcessingBatch(true);
                const zip = new JSZip();
                
                try {
                    const targets = customerList.filter(c => batchSelection.has(c.name));
                    
                    for (const customer of targets) {
                        setExportTargetCustomer(customer);
                        await new Promise(r => setTimeout(r, 200));
                        
                        const element = document.getElementById('hidden-receipt-container');
                        if (element) {
                            const canvas = await html2canvas(element, { useCORS: true, backgroundColor: '#FCF4E9', scale: 2 });
                            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                            zip.file(`${customer.name}_è¨‚å–®æ˜ç´°.png`, blob);
                        }
                    }
                    
                    const content = await zip.generateAsync({type: "blob"});
                    saveAs(content, `CuiboWMS_Receipts_${new Date().toISOString().slice(0,10)}.zip`);
                    notify("æ‰¹æ¬¡åŒ¯å‡ºå®Œæˆ");
                    setBatchSelection(new Set());
                    setIsBatchMode(false);
                } catch (err) {
                    console.error(err);
                    notify("åŒ¯å‡ºå¤±æ•—");
                } finally {
                    setExportTargetCustomer(null);
                    setIsProcessingBatch(false);
                }
            };
            
            const handleClearData = () => {
                if (confirm("âš ï¸ è­¦å‘Šï¼šæ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡æ¸…ç©ºæ‰€æœ‰å•†å“èˆ‡è¨‚å–®ï¼Œè®“æ‚¨é‡æ–°é–‹å§‹ã€‚\nè«‹å‹™å¿…ç¢ºèªæ‚¨å·²å‚™ä»½ï¼")) {
                    setProducts([]);
                    setOrders([]);
                    notify("ç³»çµ±è³‡æ–™å·²å…¨éƒ¨æ¸…é™¤");
                }
            };

            const navigateTo = (tab) => { setActiveTab(tab); setSearchQuery(''); };
            
            const handleProxyProductChange = (e) => { 
                const name = e.target.value; 
                const existing = products.find(p => p.name === name); 
                setProxyForm(prev => ({ 
                    ...prev, 
                    productName: name, 
                    price: existing ? existing.price : prev.price 
                })); 
            };

            const handleProxyVariantChange = (e) => {
                const variant = e.target.value;
                setProxyForm(prev => {
                    const existing = products.find(p => p.name === prev.productName && p.variant === variant);
                    return {
                        ...prev,
                        variant: variant,
                        price: existing ? existing.price : prev.price
                    };
                });
            };

            const handleUpdateOrderQty = (oid, pid, v) => { const q = parseInt(v); if(isNaN(q)) return; setOrders(prev => prev.map(o => o.id===oid ? {...o, items: o.items.map(i=>i.productId===pid?{...i,qty:q}:i).filter(i=>i.qty>0)} : o).filter(o=>o.items.length>0)); setEditingOrderQtyId(null); };
            const handleUpdateAllocatedQty = (oid, pid, v) => { const q = parseInt(v); if(isNaN(q)) return; const order = orders.find(o=>o.id===oid); const item = order.items.find(i=>i.productId===pid); if(q>item.qty){ notify("ä¸å¯å¤§æ–¼å–Šå–®"); return; } const diff = q - (item.allocatedQty||0); setOrders(prev=>prev.map(o=>o.id===oid?{...o,items:o.items.map(i=>i.productId===pid?{...i,allocatedQty:q}:i)}:o)); setProducts(prev=>prev.map(p=>p.id===pid?{...p,spot:(p.spot||0)-diff}:p)); setEditingAllocatedQtyId(null); };
            const handleUpdatePurchaseQty = (pid, v) => { const q = parseInt(v); if(isNaN(q)) return; const p = productsWithStats.find(x=>x.id===pid); if(p){ const newSpot = p.allocated - p.confirmed - q; setProducts(prev=>prev.map(x=>x.id===pid?{...x,spot:newSpot}:x)); setEditingPurchaseQtyId(null); } };
            const handleDeleteOrderItem = (oid, pid) => { if(confirm("åˆªé™¤?")) { const order = orders.find(o=>o.id===oid); const item = order.items.find(i=>i.productId===pid); if(item?.allocatedQty>0){ setProducts(prev=>prev.map(p=>p.id===pid?{...p,spot:(p.spot||0)+item.allocatedQty}:p)); } setOrders(prev=>prev.map(o=>o.id===oid?{...o,items:o.items.filter(i=>i.productId!==pid)}:o).filter(o=>o.items.length>0)); } };
            
            const handleUpdateProductInfo = (pid, f, v) => { 
                const val = parseInt(v); 
                if(isNaN(val)) return; 
                const t = products.find(p=>p.id===pid); 
                setProducts(prev=>prev.map(p=> 
                    (f.startsWith('tier') && p.name===t.name) || p.id===pid ? {...p, [f]:val} : p
                )); 
            };
            
            const handleDeleteProduct = (pid) => { if(confirm("åˆªé™¤æ¬¾å¼?")) setProducts(prev=>prev.filter(p=>p.id!==pid)); };
            const toggleAllocation = (oid, pid, curr, total) => { const next = curr >= total ? 0 : total; const diff = next - curr; const p = products.find(x=>x.id===pid); if(diff>0&&(p.spot||0)<diff) notify("ç¾è²¨ä¸è¶³"); setOrders(prev=>prev.map(o=>o.id===oid?{...o,items:o.items.map(i=>i.productId===pid?{...i,allocatedQty:next}:i)}:o)); setProducts(prev=>prev.map(p=>p.id===pid?{...p,spot:(p.spot||0)-diff}:p)); };
            const handleShipCustomer = (name) => { if(confirm("ç¢ºèªå‡ºè²¨?")) { setOrders(prev=>prev.map(o=>o.customer===name&&o.status!=='å·²å‡ºè²¨'?{...o,status:'å·²å‡ºè²¨'}:o)); setSelectedArrivalCustomer(null); } };
            const handleUnshipCustomer = (name) => { if(confirm("å›å¾©æœªå‡ºè²¨?")) { setOrders(prev=>prev.map(o=>o.customer===name&&o.status==='å·²å‡ºè²¨'?{...o,status:'å¾…çµå–®'}:o)); setSelectedArrivalCustomer(null); } };
            const handleAddOrder = () => { const { productName, variant, price, customer, qty, purchasedQty } = proxyForm; if (!productName || !price) { notify('è«‹å¡«å¯«å®Œæ•´'); return; } const q = parseInt(qty)||1; const pq = parseInt(purchasedQty)||0; const fp = parseInt(price)||0; let target = products.find(p=>p.name===productName && p.variant===variant); let pid = target?.id; if(!target) { pid = Date.now().toString(); setProducts(prev=>[...prev, {id:pid, name:productName, variant:variant||'å–®ä¸€æ¬¾å¼', price:fp, spot:pq, tierMinQty:0, tierPrice:0}]); } else if(pq>0) { setProducts(prev=>prev.map(p=>p.id===pid?{...p,spot:(p.spot||0)+pq}:p)); } if(customer) { setOrders(prev=>[...prev, { id: Date.now().toString()+Math.random(), customer, total:fp*q, paid:0, status:'å¾…çµå–®', items:[{productId:pid, name:productName, variant:variant||'å–®ä¸€æ¬¾å¼', qty:q, price:fp, allocatedQty:0}], debt:0, unclaimed:0 }]); notify("å·²åŠ å–®"); } else { notify("å·²å…¥åº«"); } setShowProxyOrder(false); setProxyForm({ productName: '', variant: '', price: '', customer: '', qty: 1, purchasedQty: 0 }); };
            
            const handleCloudUpload = async () => { if(!apiUrl) { notify("è«‹è¨­å®šAPI"); return; } setIsSyncing(true); try { await fetch(apiUrl, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({products,orders}) }); notify("ä¸Šå‚³æˆåŠŸ"); } catch(e) { notify("ä¸Šå‚³å¤±æ•—"); } finally { setIsSyncing(false); } };
            const handleCloudDownload = async () => { if(!apiUrl) { notify("è«‹è¨­å®šAPI"); return; } setIsSyncing(true); try { const res = await fetch(apiUrl); const data = await res.json(); if(data.products){ if(confirm("è¦†è“‹è³‡æ–™?")){ setProducts(data.products); setOrders(data.orders); notify("ä¸‹è¼‰æˆåŠŸ"); } } } catch(e) { notify("ä¸‹è¼‰å¤±æ•—"); } finally { setIsSyncing(false); } };
            
            const currentSelectedCustomer = selectedCustomerDetail ? customerList.find(c => c.name === selectedCustomerDetail.name) : null;
            const currentSelectedArrivalCustomer = selectedArrivalCustomer ? (selectedArrivalCustomer.source === 'shipped' ? shippedArrivals.find(c => c.name === selectedArrivalCustomer.name) : pendingArrivals.find(c => c.name === selectedArrivalCustomer.name)) || selectedArrivalCustomer : null;
            const isArrivalShipped = currentSelectedArrivalCustomer && !orders.some(o => o.customer === currentSelectedArrivalCustomer.name && o.status !== 'å·²å‡ºè²¨');

            // --- ä»‹é¢æ¸²æŸ“ (Render) ---
            return (
                <div className="min-h-screen pb-24">
                    {/* éš±è—çš„åŒ¯å‡ºç”¨æ”¶æ“š (Hidden Receipt for Image Generation) */}
                    {exportTargetCustomer && (
                        <div id="hidden-receipt-container">
                            <div className="receipt-card">
                                <div className="receipt-header">
                                    <div className="receipt-title">{exportTargetCustomer.name} çš„è³¼ç‰©æ¸…å–®</div>
                                    <div className="receipt-subtitle">{new Date().toLocaleString()}</div>
                                </div>
                                <div className="receipt-info">
                                    <span>è¨‚å–®ç·¨è™Ÿ: {Date.now().toString().slice(-6)}</span>
                                    <span>å®¢æˆ¶: {exportTargetCustomer.name}</span>
                                </div>
                                <table className="receipt-table">
                                    <thead>
                                        <tr>
                                            <th className="col-name">å•†å“ / è¦æ ¼</th>
                                            <th className="col-price">å–®åƒ¹</th>
                                            <th className="col-qty">æ•¸é‡</th>
                                            <th className="col-total">å°è¨ˆ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {exportTargetCustomer.items.map((item, idx) => (
                                            <tr key={idx}>
                                                <td className="col-name">
                                                    <span className="item-name">{item.name}</span>
                                                    <span className="item-spec">{item.variant}</span>
                                                </td>
                                                <td className="col-price">${item.finalPrice}</td>
                                                <td className="col-qty">{item.qty}</td>
                                                <td className="col-total">${item.itemTotal}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                <div className="receipt-summary">
                                    <div className="summary-row flex justify-between text-sm mb-1">
                                        <span>é …ç›®ç¸½æ•¸:</span>
                                        <span>{exportTargetCustomer.items.length} é …</span>
                                    </div>
                                    <div className="summary-total">
                                        <span>ç¸½é‡‘é¡:</span>
                                        <span>${exportTargetCustomer.totalSpent.toLocaleString()}</span>
                                    </div>
                                </div>
                                <div className="receipt-footer">
                                    æ„Ÿè¬æ‚¨çš„è³¼è²·ï¼è«‹æ–¼æœŸé™å…§å®ŒæˆåŒ¯æ¬¾ã€‚
                                </div>
                            </div>
                        </div>
                    )}

                    {/* é€šçŸ¥ Toast */}
                    {notification && <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[300] bg-latte-800 text-cream-50 px-6 py-3 rounded-2xl shadow-xl flex items-center gap-2 animate-bounce border border-latte-600"><CheckCircle2 size={18} className="text-cream-200" />{notification}</div>}

                    {/* Header (é ‚éƒ¨æ¨™é¡Œ) */}
                    <div className="bg-latte-500 text-cream-50 p-4 shadow-sm sticky top-0 z-50 flex justify-between items-center max-w-2xl mx-auto shadow-latte-200">
                        <h1 className="text-xl font-bold flex items-center gap-2 cursor-pointer" onClick={() => navigateTo('dashboard')}><Zap className="fill-cream-100 text-cream-100" /> Cuibo WMS</h1>
                    </div>

                    {/* Nav (åˆ†é å°èˆª) */}
                    <div className="bg-white/90 backdrop-blur-sm border-b border-cream-200 sticky top-[60px] z-40">
                         <div className="flex max-w-2xl mx-auto overflow-x-auto no-scrollbar">
                            {[{id:'products',l:'å•†å“åˆ—è¡¨',i:ShoppingBag},{id:'dashboard',l:'ç‹€æ…‹',i:LayoutDashboard},{id:'customers',l:'é¡§å®¢åˆ—è¡¨',i:Users},{id:'arrivals',l:'åˆ°è²¨ç®¡ç†',i:BoxSelect}].map(t => (
                                <button key={t.id} onClick={() => {setActiveTab(t.id); setSearchQuery('')}} className={`flex-1 py-4 px-2 flex flex-col items-center gap-1 text-[11px] font-bold transition-all ${activeTab === t.id ? 'text-latte-500 border-b-2 border-latte-500 bg-cream-50' : 'text-latte-300'}`}><t.i size={20}/>{t.l}</button>
                            ))}
                        </div>
                    </div>

                    {/* Main Content (ä¸»è¦å…§å®¹å€) */}
                    <main className="max-w-2xl mx-auto p-4 space-y-5">
                        {/* æœå°‹åˆ— */}
                        {activeTab !== 'dashboard' && <div className="relative"><input type="text" placeholder="æœå°‹å•†å“ã€é¡§å®¢..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full bg-cream-50 text-latte-800 rounded-2xl p-4 pl-12 shadow-inner-soft outline-none border border-transparent focus:border-latte-300 transition-all placeholder:text-latte-300" /><Search size={18} className="absolute left-4 top-4 text-latte-300" /></div>}
                        
                        {/* å´é‚Šå·¥å…·åˆ— (Sidebar Backup Buttons) - ä¿æŒæŒ‡å®šé¡è‰²ä½†å„ªåŒ–å¤–è§€ */}
                        <div className="flex gap-2 overflow-x-auto pb-2 px-1 scrollbar-hide">
                             <button onClick={()=>setShowSettings(true)} className="bg-slate-200 text-slate-700 px-4 py-2 rounded-xl text-xs flex items-center gap-1 shrink-0 font-bold shadow-sm active:scale-95 transition-transform"><Settings size={14}/> API è¨­å®š</button>
                             <button onClick={handleCloudUpload} className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs flex items-center gap-1 shrink-0 font-bold shadow-sm shadow-indigo-200 active:scale-95 transition-transform"><Cloud size={14}/> ä¸Šå‚³é›²ç«¯</button>
                             <button onClick={handleCloudDownload} className="bg-emerald-600 text-white px-4 py-2 rounded-xl text-xs flex items-center gap-1 shrink-0 font-bold shadow-sm shadow-emerald-200 active:scale-95 transition-transform"><Download size={14}/> é›²ç«¯åŒæ­¥</button>
                             <div className="w-px bg-latte-300 mx-1 shrink-0 h-6 self-center opacity-50"></div>
                             <button onClick={handleExportBackup} className="bg-slate-700 text-white px-4 py-2 rounded-xl text-xs flex items-center gap-1 shrink-0 font-bold shadow-sm active:scale-95 transition-transform"><Download size={14}/> å‚™ä»½æª”æ¡ˆ</button>
                             <label className="bg-slate-200 text-slate-700 px-4 py-2 rounded-xl text-xs flex items-center gap-1 cursor-pointer shrink-0 font-bold shadow-sm active:scale-95 transition-transform">
                                <Upload size={14}/> é‚„åŸæª”æ¡ˆ
                                <input type="file" ref={fileInputRef} onChange={handleImportBackup} accept=".json" className="hidden" />
                             </label>
                             <div className="w-px bg-latte-300 mx-1 shrink-0 h-6 self-center opacity-50"></div>
                             <button onClick={handleClearData} className="bg-rose-600 text-white px-4 py-2 rounded-xl text-xs flex items-center gap-1 shrink-0 font-bold shadow-sm shadow-rose-200 active:scale-95 transition-transform"><Trash2 size={14}/> æ¸…é™¤é‡ç½®</button>
                        </div>

                        {/* Products List */}
                        {activeTab === 'products' && filteredGroupedProducts.map(g => (
                            <div key={g.name} onClick={() => setSelectedGroupName(g.name)} className="bg-white rounded-3xl p-5 shadow-soft border border-cream-200 flex justify-between items-center cursor-pointer active:scale-[0.99] transition-all hover:border-latte-200">
                                <div className="flex-1">
                                    <h4 className="font-bold text-latte-800 text-lg mb-2">{g.name}</h4>
                                    <div className="flex gap-2 text-xs text-latte-600 font-bold flex-wrap">
                                        <span className="bg-cream-100 px-2.5 py-1 rounded-lg border border-cream-200 text-latte-500">å–Š {g.totalAllocated}</span>
                                        <span className="bg-cream-100 px-2.5 py-1 rounded-lg border border-cream-200 text-latte-500">é… {g.totalConfirmed}</span>
                                        <span className="bg-cream-100 px-2.5 py-1 rounded-lg border border-cream-200 text-latte-500">ç¾ {g.totalSpot}</span>
                                        {/* é¡¯ç¤ºå„ªæƒ æ¨™ç±¤ */}
                                        {products.find(p => p.name === g.name)?.tierMinQty > 0 && products.find(p => p.name === g.name)?.tierPrice > 0 && (
                                            <span className="bg-[#AEC8DB] text-white px-2.5 py-1 rounded-lg border border-[#AEC8DB]">
                                                {products.find(p => p.name === g.name).tierMinQty}ä»¶${products.find(p => p.name === g.name).tierPrice}
                                            </span>
                                        )}
                                    </div>
                                </div>
                                <div className="w-10 h-10 rounded-full bg-cream-50 flex items-center justify-center text-latte-300"><ChevronRight size={20} /></div>
                            </div>
                        ))}

                        {/* Dashboard */}
                        {activeTab === 'dashboard' && (
                            <div className="grid grid-cols-2 gap-4 animate-in">
                                <div onClick={() => setShowPurchaseList(true)} className="bg-[#D98E73] text-white p-6 rounded-3xl shadow-lg shadow-[#D98E73]/30 relative overflow-hidden cursor-pointer group transition-transform active:scale-95">
                                    <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform"><ShoppingCart size={80}/></div>
                                    <p className="text-xs font-bold opacity-90 tracking-wider">éœ€è£œè²¨</p>
                                    <p className="text-4xl font-black mt-2">{stats.totalShortageQty} <span className="text-sm font-normal opacity-80">ä»¶</span></p>
                                </div>
                                <div onClick={() => setShowRevenueList(true)} className="bg-[#BF9E85] text-white p-6 rounded-3xl shadow-lg shadow-[#BF9E85]/30 relative overflow-hidden cursor-pointer group transition-transform active:scale-95">
                                    <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform"><DollarSign size={80}/></div>
                                    <p className="text-xs font-bold opacity-90 tracking-wider">ç¸½ç‡Ÿæ¥­é¡</p>
                                    <p className="text-4xl font-black mt-2"><span className="text-lg opacity-80">$</span>{stats.totalRevenue.toLocaleString()}</p>
                                </div>
                            </div>
                        )}

                        {/* Customers List with Batch Selection */}
                        {activeTab === 'customers' && (
                            <div className="space-y-2">
                                {/* æ‰¹æ¬¡æ¨¡å¼é–‹é—œèˆ‡æ¨™é¡Œ */}
                                <div className="flex justify-between items-center px-1 mb-2">
                                    <span className="text-xs font-bold text-latte-400">å…± {filteredCustomers.length} ä½é¡§å®¢</span>
                                     <button onClick={() => { setIsBatchMode(!isBatchMode); setBatchSelection(new Set()); }} className={`text-xs px-3 py-1.5 rounded-lg font-bold flex items-center gap-1 transition-colors ${isBatchMode ? 'bg-latte-500 text-white shadow-md' : 'bg-cream-100 text-latte-500 hover:bg-cream-200'}`}>
                                        <ImageIcon size={14}/> {isBatchMode ? 'å–æ¶ˆé¸å–' : 'æ‰¹æ¬¡å­˜åœ–'}
                                     </button>
                                </div>

                                {filteredCustomers.map(c => (
                                    <div key={c.name} 
                                        onClick={() => {
                                            if (isBatchMode) {
                                                const newSet = new Set(batchSelection);
                                                if (newSet.has(c.name)) newSet.delete(c.name);
                                                else newSet.add(c.name);
                                                setBatchSelection(newSet);
                                            } else {
                                                setSelectedCustomerDetail(c);
                                            }
                                        }} 
                                        className={`bg-white rounded-3xl p-5 shadow-soft border border-cream-200 flex justify-between items-center cursor-pointer mb-2 active:scale-[0.99] transition-all hover:border-latte-200 ${isBatchMode && batchSelection.has(c.name) ? 'ring-2 ring-latte-500 ring-offset-2' : ''}`}
                                    >
                                        <div className="flex items-center gap-4">
                                            {/* æ‰¹æ¬¡é¸å–å‹¾é¸æ¡† */}
                                            {isBatchMode && (
                                                <div className={`w-6 h-6 rounded-lg border flex items-center justify-center transition-colors ${batchSelection.has(c.name) ? 'bg-latte-500 border-latte-500 text-white' : 'border-cream-300 bg-cream-50'}`}>
                                                    {batchSelection.has(c.name) && <CheckSquare size={16}/>}
                                                </div>
                                            )}
                                            <div className="w-12 h-12 bg-cream-100 text-latte-600 rounded-full flex items-center justify-center font-bold border border-cream-200 text-lg shadow-sm">{c.name[0]}</div>
                                            <h4 className="font-bold text-latte-800 text-lg">{c.name}</h4>
                                        </div>
                                        <p className="font-black text-latte-500 text-lg">${c.totalSpent.toLocaleString()}</p>
                                    </div>
                                ))}

                                {/* æ‰¹æ¬¡æ“ä½œæ‡¸æµ®åˆ— */}
                                {isBatchMode && (
                                    <div className="fixed bottom-24 left-0 right-0 flex justify-center z-[90] animate-in pointer-events-none">
                                        <div className="bg-white/95 backdrop-blur border border-cream-200 shadow-xl rounded-full pl-6 pr-2 py-2 flex gap-4 items-center pointer-events-auto">
                                            <span className="font-bold text-latte-800 text-sm whitespace-nowrap">å·²é¸ {batchSelection.size} ä½</span>
                                            <div className="flex gap-1">
                                                 <button onClick={() => setBatchSelection(new Set(filteredCustomers.map(c => c.name)))} className="px-3 py-1.5 text-xs font-bold text-latte-500 hover:bg-cream-100 rounded-lg transition-colors">å…¨é¸</button>
                                                 <button onClick={handleBatchExportImages} disabled={batchSelection.size === 0 || isProcessingBatch} className="bg-[#AEC8DB] text-white px-4 py-1.5 rounded-xl font-bold text-xs shadow-sm shadow-[#AEC8DB]/30 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1 hover:brightness-105 active:scale-95 transition-all">
                                                    {isProcessingBatch ? <Loader2 className="animate-spin" size={14}/> : <Download size={14}/>} ä¸‹è¼‰åœ–ç‰‡
                                                 </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Arrivals List */}
                        {activeTab === 'arrivals' && (
                            <div className="space-y-6 pb-24">
                                <div>
                                    <h3 className="text-lg font-black text-latte-800 mb-4 px-2 flex gap-2 items-center"><BoxSelect size={20} className="text-latte-500"/> å¾…å‡ºè²¨ / åˆ°è²¨ä¸­</h3>
                                    {filteredPendingArrivals.map(c => (
                                        <div key={c.name} onClick={() => setSelectedArrivalCustomer({...c, source: 'pending'})} className="bg-white rounded-3xl shadow-soft border border-cream-200 p-5 mb-3 flex justify-between items-center cursor-pointer relative overflow-hidden active:scale-[0.99] transition-all">
                                            {c.isFullyArrived && <div className="absolute left-0 top-0 bottom-0 w-2 bg-emerald-400"></div>}
                                            <div className="flex items-center gap-4">
                                                <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg shadow-sm border border-transparent ${c.isFullyArrived ? 'bg-emerald-100 text-emerald-600 border-emerald-200' : 'bg-cream-100 text-latte-300'}`}>{c.name[0]}</div>
                                                <div>
                                                    <h4 className="font-bold text-latte-800 flex gap-2 items-center text-lg">{c.name} {c.isFullyArrived && <span className="text-[10px] bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full border border-emerald-200">å…¨åˆ°</span>}</h4>
                                                    <p className="text-xs text-latte-400 mt-1 font-bold">å…± {c.totalQty} ä»¶ Â· å·²é… {c.allocatedQty}</p>
                                                </div>
                                            </div>
                                            {c.isFullyArrived && <button onClick={(e) => { e.stopPropagation(); handleShipCustomer(c.name); }} className="bg-emerald-500 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-1 shadow-md shadow-emerald-200 animate-pulse hover:scale-105 transition-transform"><Truck size={16}/> ç¢ºèªå‡ºè²¨</button>}
                                        </div>
                                    ))}
                                </div>
                                <div className="opacity-70 grayscale-[0.5]">
                                    <h3 className="text-lg font-black text-latte-400 mb-4 px-2 flex gap-2 items-center"><PackageCheck size={20}/> å·²å‡ºè²¨ç´€éŒ„</h3>
                                    {filteredShippedArrivals.map(c => (
                                        <div key={c.name} onClick={() => setSelectedArrivalCustomer({...c, source: 'shipped'})} className="bg-cream-50 rounded-3xl p-4 border border-cream-200 mb-3 flex justify-between items-center cursor-pointer">
                                            <span className="font-bold text-latte-600">{c.name}</span>
                                            <span className="text-xs bg-latte-200 text-latte-600 px-3 py-1 rounded-full font-bold">å·²å‡ºè²¨</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* FAB (æ‡¸æµ®æ–°å¢æŒ‰éˆ•) */}
                    <div className="fixed bottom-8 right-6 z-[100]"><button onClick={() => setShowProxyOrder(true)} className="w-16 h-16 bg-[#AEC8DB] text-white rounded-full shadow-2xl shadow-[#AEC8DB]/40 flex items-center justify-center active:scale-95 transition-all hover:brightness-105 hover:-translate-y-1"><Plus size={32}/></button></div>

                    {/* --- Modals (å½ˆå‡ºè¦–çª—) --- */}
                    
                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[200] flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl w-full max-w-md p-6 space-y-4 shadow-2xl animate-in">
                                <h3 className="font-bold border-b border-cream-200 pb-3 text-latte-800 text-lg">API è¨­å®š</h3>
                                <p className="text-sm text-latte-500">è«‹è¼¸å…¥ Google Apps Script ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€</p>
                                <input type="text" placeholder="https://script.google.com/..." className="w-full bg-cream-50 border border-cream-200 p-4 rounded-xl focus:border-latte-400 outline-none text-latte-800 shadow-inner-soft" value={apiUrl} onChange={e=>setApiUrl(e.target.value)}/>
                                <div className="flex gap-3 pt-2">
                                    <button onClick={()=>setShowSettings(false)} className="flex-1 bg-[#AEC8DB] text-white py-3 rounded-xl font-bold shadow-lg shadow-[#AEC8DB]/20 active:scale-95 transition-transform">å„²å­˜</button>
                                    <button onClick={()=>setShowSettings(false)} className="flex-1 bg-cream-100 text-latte-500 py-3 rounded-xl font-bold hover:bg-cream-200 active:scale-95 transition-transform">å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Proxy Order Modal (ä»£å®¢åŠ å–®) */}
                    {showProxyOrder && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[200] flex items-end md:items-center justify-center p-4">
                            <div className="bg-white rounded-[30px] w-full max-w-md p-6 space-y-4 shadow-2xl animate-in">
                                <h3 className="font-bold border-b border-cream-200 pb-3 text-latte-800 text-lg flex items-center gap-2"><Plus size={20} className="text-[#AEC8DB]"/> ä»£å®¢åŠ å–® / å…¥åº«</h3>
                                <div className="space-y-3">
                                    <div className="space-y-1">
                                        <label className="text-xs font-bold text-latte-400 ml-1">å•†å“åç¨±</label>
                                        <input placeholder="è¼¸å…¥æˆ–é¸æ“‡å•†å“..." className="w-full bg-cream-50 border border-cream-200 p-3 rounded-xl focus:border-latte-400 outline-none text-latte-800 placeholder:text-latte-300 shadow-inner-soft" list="pl" value={proxyForm.productName} onChange={handleProxyProductChange}/><datalist id="pl">{[...new Set(products.map(p=>p.name))].map(n=><option key={n} value={n}/>)}</datalist>
                                    </div>
                                    <div className="flex gap-3">
                                        <div className="flex-1 space-y-1">
                                            <label className="text-xs font-bold text-latte-400 ml-1">æ¬¾å¼</label>
                                            <input placeholder="æ¬¾å¼" className="w-full bg-cream-50 border border-cream-200 p-3 rounded-xl focus:border-latte-400 outline-none text-latte-800 placeholder:text-latte-300 shadow-inner-soft" list="vl" value={proxyForm.variant} onChange={handleProxyVariantChange}/><datalist id="vl">{availableVariants.map(v=><option key={v} value={v}/>)}</datalist>
                                        </div>
                                        <div className="w-24 space-y-1">
                                            <label className="text-xs font-bold text-latte-400 ml-1">åƒ¹æ ¼</label>
                                            <input type="number" placeholder="$" className="w-full bg-cream-50 border border-cream-200 p-3 rounded-xl focus:border-latte-400 outline-none text-latte-800 text-center placeholder:text-latte-300 shadow-inner-soft" value={proxyForm.price} onChange={e=>setProxyForm({...proxyForm,price:e.target.value})}/>
                                        </div>
                                    </div>
                                    <div className="flex gap-3">
                                        <div className="flex-1 space-y-1">
                                            <label className="text-xs font-bold text-latte-400 ml-1">é¡§å®¢ (é¸å¡«)</label>
                                            <input placeholder="è¼¸å…¥é¡§å®¢å§“å..." className="w-full bg-cream-50 border border-cream-200 p-3 rounded-xl focus:border-latte-400 outline-none text-latte-800 placeholder:text-latte-300 shadow-inner-soft" list="cl" value={proxyForm.customer} onChange={e=>setProxyForm({...proxyForm,customer:e.target.value})}/><datalist id="cl">{customerList.map(c=><option key={c.name} value={c.name}/>)}</datalist>
                                        </div>
                                        <div className="w-24 space-y-1">
                                            <label className="text-xs font-bold text-latte-400 ml-1">æ•¸é‡</label>
                                            <input type="number" placeholder="æ•¸" className="w-full bg-cream-50 border border-cream-200 p-3 rounded-xl focus:border-latte-400 outline-none text-latte-800 text-center placeholder:text-latte-300 shadow-inner-soft" value={proxyForm.qty} onChange={e=>setProxyForm({...proxyForm,qty:e.target.value})}/>
                                        </div>
                                    </div>
                                    <div className="pt-2 border-t border-cream-200 mt-2">
                                        <label className="text-xs text-latte-500 font-bold ml-1 mb-1 block flex justify-between">åŒæ™‚å…¥åº«ç¾è²¨æ•¸é‡ <span className="text-latte-300 font-normal">è‹¥åƒ…å…¥åº«ä¸æ¥å–®ï¼Œé¡§å®¢æ¬„ç•™ç©º</span></label>
                                        <input type="number" placeholder="0" className="w-full bg-latte-50 border border-latte-200 p-3 rounded-xl focus:border-latte-400 outline-none text-latte-800 text-center font-bold" value={proxyForm.purchasedQty} onChange={e=>setProxyForm({...proxyForm,purchasedQty:e.target.value})}/>
                                    </div>
                                </div>
                                <div className="pt-2 flex flex-col gap-2">
                                    <button onClick={handleAddOrder} className="w-full bg-[#AEC8DB] text-white py-3.5 rounded-xl font-bold shadow-lg shadow-[#AEC8DB]/20 active:scale-95 transition-transform hover:brightness-105">ç¢ºèªæ–°å¢</button>
                                    <button onClick={()=>setShowProxyOrder(false)} className="w-full py-2 text-latte-400 text-sm font-bold hover:text-latte-600">å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Full Screen Modals (Revenue/Purchase) */}
                    {showRevenueList && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[150] flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl w-full max-w-md h-[80vh] flex flex-col shadow-2xl animate-in">
                                <div className="p-5 border-b border-cream-200 flex justify-between items-center bg-cream-50 rounded-t-3xl"><h3 className="font-bold text-latte-800 text-lg flex gap-2 items-center"><DollarSign size={20}/> ç‡Ÿæ”¶ç¸½è¦½</h3><button onClick={()=>setShowRevenueList(false)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center hover:bg-latte-200"><X size={18}/></button></div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {revenueCustomers.map(c=>
                                        <div key={c.name} onClick={()=>{setShowRevenueList(false);setSelectedCustomerDetail(c)}} className="flex justify-between p-4 bg-white rounded-2xl items-center cursor-pointer border border-cream-100 shadow-sm hover:border-latte-300 hover:shadow-soft transition-all">
                                            <span className="font-bold text-latte-800 text-lg">{c.name}</span>
                                            <span className="font-bold text-latte-600 bg-cream-50 px-3 py-1 rounded-lg border border-cream-200">${c.totalSpent.toLocaleString()}</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showPurchaseList && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[150] flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl w-full max-w-md h-[80vh] flex flex-col shadow-2xl animate-in">
                                <div className="p-5 border-b border-cream-200 flex justify-between items-center bg-cream-50 rounded-t-3xl"><h3 className="font-bold text-latte-800 text-lg flex gap-2 items-center"><ShoppingCart size={20}/> æ¡è³¼æ¸…å–®</h3><button onClick={()=>setShowPurchaseList(false)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center hover:bg-latte-200"><X size={18}/></button></div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {purchaseList.map(p=>
                                        <div key={p.id} className="flex justify-between items-center p-4 bg-white rounded-2xl border border-cream-100 shadow-sm">
                                            <div><div className="font-bold text-latte-800 text-lg">{p.name}</div><div className="text-xs text-latte-400 mt-1 font-bold bg-cream-100 inline-block px-2 py-0.5 rounded">{p.variant}</div></div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs text-latte-400 font-bold">ç¼º</span>
                                                {editingPurchaseQtyId===p.id?
                                                    <input autoFocus className="w-16 border border-latte-300 rounded-lg text-center py-1 text-latte-800 font-bold outline-none bg-cream-50" type="number" defaultValue={p.shortage} onBlur={e=>handleUpdatePurchaseQty(p.id,e.target.value)}/>:
                                                    <span onClick={()=>setEditingPurchaseQtyId(p.id)} className="text-[#D98E73] font-black text-2xl cursor-pointer hover:bg-cream-50 px-2 rounded transition-colors">{p.shortage}</span>
                                                }
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Group Detail Modal (å•†å“ç¾¤çµ„è©³æƒ…) */}
                    {selectedGroupName && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[150] flex items-end md:items-center justify-center p-0 md:p-4">
                            <div className="bg-white rounded-t-[30px] md:rounded-3xl w-full max-w-md h-[85vh] flex flex-col shadow-2xl animate-in">
                                <div className="p-6 border-b border-cream-200 flex justify-between items-center bg-cream-50 rounded-t-[30px] md:rounded-t-3xl">
                                    <h3 className="font-bold text-latte-800 text-xl">{selectedGroupName}</h3>
                                    <button onClick={()=>setSelectedGroupName(null)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center hover:bg-latte-200"><X size={18}/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-5 space-y-6">
                                    {/* å„ªæƒ è¨­å®šå€å¡Š (åƒ…åœ¨ç·¨è¼¯æ¨¡å¼é¡¯ç¤º) */}
                                    {isEditingProduct && (
                                        <div className="bg-[#FFFBF5] p-4 rounded-2xl border border-[#EBE0D6] space-y-3">
                                            <h4 className="font-bold text-[#957E6B] text-sm flex items-center gap-2"><Tag size={16}/> å…¨ç³»åˆ—å„ªæƒ è¨­å®š (åŒåå•†å“å…±ç”¨)</h4>
                                            <div className="flex gap-3">
                                                <div className="flex-1">
                                                     <label className="text-xs text-[#B5A496] font-bold block mb-1">æ»¿ä»¶æ•¸ (é–€æª»)</label>
                                                     <input type="number" className="w-full p-2 rounded-lg border border-cream-200 bg-white text-center font-bold text-latte-800 outline-none focus:border-[#AEC8DB]" placeholder="0" 
                                                         defaultValue={products.find(p => p.name === selectedGroupName)?.tierMinQty || 0}
                                                         onBlur={(e) => {
                                                             const firstP = products.find(p => p.name === selectedGroupName);
                                                             if(firstP) handleUpdateProductInfo(firstP.id, 'tierMinQty', e.target.value);
                                                         }}
                                                     />
                                                </div>
                                                <div className="flex-1">
                                                     <label className="text-xs text-[#B5A496] font-bold block mb-1">å„ªæƒ å–®åƒ¹</label>
                                                     <input type="number" className="w-full p-2 rounded-lg border border-cream-200 bg-white text-center font-bold text-latte-800 outline-none focus:border-[#AEC8DB]" placeholder="0" 
                                                         defaultValue={products.find(p => p.name === selectedGroupName)?.tierPrice || 0}
                                                          onBlur={(e) => {
                                                             const firstP = products.find(p => p.name === selectedGroupName);
                                                             if(firstP) handleUpdateProductInfo(firstP.id, 'tierPrice', e.target.value);
                                                         }}
                                                     />
                                                </div>
                                            </div>
                                            <p className="text-[10px] text-[#B5A496] flex items-center gap-1"><AlertCircle size={10}/> è¨­å®šç‚º 0 ä»£è¡¨ä¸å•Ÿç”¨å„ªæƒ ã€‚ä¿®æ”¹ä»»ä¸€æ¬¾å¼æœƒåŒæ­¥æ›´æ–°ã€‚</p>
                                        </div>
                                    )}

                                    <div className="bg-cream-50 p-4 rounded-2xl border border-cream-100 shadow-inner-soft">
                                        <table className="w-full text-xs text-center">
                                            <thead>
                                                <tr className="text-latte-400 font-bold border-b border-cream-200">
                                                    <th className="pb-3 text-left pl-2">æ¬¾å¼</th>
                                                    {isEditingProduct && <th className="pb-3 w-16">å–®åƒ¹</th>}
                                                    <th className="pb-3">å·²é…</th>
                                                    <th className="pb-3">å¾…é…</th>
                                                    <th className="pb-3">ç¾è²¨</th>
                                                    {isEditingProduct&&<th className="pb-3"></th>}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {productsWithStats.filter(p=>p.name===selectedGroupName).map(p=>
                                                    <tr key={p.id} className="border-b border-cream-100 last:border-0 hover:bg-white/50 transition-colors">
                                                        <td className="py-3 text-left pl-2 font-bold text-latte-700">
                                                            <div>{p.variant}</div>
                                                            {!isEditingProduct && <div className="text-[10px] text-latte-400 font-normal">${p.price}</div>}
                                                        </td>
                                                        {isEditingProduct && <td><input className="w-14 text-center border border-latte-200 rounded py-1 bg-white outline-none focus:border-[#AEC8DB]" defaultValue={p.price} onBlur={e=>handleUpdateProductInfo(p.id,'price',e.target.value)}/></td>}
                                                        <td className="text-latte-500 font-bold">{p.confirmed}</td>
                                                        <td className="text-[#D98E73] font-bold">{p.pending}</td>
                                                        <td>{isEditingProduct?<input className="w-10 text-center border border-latte-200 rounded py-1 bg-white outline-none focus:border-[#AEC8DB]" defaultValue={p.spot} onBlur={e=>handleUpdateProductInfo(p.id,'spot',e.target.value)}/>:<span className="font-bold text-latte-800 bg-white px-2 py-1 rounded border border-transparent">{p.spot}</span>}</td>
                                                        {isEditingProduct&&<td><button onClick={()=>handleDeleteProduct(p.id)} className="text-rose-400 hover:text-rose-600"><Trash2 size={16}/></button></td>}
                                                    </tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div>
                                        <h4 className="text-xs font-bold text-latte-400 mb-3 ml-1 flex items-center gap-1"><Split size={14}/> é…è²¨æ˜ç´° (é»æ“Šæ•¸é‡ä¿®æ”¹)</h4>
                                        {getGroupAllocations(selectedGroupName).map((r,i)=>
                                            <div key={i} className={`flex justify-between items-center p-3 rounded-xl mb-2 border transition-all ${r.isAllocated ? 'bg-latte-50 border-latte-200' : 'bg-white border-cream-200 hover:border-latte-200'}`}>
                                                <div className="flex items-center gap-3">
                                                    <button onClick={()=>toggleAllocation(r.orderId,r.productId,r.allocatedQty,r.qty)} className={`w-6 h-6 rounded-lg border flex items-center justify-center transition-colors active:scale-90 ${r.isAllocated?'bg-latte-500 border-latte-500 text-white':'border-latte-200 text-transparent hover:border-latte-400'}`}><CheckSquare size={14}/></button>
                                                    <div><div className="font-bold text-sm text-latte-800">{r.customer}</div><div className="text-[10px] text-latte-400 font-bold">{r.variant}</div></div>
                                                </div>
                                                <div className="flex items-center gap-1 text-sm bg-white px-2 py-1 rounded-lg border border-cream-200 shadow-sm">
                                                    <span className="text-[10px] text-latte-400">é…</span>
                                                    {editingAllocatedQtyId===`${r.orderId}-${r.productId}-detail`?
                                                        <input autoFocus className="w-8 text-center border-b border-latte-500 outline-none bg-transparent font-bold text-latte-800" defaultValue={r.allocatedQty} onBlur={e=>handleUpdateAllocatedQty(r.orderId,r.productId,e.target.value)}/>:
                                                        <span onClick={()=>setEditingAllocatedQtyId(`${r.orderId}-${r.productId}-detail`)} className="font-bold text-latte-600 cursor-pointer hover:bg-cream-100 px-1 rounded">{r.allocatedQty}</span>
                                                    }
                                                    <span className="text-[10px] text-latte-300">/</span>
                                                    <span className="text-[10px] text-latte-400">å–Š</span>
                                                    {editingOrderQtyId===`${r.orderId}-${r.productId}-detail`?
                                                        <input autoFocus className="w-8 text-center border-b border-latte-300 outline-none bg-transparent font-bold text-latte-800" defaultValue={r.qty} onBlur={e=>handleUpdateOrderQty(r.orderId,r.productId,e.target.value)}/>:
                                                        <span onClick={()=>setEditingOrderQtyId(`${r.orderId}-${r.productId}-detail`)} className="font-bold text-latte-800 cursor-pointer hover:bg-cream-100 px-1 rounded">{r.qty}</span>
                                                    }
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="p-4 border-t border-cream-200 flex justify-between bg-white rounded-b-[30px] md:rounded-b-3xl">
                                    <button onClick={()=>{setProxyForm(prev=>({...prev,productName:selectedGroupName}));setShowProxyOrder(true)}} className="text-sm bg-cream-100 text-latte-600 font-bold px-4 py-3 rounded-xl flex gap-2 items-center hover:bg-cream-200 transition-colors active:scale-95"><Plus size={16}/> åŠ å–®</button>
                                    <button onClick={()=>setIsEditingProduct(!isEditingProduct)} className={`text-sm px-4 py-3 rounded-xl flex gap-2 items-center font-bold transition-colors active:scale-95 ${isEditingProduct?'bg-[#AEC8DB] text-white shadow-lg shadow-[#AEC8DB]/20':'bg-cream-100 text-latte-600 hover:bg-cream-200'}`}><Edit size={16}/> {isEditingProduct ? 'å®Œæˆç·¨è¼¯' : 'ç·¨è¼¯å•†å“'}</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Customer Detail Modal (é¡§å®¢è©³æƒ…) */}
                    {selectedCustomerDetail && currentSelectedCustomer && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[160] flex items-end md:items-center justify-center p-0 md:p-4">
                            <div className="bg-white rounded-t-[30px] md:rounded-3xl w-full max-w-md h-[85vh] flex flex-col shadow-2xl animate-in">
                                <div className="p-6 border-b border-cream-200 flex justify-between items-start bg-cream-50 rounded-t-[30px] md:rounded-t-3xl">
                                    <div>
                                        <h3 className="text-xl font-bold text-latte-800 flex items-center gap-2"><User size={20}/> {currentSelectedCustomer.name}</h3>
                                        <div className="text-xs text-latte-500 font-bold mt-2 bg-white px-2 py-1 rounded-lg border border-cream-200 inline-block shadow-sm">ç¸½é¡: ${currentSelectedCustomer.totalSpent.toLocaleString()}</div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>handleCopyOrderText(currentSelectedCustomer)} className="p-2.5 bg-white border border-cream-200 rounded-xl flex gap-1 text-xs items-center font-bold text-latte-600 shadow-sm active:scale-95 hover:bg-cream-50" title="è¤‡è£½æ–‡å­—"><ClipboardList size={18}/> æ–‡æ¡ˆ</button>
                                        <button onClick={()=>handleExportToImage(currentSelectedCustomer)} className="p-2.5 bg-white border border-cream-200 rounded-xl flex gap-1 text-xs items-center font-bold text-latte-600 shadow-sm active:scale-95 hover:bg-cream-50" title="åŒ¯å‡ºåœ–ç‰‡"><ImageIcon size={18}/> å­˜åœ–</button>
                                        <button onClick={()=>{setProxyForm(prev=>({...prev,customer:currentSelectedCustomer.name}));setShowProxyOrder(true)}} className="p-2.5 bg-[#AEC8DB] text-white rounded-xl shadow-md shadow-[#AEC8DB]/20 active:scale-95 hover:brightness-105"><Plus size={18}/></button>
                                        <button onClick={()=>setSelectedCustomerDetail(null)} className="p-2.5 bg-cream-200 text-latte-600 rounded-xl active:scale-95 hover:bg-cream-300"><X size={18}/></button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                    {currentSelectedCustomer.items.map((item,idx)=>(
                                        <div key={idx} className="flex justify-between items-center p-4 bg-white border border-cream-200 rounded-2xl shadow-sm hover:border-latte-200 transition-colors">
                                            <div><div className="font-bold text-sm text-latte-800">{item.name}</div><div className="text-xs text-latte-400 mt-1 font-bold">{item.variant} Â· ${item.finalPrice}</div></div>
                                            <div className="text-right flex items-center gap-2 justify-end">
                                                <div className="bg-cream-50 px-2 py-1 rounded-lg border border-cream-100 flex items-center gap-1">
                                                    <span className="text-xs text-latte-400">x</span>
                                                    {editingOrderQtyId===`${item.orderId}-${item.productId}` ? 
                                                        <input autoFocus className="w-8 text-center border-b border-latte-500 outline-none bg-transparent font-bold text-latte-800" defaultValue={item.qty} onBlur={e=>handleUpdateOrderQty(item.orderId,item.productId,e.target.value)}/> :
                                                        <span onClick={()=>setEditingOrderQtyId(`${item.orderId}-${item.productId}`)} className="font-bold cursor-pointer text-latte-800 hover:text-latte-500">{item.qty}</span>
                                                    }
                                                </div>
                                                <div className="text-sm text-latte-600 font-black min-w-[3rem] text-right">${item.itemTotal}</div>
                                                <button onClick={()=>handleDeleteOrderItem(item.orderId,item.productId)} className="ml-1 text-cream-300 hover:text-rose-500 transition-colors p-1"><Trash2 size={16}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Arrival Check Modal (å‡ºè²¨æª¢æ ¸) */}
                    {currentSelectedArrivalCustomer && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[150] flex items-end md:items-center justify-center p-0 md:p-4">
                            <div className="bg-white rounded-t-[30px] md:rounded-3xl w-full max-w-md h-[85vh] flex flex-col shadow-2xl animate-in">
                                <div className="p-6 bg-latte-800 text-cream-100 rounded-t-[30px] md:rounded-t-3xl flex justify-between items-start shrink-0 shadow-lg">
                                    <div><h3 className="text-xl font-bold flex items-center gap-2"><Truck size={20}/> {currentSelectedArrivalCustomer.name}</h3><p className="text-xs opacity-70 mt-1 font-bold tracking-wide">{isArrivalShipped ? 'å·²å‡ºè²¨æ­¸æª”' : 'é…è²¨å‡ºè²¨æª¢æ ¸'}</p></div>
                                    <button onClick={()=>setSelectedArrivalCustomer(null)} className="bg-white/10 p-2 rounded-full hover:bg-white/20 transition-colors"><X size={18}/></button>
                                </div>
                                <div className="px-6 py-4 bg-latte-700 text-white flex justify-between items-center shrink-0 border-b border-latte-600">
                                    <div className="text-xs opacity-90 font-bold">é€²åº¦: {currentSelectedArrivalCustomer.items.filter(i=>(i.allocatedQty||0)>=i.qty).length} / {currentSelectedArrivalCustomer.items.length} é …</div>
                                    {!isArrivalShipped && currentSelectedArrivalCustomer.isFullyArrived && <button onClick={()=>handleShipCustomer(currentSelectedArrivalCustomer.name)} className="bg-emerald-500 px-4 py-1.5 rounded-xl text-xs font-bold flex gap-1 shadow-lg shadow-emerald-500/30 animate-pulse hover:scale-105 transition-transform"><Truck size={14}/> ç¢ºèªå‡ºè²¨</button>}
                                    {isArrivalShipped && <button onClick={()=>handleUnshipCustomer(currentSelectedArrivalCustomer.name)} className="bg-amber-500 px-4 py-1.5 rounded-xl text-xs font-bold flex gap-1 shadow-lg shadow-amber-500/30 active:scale-95"><Undo2 size={14}/> å›å¾©æœªå‡ºè²¨</button>}
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-cream-50">
                                    {currentSelectedArrivalCustomer.items.map((item,idx)=>{
                                        const isDone = (item.allocatedQty||0) >= item.qty;
                                        return (
                                            <div key={idx} className={`flex justify-between items-center p-3 border rounded-2xl shadow-sm transition-all ${isDone?'bg-emerald-50 border-emerald-200':'bg-white border-cream-200'} ${isArrivalShipped?'opacity-70 grayscale-[0.3]':''}`}>
                                                <div className="flex items-center gap-3 flex-1">
                                                    {!isArrivalShipped ? (
                                                        <button onClick={()=>toggleAllocation(item.orderId,item.productId,item.allocatedQty||0,item.qty)} className={`w-8 h-8 rounded-xl border flex items-center justify-center transition-all active:scale-90 ${isDone?'bg-emerald-500 border-emerald-500 text-white shadow-md shadow-emerald-200':'border-cream-300 text-transparent hover:border-latte-400'}`}><CheckSquare size={16}/></button>
                                                    ) : <div className="w-8 h-8 flex items-center justify-center bg-gray-200 rounded-xl text-gray-500"><PackageCheck size={16}/></div>}
                                                    <div><div className="font-bold text-sm text-latte-800">{item.name}</div><div className="text-[10px] text-latte-400 font-bold">{item.variant}</div></div>
                                                </div>
                                                <div className="flex items-center gap-1 text-sm bg-white/50 px-2 py-1.5 rounded-xl border border-transparent">
                                                    <span className="text-xs text-latte-400 font-bold">é…</span>
                                                    {!isArrivalShipped && editingAllocatedQtyId===`${item.orderId}-${item.productId}-arrival` ?
                                                        <input autoFocus className="w-8 text-center border-b border-emerald-500 outline-none bg-transparent font-bold text-emerald-700" defaultValue={item.allocatedQty||0} onBlur={e=>handleUpdateAllocatedQty(item.orderId,item.productId,e.target.value)}/> :
                                                        <span onClick={()=>!isArrivalShipped && setEditingAllocatedQtyId(`${item.orderId}-${item.productId}-arrival`)} className={`font-black text-lg ${isDone?'text-emerald-500':'text-latte-300'} ${!isArrivalShipped && 'cursor-pointer hover:bg-cream-100 px-1 rounded'}`}>{item.allocatedQty||0}</span>
                                                    }
                                                    <span className="text-xs text-latte-300 font-bold">/</span>
                                                    <span className="text-xs text-latte-400 font-bold">è¨‚</span>
                                                    {!isArrivalShipped && editingOrderQtyId===`${item.orderId}-${item.productId}-arrival` ?
                                                        <input autoFocus className="w-8 text-center border-b border-latte-500 outline-none bg-transparent font-bold text-latte-800" defaultValue={item.qty} onBlur={e=>handleUpdateOrderQty(item.orderId,item.productId,e.target.value)}/> :
                                                        <span onClick={()=>!isArrivalShipped && setEditingOrderQtyId(`${item.orderId}-${item.productId}-arrival`)} className="font-bold cursor-pointer text-latte-800 hover:bg-cream-100 px-1 rounded">{item.qty}</span>
                                                    }
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
