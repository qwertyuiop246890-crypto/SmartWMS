<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Êô∫ÊÖßÈÄ£Á∑öÂÄâÂ∫´ÁÆ°ÁêÜÁ≥ªÁµ±</title>
    
    <!-- 1. ËºâÂÖ• Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ËºâÂÖ• Babel Áî®ÊñºËß£Êûê JSX (Ëàá ESM ÈÖçÂêà) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Èö±ËóèÊç≤Ëª∏‰ΩÜ‰øùÁïôÂäüËÉΩ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* ÂãïÁï´ÊïàÊûúÂÆöÁæ© */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        /* Èò≤Ê≠¢ iOS safari ÈªûÊìäÊôÇÁöÑÈñÉÁàç */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4F46E5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4F46E5;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans overscroll-none">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';
        import { 
            LayoutDashboard, 
            Package, 
            ShoppingCart, 
            Users, 
            Zap, 
            Plus, 
            ArrowRight, 
            AlertCircle, 
            CheckCircle2, 
            Combine, 
            Split, 
            MessageCircle, 
            Truck, 
            DollarSign, 
            Search, 
            Filter, 
            X, 
            ChevronRight, 
            ChevronUp,
            ClipboardList, 
            User, 
            ShoppingBag, 
            ListOrdered, 
            Tag, 
            Layers, 
            Archive, 
            CheckSquare, 
            Square, 
            Trash2, 
            Edit, 
            Save,
            Copy,
            CreditCard,
            RotateCcw,
            Minus,
            TrendingUp,
            Wallet,
            BoxSelect
        } from 'https://esm.sh/lucide-react@0.263.1?dev';

        const App = () => {
            const [activeTab, setActiveTab] = useState('products');
            const [showProxyOrder, setShowProxyOrder] = useState(false);
            const [showPurchaseList, setShowPurchaseList] = useState(false);
            const [showDebtList, setShowDebtList] = useState(false);
            
            // Ë©≥ÊÉÖÂΩàÁ™óÁãÄÊÖã
            const [selectedGroupName, setSelectedGroupName] = useState(null); 
            const [selectedCustomerDetail, setSelectedCustomerDetail] = useState(null);
            const [selectedArrivalCustomer, setSelectedArrivalCustomer] = useState(null); 
            
            // Á∑®ËºØËàáÊî∂Ê¨æÊ®°ÂºèÁãÄÊÖã
            const [isEditingProduct, setIsEditingProduct] = useState(false);
            const [showPaymentInput, setShowPaymentInput] = useState(false);
            const [paymentAmount, setPaymentAmount] = useState('');
            const [editingOrderQtyId, setEditingOrderQtyId] = useState(null);

            // ‰ª£ÂÆ¢Âä†ÂñÆË°®ÂñÆÁãÄÊÖã
            const [proxyForm, setProxyForm] = useState({
                productName: '',
                variant: '', 
                price: '',
                customer: '',
                qty: 1,
                purchasedQty: 0
            });

            const [notification, setNotification] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');

            // 1. ÁãÄÊÖãÁÆ°ÁêÜÔºöÂ∫´Â≠ò
            const [products, setProducts] = useState([
                { id: 'A1', name: 'Êó•Êú¨Ê•µËá¥ÂêπÈ¢®Ê©ü', variant: 'ÁèçÁè†ÁôΩ', spot: 2, price: 3200, tierMinQty: 0, tierPrice: 0 },
                { id: 'A2', name: 'Êó•Êú¨Ê•µËá¥ÂêπÈ¢®Ê©ü', variant: 'Ê∂àÂÖâÈªë', spot: 3, price: 3200, tierMinQty: 0, tierPrice: 0 },
                { id: 'B2', name: 'Ê≥ïÂºèÈªëÂ∑ßÂÖãÂäõÁõí', variant: 'ÂñÆ‰∏ÄÊ¨æÂºè', spot: 20, price: 450, tierMinQty: 2, tierPrice: 400 },
                { id: 'C3', name: 'ÈüìÂúãÈôêÂÆöÈÅãÂãïÈûã', variant: '24cm', spot: 0, price: 2800, tierMinQty: 0, tierPrice: 0 },
                { id: 'D4', name: 'ËÜ†ÂéüËõãÁôΩÁ≤â', variant: 'ÁΩêË£ù', spot: 30, price: 980, tierMinQty: 3, tierPrice: 900 },
                { id: 'E5', name: 'Áí∞‰øùË≥ºÁâ©Ë¢ã', variant: 'ËóçËâ≤', spot: 2, price: 150, tierMinQty: 0, tierPrice: 0 },
            ]);

            // 2. ÁãÄÊÖãÁÆ°ÁêÜÔºöË®ÇÂñÆ
            // Ê≥®ÊÑèÔºöÁßªÈô§Áç®Á´ãÁöÑ isArrivedÔºåÁµ±‰∏Ä‰ΩøÁî® isAllocated ‰ª£Ë°®„ÄåÂ∑≤ÈÖçË≤®/Â∑≤Âà∞Ë≤®„Äç
            const [orders, setOrders] = useState([
                { id: 'ORD001', customer: 'ÊûóÂ∞èÁæé', total: 6400, paid: 3200, status: 'ÈÉ®ÂàÜÂà∞Ë≤®', items: [{ productId: 'A1', name: 'Êó•Êú¨Ê•µËá¥ÂêπÈ¢®Ê©ü', variant: 'ÁèçÁè†ÁôΩ', qty: 2, price: 3200, isAllocated: true }], debt: 3200, unclaimed: 1 },
                { id: 'ORD002', customer: 'ÁéãÂ§ßÂêå', total: 450, paid: 0, status: 'ÂæÖÁµêÂñÆ', items: [{ productId: 'B2', name: 'Ê≥ïÂºèÈªëÂ∑ßÂÖãÂäõÁõí', variant: 'ÂñÆ‰∏ÄÊ¨æÂºè', qty: 1, price: 450, isAllocated: false }], debt: 450, unclaimed: 0 },
                { id: 'ORD003', customer: 'ÂºµÈõÖÂ©∑', total: 5600, paid: 5600, status: 'ÂæÖÂá∫Ë≤®', items: [{ productId: 'C3', name: 'ÈüìÂúãÈôêÂÆöÈÅãÂãïÈûã', variant: '24cm', qty: 2, price: 2800, isAllocated: false }], debt: 0, unclaimed: 2 },
            ]);

            const notify = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            const handleUpdateOrderQty = (orderId, productId, newQtyStr) => {
                const newQty = parseInt(newQtyStr, 10);
                if (isNaN(newQty) || newQty < 0) return;

                setOrders(prev => prev.map(o => {
                    if (o.id === orderId) {
                        const newItems = o.items.map(item => {
                            if (item.productId === productId) {
                                return { ...item, qty: newQty };
                            }
                            return item;
                        }).filter(item => item.qty > 0);
                        return { ...o, items: newItems };
                    }
                    return o;
                }));
                setEditingOrderQtyId(null);
                notify("Êï∏ÈáèÂ∑≤Êõ¥Êñ∞ÔºåÈáëÈ°çÂ∑≤ÈáçÊñ∞Ë®àÁÆó");
            };

            const handleDeleteOrderItem = (orderId, productId) => {
                if(!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÂïÜÂìÅÂóéÔºüÂà™Èô§ÂæåÈáëÈ°çÂ∞áÈáçÊñ∞Ë®àÁÆó„ÄÇ')) return;

                setOrders(prev => prev.map(o => {
                    if (o.id === orderId) {
                        const itemToRemove = o.items.find(i => i.productId === productId);
                        if (!itemToRemove) return o; 

                        const newItems = o.items.filter(i => i.productId !== productId);
                        
                        if (itemToRemove.isAllocated) {
                            setProducts(currProducts => currProducts.map(p => {
                                if (p.id === productId) {
                                    return { ...p, spot: p.spot + itemToRemove.qty };
                                }
                                return p;
                            }));
                        }

                        return { ...o, items: newItems };
                    }
                    return o;
                }).filter(o => o.items.length > 0)); 

                notify("Â∑≤Âà™Èô§Ë©≤Á≠ÜÂïÜÂìÅ");
            };

            const handleUpdateProductInfo = (productId, field, value) => {
                const val = parseInt(value, 10);
                if (isNaN(val)) return;

                const targetProduct = products.find(p => p.id === productId);
                const targetName = targetProduct ? targetProduct.name : '';

                setProducts(prev => prev.map(p => {
                    if ((field === 'tierMinQty' || field === 'tierPrice') && p.name === targetName) {
                        return { ...p, [field]: val };
                    }
                    if (p.id === productId) {
                        return { ...p, [field]: val };
                    }
                    return p;
                }));
            };

            const handleDeleteProductGroup = (groupName, e) => {
                e.stopPropagation();
                if (confirm(`‚ö†Ô∏è Âà™Èô§Ë≠¶Âëä\n\nÁ¢∫ÂÆöË¶ÅÂà™Èô§ÂïÜÂìÅ„Äå${groupName}„ÄçÂèäÂÖ∂ÊâÄÊúâÊ¨æÂºèÂóéÔºü\nÊ≠§Âãï‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ`)) {
                    setProducts(prev => prev.filter(p => p.name !== groupName));
                    if (selectedGroupName === groupName) {
                        setSelectedGroupName(null);
                    }
                    notify(`Â∑≤Âà™Èô§ÂïÜÂìÅÔºö${groupName}`);
                }
            };

            const handleDeleteProduct = (productId) => {
                if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ê¨æÂºèÂóéÔºü')) {
                    setProducts(prev => prev.filter(p => p.id !== productId));
                    notify("Â∑≤Âà™Èô§ÂïÜÂìÅÊ¨æÂºè");
                }
            };

            const handleDeleteCustomer = (customerName, e) => {
                e.stopPropagation();
                if (confirm(`‚ö†Ô∏è Âà™Èô§Ë≠¶Âëä\n\nÁ¢∫ÂÆöË¶ÅÂà™Èô§È°ßÂÆ¢„Äå${customerName}„ÄçÁöÑÊâÄÊúâË≥áÊñôÂóéÔºü\nÈÄôÂ∞áÊúÉÂà™Èô§Ë©≤È°ßÂÆ¢ÁöÑÊâÄÊúâË®ÇÂñÆÁ¥ÄÈåÑ„ÄÇ`)) {
                    setOrders(prev => prev.filter(o => o.customer !== customerName));
                    if (selectedCustomerDetail?.name === customerName) {
                        setSelectedCustomerDetail(null);
                    }
                    notify(`Â∑≤Âà™Èô§È°ßÂÆ¢Ôºö${customerName}`);
                }
            };

            const customerList = useMemo(() => {
                const map = {};
                
                orders.forEach(o => {
                    if (!map[o.customer]) {
                        map[o.customer] = { 
                            name: o.customer, 
                            totalSpent: 0, 
                            totalPaid: 0,
                            orderCount: 0, 
                            debt: 0, 
                            items: [],
                            rawItems: []
                        };
                    }
                    map[o.customer].totalPaid += o.paid;
                    map[o.customer].orderCount += 1;
                    
                    o.items.forEach(item => {
                        map[o.customer].rawItems.push({
                            ...item,
                            orderId: o.id
                        });
                    });
                });

                Object.values(map).forEach(cust => {
                    const nameCounts = {};
                    cust.rawItems.forEach(item => {
                        const productInfo = products.find(p => p.id === item.productId);
                        const productName = productInfo ? productInfo.name : item.name;
                        
                        if (!nameCounts[productName]) {
                            nameCounts[productName] = 0;
                        }
                        nameCounts[productName] += item.qty;
                    });

                    cust.rawItems.forEach(item => {
                        const productInfo = products.find(p => p.id === item.productId);
                        const productName = productInfo ? productInfo.name : item.name;
                        
                        let finalPrice = item.price;
                        let originalPrice = item.price;
                        let tierMinQty = 0;
                        let tierPrice = 0;

                        if (productInfo) {
                            originalPrice = productInfo.price;
                            tierMinQty = productInfo.tierMinQty;
                            tierPrice = productInfo.tierPrice;
                        }

                        if (tierMinQty > 0 && nameCounts[productName] >= tierMinQty) {
                            finalPrice = tierPrice;
                        }

                        const itemTotal = item.qty * finalPrice;
                        
                        cust.items.push({
                            ...item,
                            finalPrice: finalPrice,
                            isDiscounted: finalPrice < originalPrice,
                            itemTotal: itemTotal
                        });
                        cust.totalSpent += itemTotal;
                    });

                    cust.debt = Math.max(0, cust.totalSpent - cust.totalPaid);
                });

                return Object.values(map);
            }, [orders, products]);

            const handleCopyCustomerDetails = (customer) => {
                let itemsText = '';
                customer.items.forEach(item => {
                    const priceDisplay = item.isDiscounted ? `$${item.finalPrice} (ÂÑ™ÊÉ†)` : `$${item.finalPrice}`;
                    itemsText += `- ${item.name} ${item.variant !== 'ÂñÆ‰∏ÄÊ¨æÂºè' && item.variant ? `(${item.variant})` : ''} x${item.qty} ${priceDisplay}\n`;
                });

                const text = `Ë¶™ÊÑõÁöÑ ${customer.name} ÊÇ®Â•ΩÔºå
ÊÇ®Êú¨Ê¨°ÁöÑÈÄ£Á∑öË≥ºÁâ©ÊòéÁ¥∞Â¶Ç‰∏ãÔºö
${itemsText}----------------
Ê∂àË≤ªÁ∏ΩÈ°çÔºö$${customer.totalSpent.toLocaleString()}

ÂèØ‰ª•ÂÖàÂπ´ÊàëÊê≠Ê≥¢ÂçªÂèØ
ÊúâË™§ÁöÑË©±ÔΩûË´ãË∂ïÂø´Ë∑üÊàëË™™ÔºÅ
‚Çä‚äπ Ëã•ÊòØÊ≤íÊúâÊºèÊéâÁöÑÂïÜÂìÅ ‚Çä‚äπ
Â∞±ÂèØ‰ª•Áõ¥Êé•ÁµêÂ∏≥ÂõâÔºÅ
Á∂≤ÂùÄÔºöÔºàÈÄôË£°ÁïôÁµ¶ÊàëËá™Â∑±Ëº∏ÂÖ•Á∂≤ÂùÄÔºâ
ÊâæÂà∞Ëá™Â∑±ÂêçÂ≠óÂæåÂÆåÊàê‰∏ãÂñÆÂ∞±ÂèØ‰ª•Âöï
êôö Êî∂Âà∞ÊâÄÊúâÈÄ£ÁµêÂæåË´ãÁõ°ÈÄüÂÆåÊàê‰ªòÊ¨æ
   ‰∏çË¶ÅËÄΩË™§Âà∞ÊúÄ‰Ω≥ÁöÑË≥ûÂë≥ÊúüÈôêÂî∑

‚öù p.s. Ââç‰∏ÄÊ¨°ÈÄ£Á∑öÊúâÈñãÁÆ±ÂàÜ‰∫´ÁöÑÊúãÂèã~
‰∏ãÂñÆÂæåË´ãÂπ´ÊàëÂÇôË®ª‰∏Ä‰∏ãÔºöÈñãÁÆ±Á¶Æ
ùê≠ùê°ùêöùêßùê§ ùê≤ùê®ùêÆ (‚Äû‚Ä¢ ÷ä ‚Ä¢‚Äû)‡©≠`;

                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    notify("Â∑≤Ë§áË£ΩÈÄöÁü•ÊñáÊ°àÔºÅ");
                } catch (err) {
                    console.error('Ë§áË£ΩÂ§±Êïó', err);
                    notify("Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïË§áË£Ω");
                }
                document.body.removeChild(textArea);
            };

            const productsWithStats = useMemo(() => {
                return products.map(p => {
                    let allocated = 0; 
                    let confirmed = 0; 

                    orders.forEach(o => {
                        o.items.forEach(item => {
                            if (item.productId === p.id) {
                                allocated += item.qty;
                                if (item.isAllocated) {
                                    confirmed += item.qty;
                                }
                            }
                        });
                    });

                    const pending = allocated - confirmed;
                    const totalOwned = p.spot + confirmed;
                    const shortage = Math.max(0, allocated - totalOwned);

                    return {
                        ...p,
                        allocated, 
                        confirmed, 
                        pending,   
                        shortage   
                    };
                });
            }, [products, orders]);

            const navigateTo = (tab) => {
                setActiveTab(tab);
                setSearchQuery('');
            };

            const handleProxyProductChange = (e) => {
                const name = e.target.value;
                const existing = products.find(p => p.name === name);
                setProxyForm(prev => ({
                    ...prev,
                    productName: name,
                    price: existing ? existing.price : prev.price
                }));
            };

            const availableVariants = useMemo(() => {
                if (!proxyForm.productName) return [];
                return [...new Set(products
                    .filter(p => p.name === proxyForm.productName)
                    .map(p => p.variant))];
            }, [products, proxyForm.productName]);

            const handleAddOrder = () => {
                const { productName, variant, price, customer, qty, purchasedQty } = proxyForm;
                const finalVariant = variant || 'ÂñÆ‰∏ÄÊ¨æÂºè';

                if (!productName || !price) {
                    notify('ÂïÜÂìÅÂêçÁ®±ËàáÂÉπÊ†ºÁÇ∫ÂøÖÂ°´');
                    return;
                }

                const quantity = parseInt(qty, 10) || 1;
                const purchasedQuantity = parseInt(purchasedQty, 10) || 0;
                const finalPrice = parseInt(price, 10) || 0;

                let targetProduct = products.find(p => p.name === productName && p.variant === finalVariant);
                let isNewProduct = false;
                let targetId = targetProduct?.id;

                if (!targetProduct) {
                    isNewProduct = true;
                    targetId = `N${Math.floor(Math.random() * 10000)}`;
                    targetProduct = {
                        id: targetId,
                        name: productName,
                        variant: finalVariant,
                        price: finalPrice,
                        spot: 0,
                        tierMinQty: 0,
                        tierPrice: 0
                    };
                }

                setProducts(prev => {
                    if (isNewProduct) {
                        return [{ ...targetProduct, spot: purchasedQuantity }, ...prev];
                    } else {
                        return prev.map(p => 
                            p.id === targetId ? { ...p, spot: p.spot + purchasedQuantity } : p
                        );
                    }
                });

                if (customer) {
                    const newOrder = {
                        id: `ORD${Math.floor(Math.random() * 10000)}`,
                        customer: customer,
                        total: finalPrice * quantity, 
                        paid: 0,
                        status: 'ÂæÖÁµêÂñÆ',
                        items: [{ 
                            productId: targetId, 
                            name: productName, 
                            variant: finalVariant, 
                            qty: quantity, 
                            price: finalPrice, 
                            isAllocated: false // È†êË®≠Êú™ÈÖçË≤®
                        }],
                        debt: 0, 
                        unclaimed: 0
                    };
                    setOrders(prev => [newOrder, ...prev]);
                    notify(`Âä†ÂñÆÊàêÂäü (ÂæÖÊéí)Ôºö${productName}`);
                } else {
                    notify(`Â∑≤ÂÖ•Â∫´Ôºö${productName} x${purchasedQuantity}`);
                }
                
                setShowProxyOrder(false);
                setProxyForm({ productName: '', variant: '', price: '', customer: '', qty: 1, purchasedQty: 0 });
            };

            // Ê†∏ÂøÉÂäüËÉΩÔºöÂàáÊèõÈÖçË≤®ÁãÄÊÖã (isAllocated)
            // ÈÄôÊúÉÂêåÊôÇÂΩ±ÈüøÔºö
            // 1. Ë®ÇÂñÆÂÖßÁöÑ isAllocated ÁãÄÊÖã
            // 2. ÂïÜÂìÅÁöÑ spot (ÁèæË≤®) Êï∏Èáè (ÈÖçË≤®Êâ£ÁèæË≤®ÔºåÂèñÊ∂àÂä†ÁèæË≤®)
            const toggleAllocation = (orderId, productId, currentStatus) => {
                const newStatus = !currentStatus;
                
                const order = orders.find(o => o.id === orderId);
                const item = order ? order.items.find(i => i.productId === productId) : null;
                const qty = item ? item.qty : 0;

                const product = products.find(p => p.id === productId);

                if (newStatus && product.spot < qty) {
                    notify("‚ö†Ô∏è Ê≥®ÊÑèÔºöÁèæË≤®‰∏çË∂≥ÔºåÂ∞áÊâ£ÁÇ∫Ë≤†Êï∏");
                }

                setOrders(prev => prev.map(o => {
                    if (o.id === orderId) {
                        const newItems = o.items.map(item => {
                            if (item.productId === productId) return { ...item, isAllocated: newStatus };
                            return item;
                        });
                        return { ...o, items: newItems };
                    }
                    return o;
                }));

                setProducts(prev => prev.map(p => {
                    if (p.id === productId) {
                        const newSpot = newStatus ? p.spot - qty : p.spot + qty;
                        return { ...p, spot: newSpot };
                    }
                    return p;
                }));
            };

            const handleCustomerPayment = () => {
                const amount = parseInt(paymentAmount, 10);
                if (isNaN(amount) || amount === 0) {
                    notify("Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÊî∂Ê¨æÈáëÈ°ç");
                    return;
                }

                if (!selectedCustomerDetail) return;

                const customerName = selectedCustomerDetail.name;
                
                setOrders(prevOrders => {
                    let remaining = Math.abs(amount);
                    const isRefund = amount < 0;
                    
                    return prevOrders.map(order => {
                        if (order.customer !== customerName || remaining <= 0) return order;

                        if (!isRefund && order.debt > 0) {
                            const payAmount = Math.min(order.debt, remaining);
                            remaining -= payAmount;
                            return { ...order, paid: order.paid + payAmount, debt: order.debt - payAmount };
                        } else if (isRefund && order.paid > 0) {
                            const refundAmount = Math.min(order.paid, remaining);
                            remaining -= refundAmount;
                            return { ...order, paid: order.paid - refundAmount, debt: order.debt + refundAmount };
                        }
                        return order;
                    });
                });

                setPaymentAmount('');
                setShowPaymentInput(false);
                notify(amount > 0 ? `Â∑≤Êî∂Ê¨æ $${amount}` : `Â∑≤ÈÄÄÊ¨æ $${Math.abs(amount)}`);
            };

            const stats = useMemo(() => {
                const totalDebt = customerList.reduce((acc, curr) => acc + curr.debt, 0);
                const totalRevenue = customerList.reduce((acc, curr) => acc + curr.totalSpent, 0); 

                let shortageItemCount = 0; 
                let totalShortageQty = 0;  

                productsWithStats.forEach(p => {
                    if (p.shortage > 0) {
                        shortageItemCount += 1;
                        totalShortageQty += p.shortage;
                    }
                });

                return {
                    totalDebt,
                    totalRevenue, 
                    shortageItemCount,
                    totalShortageQty,
                    pendingShipment: orders.filter(o => o.status === 'ÂæÖÂá∫Ë≤®').length
                };
            }, [orders, productsWithStats, customerList]); 

            const purchaseList = useMemo(() => {
                return productsWithStats
                    .filter(p => p.shortage > 0)
                    .map(p => ({ ...p }));
            }, [productsWithStats]);

            const groupedProducts = useMemo(() => {
                const groups = {};
                productsWithStats.forEach(p => {
                    if (!groups[p.name]) {
                        groups[p.name] = {
                            name: p.name,
                            price: p.price,
                            totalAllocated: 0,
                            totalConfirmed: 0,
                            totalPending: 0,
                            totalSpot: 0,
                            variants: []
                        };
                    }
                    groups[p.name].totalAllocated += p.allocated;
                    groups[p.name].totalConfirmed += p.confirmed;
                    groups[p.name].totalPending += p.pending;
                    groups[p.name].totalSpot += p.spot;
                    groups[p.name].variants.push(p);
                });
                return Object.values(groups);
            }, [productsWithStats]);

            const getGroupAllocations = (groupName) => {
                const variants = products.filter(p => p.name === groupName);
                const result = [];
                variants.forEach(variant => {
                    orders.forEach(o => {
                        o.items.forEach(item => {
                            if (item.productId === variant.id) {
                                result.push({
                                    orderId: o.id,
                                    productId: variant.id,
                                    customer: o.customer,
                                    qty: item.qty,
                                    variant: variant.variant,
                                    isAllocated: item.isAllocated
                                });
                            }
                        });
                    });
                });
                return result;
            };

            const debtCustomers = useMemo(() => {
                return customerList.filter(c => c.debt > 0);
            }, [customerList]);

            // --- Âà∞Ë≤®ÁÆ°ÁêÜ (Arrival Management) Ë≥áÊñôËôïÁêÜ ---
            // ‰ΩøÁî® isAllocated ‰æÜÂà§Êñ∑ÊòØÂê¶ "Â∑≤Âà∞Ë≤®/Â∑≤ÈÖçË≤®"
            const arrivalCustomers = useMemo(() => {
                return customerList.map(cust => {
                    const totalItemsCount = cust.items.length;
                    // Ë®àÁÆóÂ∑≤ÈÖçË≤® (isAllocated) ÁöÑÈ†ÖÁõÆÊï∏
                    const arrivedItemsCount = cust.items.filter(i => i.isAllocated).length;
                    const isFullyArrived = totalItemsCount > 0 && totalItemsCount === arrivedItemsCount;
                    
                    return {
                        ...cust,
                        totalItemsCount,
                        arrivedItemsCount,
                        isFullyArrived
                    };
                }).sort((a, b) => {
                    // ÂÖ®Âà∞Ë≤®ÁöÑÊéíÂâçÈù¢
                    if (a.isFullyArrived && !b.isFullyArrived) return -1;
                    if (!a.isFullyArrived && b.isFullyArrived) return 1;
                    return 0;
                });
            }, [customerList]);

            const filteredGroupedProducts = groupedProducts.filter(g => g.name.includes(searchQuery));
            const filteredCustomers = customerList.filter(c => c.name.includes(searchQuery));
            const filteredArrivalCustomers = arrivalCustomers.filter(c => c.name.includes(searchQuery));

            const currentSelectedCustomer = selectedCustomerDetail 
                ? customerList.find(c => c.name === selectedCustomerDetail.name) || selectedCustomerDetail
                : null;
            
            const currentSelectedArrivalCustomer = selectedArrivalCustomer
                ? arrivalCustomers.find(c => c.name === selectedArrivalCustomer.name) || selectedArrivalCustomer
                : null;

            return (
                <div className="min-h-screen pb-24 select-none">
                    {/* ÈÄöÁü• */}
                    {notification && (
                        <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[300] bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 animate-bounce transition-all">
                            <CheckCircle2 size={18} className="text-green-400" />
                            {notification}
                        </div>
                    )}

                    {/* Header */}
                    <div className="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-50">
                        <div className="flex justify-between items-center max-w-2xl mx-auto">
                            <h1 className="text-xl font-bold flex items-center gap-2 cursor-pointer" onClick={() => navigateTo('dashboard')}>
                                <Zap className="fill-yellow-400 text-yellow-400" /> Smart WMS
                            </h1>
                            <div className="bg-indigo-500/50 px-3 py-1 rounded-full text-[10px] font-bold tracking-wider flex items-center gap-1">
                                <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                ÈÄ£Á∑ö‰∏≠
                            </div>
                        </div>
                    </div>

                    {/* Nav */}
                    <div className="bg-white border-b sticky top-[60px] z-40">
                        <div className="flex max-w-2xl mx-auto overflow-x-auto no-scrollbar">
                            {[
                                { id: 'products', label: 'ÂïÜÂìÅÂàóË°®', icon: ShoppingBag },
                                { id: 'dashboard', label: 'ÁãÄÊÖã', icon: LayoutDashboard },
                                { id: 'customers', label: 'È°ßÂÆ¢ÂàóË°®', icon: Users },
                                { id: 'arrivals', label: 'Âà∞Ë≤®ÁÆ°ÁêÜ', icon: BoxSelect },
                            ].map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => navigateTo(item.id)}
                                    className={`flex-1 py-4 px-2 flex flex-col items-center gap-1 text-[10px] font-bold transition-all whitespace-nowrap
                                        ${activeTab === item.id ? 'text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/50' : 'text-slate-400 opacity-70'}`}
                                >
                                    <item.icon size={18} />
                                    {item.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Main Content */}
                    <main className="max-w-2xl mx-auto p-4 space-y-4">
                        {/* ÊêúÂ∞ãÊ¨Ñ‰Ωç */}
                        {activeTab !== 'dashboard' && (
                            <div className="relative animate-in">
                                <input 
                                    type="text" 
                                    placeholder={`ÊêúÂ∞ã${activeTab === 'products' ? 'ÂïÜÂìÅ' : activeTab === 'customers' ? 'È°ßÂÆ¢' : 'Ë®ÇÂñÆ'}...`} 
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="w-full bg-white border-none rounded-2xl p-4 pl-12 shadow-sm focus:ring-2 focus:ring-indigo-500 transition-all text-sm outline-none"
                                />
                                <Search size={18} className="absolute left-4 top-4 text-slate-300" />
                                {searchQuery && <X size={18} className="absolute right-4 top-4 text-slate-300 cursor-pointer" onClick={() => setSearchQuery('')} />}
                            </div>
                        )}

                        {/* View 1: ÂïÜÂìÅÂàóË°® */}
                        {activeTab === 'products' && (
                            <div className="space-y-3 pb-20">
                                {filteredGroupedProducts.map(g => {
                                    const totalOwned = g.totalSpot + g.totalConfirmed;
                                    const shortage = Math.max(0, g.totalAllocated - totalOwned);
                                    
                                    return (
                                        <div 
                                            key={g.name} 
                                            onClick={() => { setSelectedGroupName(g.name); setIsEditingProduct(false); }}
                                            className="bg-white rounded-3xl p-4 flex justify-between items-center shadow-sm border border-slate-100 hover:border-indigo-300 transition-all cursor-pointer active:scale-98 relative overflow-hidden"
                                        >
                                            {shortage > 0 && <div className="absolute left-0 top-0 bottom-0 w-1 bg-rose-500"></div>}
                                            <div className="flex-1 pl-2">
                                                <div className="flex justify-between items-start mb-1">
                                                    <div>
                                                        <h4 className="font-black text-slate-800 text-lg">{g.name}</h4>
                                                        <span className="bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded-full font-bold">{g.variants.length} Ê¨æÂºè</span>
                                                    </div>
                                                    <div className="flex items-start gap-3">
                                                        <div className="text-right">
                                                            <span className="block text-lg font-black text-slate-700">${g.price}</span>
                                                            <span className="text-[10px] text-slate-400">ÂñÆÂÉπ</span>
                                                        </div>
                                                        <button 
                                                            onClick={(e) => handleDeleteProductGroup(g.name, e)}
                                                            className="text-slate-300 hover:text-rose-500 p-3 -mr-2"
                                                        >
                                                            <Trash2 size={20} />
                                                        </button>
                                                    </div>
                                                </div>
                                                <div className="flex gap-4 items-center mt-2 border-t border-slate-50 pt-2">
                                                    <div className="text-xs">
                                                        <span className="text-slate-400">Á∏ΩÂñäÂñÆ </span>
                                                        <span className="font-bold text-slate-800 text-lg">{g.totalAllocated}</span>
                                                    </div>
                                                    <div className="text-xs">
                                                        <span className="text-slate-400">Â∑≤ÈÖç </span>
                                                        <span className={`font-bold text-lg ${g.totalConfirmed > 0 ? 'text-indigo-600' : 'text-slate-300'}`}>{g.totalConfirmed}</span>
                                                    </div>
                                                    <div className="text-xs">
                                                        <span className="text-slate-400">Á∏ΩÁèæË≤® </span>
                                                        <span className={`font-bold text-lg ${g.totalSpot < 0 ? 'text-rose-500' : 'text-slate-800'}`}>{g.totalSpot}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}

                        {/* View 2: Dashboard */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-4 animate-in pb-20">
                                <div className="grid grid-cols-2 gap-4">
                                    <div 
                                        onClick={() => setShowPurchaseList(true)}
                                        className="bg-rose-500 text-white p-4 rounded-3xl shadow-lg shadow-rose-100 relative overflow-hidden cursor-pointer active:scale-95 transition-all"
                                    >
                                        <p className="text-[10px] font-bold opacity-80 relative z-10">ÈúÄË£úË≤®Áµ±Ë®à (ÈªûÊìäÊü•Áúã)</p>
                                        <div className="mt-1 relative z-10">
                                            <p className="text-3xl font-black">{stats.shortageItemCount} <span className="text-sm font-bold opacity-80">Ê¨æ</span></p>
                                            <p className="text-xs opacity-90 mt-1 font-bold">ÂÖ±Áº∫ {stats.totalShortageQty} ‰ª∂</p>
                                        </div>
                                        <div className="absolute -right-4 -bottom-4 bg-white/10 w-24 h-24 rounded-full blur-2xl"></div>
                                    </div>
                                    <div 
                                        onClick={() => setShowDebtList(true)}
                                        className="bg-amber-500 text-white p-4 rounded-3xl shadow-lg shadow-amber-100 cursor-pointer active:scale-95 transition-all relative overflow-hidden"
                                    >
                                        <div className="relative z-10">
                                            <p className="text-[10px] font-bold opacity-80 mb-1">Â∏≥ÂãôÊÉÖÊ≥Å (ÈªûÊìäÊü•Áúã)</p>
                                            <div className="space-y-1">
                                                <div className="flex justify-between items-baseline">
                                                    <span className="text-[10px] opacity-80">Á∏ΩÁáüÊ•≠È°ç</span>
                                                    <span className="text-lg font-bold">${stats.totalRevenue.toLocaleString()}</span>
                                                </div>
                                                {/* ÁßªÈô§‰∫ÜÂæÖÊî∂Ê¨æÈ†ÖÈ°ØÁ§∫ÔºåÂè™‰øùÁïôÈªûÊìäÂäüËÉΩ */}
                                            </div>
                                        </div>
                                        <div className="absolute -right-4 -bottom-4 bg-white/10 w-24 h-24 rounded-full blur-2xl"></div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* View 3: È°ßÂÆ¢ÂàóË°® */}
                        {activeTab === 'customers' && (
                            <div className="space-y-3 pb-20">
                                {filteredCustomers.map((cust, idx) => (
                                    <div key={idx} onClick={() => setSelectedCustomerDetail(cust)} className="bg-white rounded-3xl p-4 shadow-sm border border-slate-100 flex justify-between items-center cursor-pointer active:scale-98">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center font-bold text-sm">{cust.name.charAt(0)}</div>
                                            <div>
                                                <h4 className="font-black text-slate-800">{cust.name}</h4>
                                                <p className="text-[10px] text-slate-400 font-bold">{cust.orderCount} Á≠ÜË®ÇÂñÆ</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <div className="text-right">
                                                <p className="text-lg font-black text-indigo-600">${cust.totalSpent.toLocaleString()}</p>
                                            </div>
                                            {/* È°ßÂÆ¢Âà™Èô§ÊåâÈàï */}
                                            <button 
                                                onClick={(e) => handleDeleteCustomer(cust.name, e)}
                                                className="text-slate-300 hover:text-rose-500 p-3 -mr-2"
                                            >
                                                <Trash2 size={20} />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* View 4: Âà∞Ë≤®ÁÆ°ÁêÜ (ÂéüË®ÇÂñÆÁÆ°ÁêÜ) */}
                        {activeTab === 'arrivals' && (
                            <div className="space-y-4 pb-24">
                                {filteredArrivalCustomers.length === 0 ? (
                                    <div className="text-center p-10 text-slate-400">ÁõÆÂâçÊ≤íÊúâË®ÇÂñÆË≥áÊñô</div>
                                ) : (
                                    filteredArrivalCustomers.map((cust, idx) => {
                                        const progress = cust.totalItemsCount > 0 ? (cust.arrivedItemsCount / cust.totalItemsCount) * 100 : 0;
                                        
                                        return (
                                            <div key={idx} onClick={() => setSelectedArrivalCustomer(cust)} className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden cursor-pointer active:scale-98">
                                                <div className="p-4 flex justify-between items-center">
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${cust.isFullyArrived ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-500'}`}>
                                                            {cust.name.charAt(0)}
                                                        </div>
                                                        <div>
                                                            <h4 className="font-black text-lg text-slate-800 flex items-center gap-2">
                                                                {cust.name}
                                                                {cust.isFullyArrived && <span className="text-[10px] bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full font-bold">ÂÖ®Âà∞Ë≤®</span>}
                                                            </h4>
                                                            <p className="text-[10px] text-slate-400 font-bold">
                                                                ÂÖ± {cust.totalItemsCount} ‰ª∂ÂïÜÂìÅ ¬∑ Â∑≤ÈÖç {cust.arrivedItemsCount} ‰ª∂
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <ChevronRight className="text-slate-300" size={20} />
                                                    </div>
                                                </div>
                                                {/* ÈÄ≤Â∫¶Ê¢ù */}
                                                <div className="h-1.5 w-full bg-slate-50">
                                                    <div 
                                                        className={`h-full transition-all duration-500 ${cust.isFullyArrived ? 'bg-emerald-500' : 'bg-indigo-500'}`} 
                                                        style={{ width: `${progress}%` }}
                                                    ></div>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        )}
                    </main>

                    {/* Footer Quick Action */}
                    <div className="fixed bottom-6 right-6 flex flex-col gap-4 z-[100]">
                        <button 
                            onClick={() => setShowPurchaseList(true)}
                            className="w-12 h-12 bg-slate-800 text-white rounded-full shadow-xl shadow-slate-300 flex items-center justify-center active:scale-95 transition-all"
                        >
                            <Truck size={20} />
                            {stats.outOfStockCount > 0 && <span className="absolute -top-1 -right-1 bg-rose-500 text-white w-5 h-5 rounded-full text-[10px] flex items-center justify-center border-2 border-white">{stats.outOfStockCount}</span>}
                        </button>
                        <button 
                            onClick={() => setShowProxyOrder(true)}
                            className="w-16 h-16 bg-indigo-600 text-white rounded-full shadow-2xl shadow-indigo-300 flex items-center justify-center active:scale-95 transition-all"
                        >
                            <Plus size={32} />
                        </button>
                    </div>

                    {/* Modal: Âà∞Ë≤®Ê™¢Ê†∏ (Arrival Check) - ÈÄôË£°ÁöÑÂãæÈÅ∏Á≠âÂêåÊñºÈÖçË≤® (Allocation) */}
                    {selectedArrivalCustomer && currentSelectedArrivalCustomer && (
                         <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-end md:items-center justify-center z-[150] p-0 md:p-4 animate-in">
                            <div className="bg-white rounded-t-[30px] md:rounded-[30px] w-full max-w-md shadow-2xl h-[85vh] flex flex-col">
                                <div className="p-6 bg-slate-800 text-white shrink-0 relative rounded-t-[30px]">
                                    <button onClick={() => setSelectedArrivalCustomer(null)} className="absolute right-4 top-4 bg-white/10 p-2 rounded-full"><X size={18}/></button>
                                    <h3 className="text-xl font-black">{currentSelectedArrivalCustomer.name}</h3>
                                    <p className="text-slate-400 text-xs font-bold mt-1">Âà∞Ë≤®Ê™¢Ê†∏Ê∏ÖÂñÆ (ÂãæÈÅ∏Âç≥ÈÖçË≤®Êâ£Â∫´Â≠ò)</p>
                                    
                                    <div className="mt-4 bg-white/10 rounded-xl p-3 flex justify-between items-center">
                                        <div className="text-xs text-slate-300">ÈÖçË≤®ÈÄ≤Â∫¶</div>
                                        <div className="font-bold text-white">
                                            {currentSelectedArrivalCustomer.arrivedItemsCount} / {currentSelectedArrivalCustomer.totalItemsCount}
                                        </div>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto p-4 space-y-2 no-scrollbar pb-20">
                                    {currentSelectedArrivalCustomer.items.map((item, idx) => (
                                        <div 
                                            key={idx} 
                                            onClick={() => toggleAllocation(item.orderId, item.productId, item.isAllocated)}
                                            className={`flex justify-between items-center p-3 border rounded-2xl shadow-sm cursor-pointer transition-all ${item.isAllocated ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-slate-100'}`}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className={`w-6 h-6 rounded-lg flex items-center justify-center border transition-all ${item.isAllocated ? 'bg-emerald-500 border-emerald-500 text-white' : 'bg-white border-slate-300 text-transparent'}`}>
                                                    <CheckSquare size={14} />
                                                </div>
                                                <div>
                                                    <div className="flex items-center gap-2">
                                                        <span className="font-bold text-slate-700">{item.name}</span>
                                                        <span className="text-[10px] bg-white border border-slate-200 text-slate-500 px-1.5 py-0.5 rounded">{item.variant}</span>
                                                    </div>
                                                    <span className={`text-[10px] font-bold ${item.isAllocated ? 'text-emerald-600' : 'text-slate-400'}`}>
                                                        {item.isAllocated ? 'Â∑≤ÈÖçË≤®' : 'ÂæÖÊéíÂñÆ'}
                                                    </span>
                                                </div>
                                            </div>
                                            <span className="font-black text-slate-700 text-lg">x{item.qty}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal: ‰ª£ÂÆ¢Âä†ÂñÆ (z-index 200) */}
                    {showProxyOrder && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-end md:items-center justify-center z-[200] p-0 md:p-4 animate-in">
                            <div className="bg-white rounded-t-[30px] md:rounded-[30px] w-full max-w-md shadow-2xl flex flex-col max-h-[90vh] md:max-h-[80vh]">
                                <div className="p-5 border-b border-slate-100 flex justify-between items-center shrink-0">
                                    <div>
                                        <h3 className="font-black text-xl text-slate-800">‰ª£ÂÆ¢Âä†ÂñÆ / Âø´ÈÄüÂÖ•Â∫´</h3>
                                        <p className="text-xs text-slate-400 font-bold">Ëã•‰∏çÂ°´È°ßÂÆ¢ÔºåÂâáË¶ñÁÇ∫Á¥îÂÖ•Â∫´</p>
                                    </div>
                                    <button onClick={() => setShowProxyOrder(false)} className="bg-slate-100 p-2 rounded-full text-slate-500 hover:text-slate-700 active:scale-95"><X size={20} /></button>
                                </div>
                                <div className="p-5 space-y-4 overflow-y-auto no-scrollbar">
                                    {/* ... forms ... */}
                                    <datalist id="productSuggestions">
                                        {[...new Set(products.map(p => p.name))].map(name => <option key={name} value={name} />)}
                                    </datalist>
                                    <datalist id="customerSuggestions">
                                        {customerList.map(c => <option key={c.name} value={c.name} />)}
                                    </datalist>
                                    <datalist id="variantSuggestions">
                                        {availableVariants.map(v => <option key={v} value={v} />)}
                                    </datalist>

                                    <div className="space-y-1">
                                         <label className="text-xs font-bold text-slate-500 ml-1">ÂïÜÂìÅÂêçÁ®±</label>
                                         <input type="text" list="productSuggestions" placeholder="Ëº∏ÂÖ•ÂïÜÂìÅÂêçÁ®±..." className="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 pl-4 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-300" value={proxyForm.productName} onChange={handleProxyProductChange} />
                                    </div>
                                    <div className="space-y-1">
                                         <label className="text-xs font-bold text-slate-500 ml-1">Ê¨æÂºè / Ë¶èÊ†º</label>
                                         <input type="text" list="variantSuggestions" placeholder="‰æãÂ¶ÇÔºöÁ¥ÖËâ≤„ÄÅLËôü..." className="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 pl-4 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-300" value={proxyForm.variant} onChange={(e) => setProxyForm(prev => ({ ...prev, variant: e.target.value }))} />
                                    </div>
                                    <div className="flex gap-2">
                                        <div className="space-y-1 flex-1">
                                            <label className="text-xs font-bold text-slate-500 ml-1">ÂñÆÂÉπ</label>
                                            <input type="number" placeholder="0" className="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 pl-4 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-300" value={proxyForm.price} onChange={(e) => setProxyForm(prev => ({ ...prev, price: e.target.value }))} />
                                        </div>
                                        {proxyForm.customer && (
                                            <div className="space-y-1 w-24 animate-in">
                                                <label className="text-xs font-bold text-slate-500 ml-1">ÂñäÂñÆÈáè</label>
                                                <input type="number" placeholder="1" className="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 text-center text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-300" value={proxyForm.qty} onChange={(e) => setProxyForm(prev => ({ ...prev, qty: e.target.value }))} />
                                            </div>
                                        )}
                                    </div>
                                    <div className="space-y-1">
                                         <label className="text-xs font-bold text-indigo-500 ml-1">Ë≥ºË≤∑Êï∏Èáè (Â°´ÂØ´Âç≥ÂÖ•Â∫´)</label>
                                         <input type="number" placeholder="0" className="w-full bg-indigo-50 border border-indigo-100 rounded-2xl p-4 pl-4 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-300" value={proxyForm.purchasedQty} onChange={(e) => setProxyForm(prev => ({ ...prev, purchasedQty: e.target.value }))} />
                                    </div>
                                    <div className="space-y-1">
                                         <label className="text-xs font-bold text-slate-500 ml-1">È°ßÂÆ¢Êö±Á®± (ÁïôÁ©∫ÁÇ∫Á¥îÂÖ•Â∫´)</label>
                                         <input type="text" list="customerSuggestions" placeholder="Ëº∏ÂÖ•ÂßìÂêç..." className="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 pl-4 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-300" value={proxyForm.customer} onChange={(e) => setProxyForm(prev => ({ ...prev, customer: e.target.value }))} />
                                    </div>
                                    <div className="h-4"></div>
                                </div>
                                <div className="p-4 border-t border-slate-100 bg-white shrink-0 pb-8 md:pb-4">
                                     <button onClick={handleAddOrder} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black flex items-center justify-center gap-2 shadow-lg shadow-indigo-200 active:scale-95 transition-all">
                                        <Plus size={20} /> {proxyForm.customer ? 'Á¢∫Ë™çÂä†ÂñÆ (ÂæÖÊéí)' : 'Á¢∫Ë™çÂÖ•Â∫´'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal: Ê¨†Ê¨æÊ∏ÖÂñÆ */}
                    {showDebtList && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-end md:items-center justify-center z-[150] p-0 md:p-4 animate-in">
                            <div className="bg-white rounded-t-[30px] md:rounded-[30px] w-full max-w-md shadow-2xl h-[85vh] flex flex-col">
                                <div className="bg-amber-500 text-white p-6 relative overflow-hidden rounded-t-[30px] shrink-0">
                                    <h3 className="text-2xl font-black relative z-10">Ê¨†Ê¨æÈ°ßÂÆ¢Ê∏ÖÂñÆ</h3>
                                    <p className="text-amber-100 text-xs font-bold relative z-10">ÈªûÊìäÈ°ßÂÆ¢Êü•ÁúãË©≥ÊÉÖ</p>
                                    <button onClick={() => setShowDebtList(false)} className="absolute top-4 right-4 bg-white/10 p-2 rounded-full hover:bg-white/20"><X size={20}/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2 no-scrollbar pb-20">
                                    {debtCustomers.length === 0 ? (
                                        <div className="text-center p-8 text-slate-400 text-sm">Â§™Ê£í‰∫ÜÔºÅÁõÆÂâçÊ≤íÊúâÊ¨†Ê¨æÈ°ßÂÆ¢ üéâ</div>
                                    ) : (
                                        debtCustomers.map((c, idx) => (
                                            <div key={idx} onClick={() => { setShowDebtList(false); setSelectedCustomerDetail(c); }} className="bg-white rounded-2xl p-4 border border-slate-100 flex justify-between items-center shadow-sm cursor-pointer active:scale-98">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center font-bold text-sm">{c.name.charAt(0)}</div>
                                                    <span className="font-bold text-slate-800">{c.name}</span>
                                                </div>
                                                <span className="font-black text-rose-500 text-lg">${c.debt.toLocaleString()}</span>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal: ÂïÜÂìÅË©≥ÊÉÖ (Á∑®ËºØÊ®°Âºè & ÈÖçÂñÆ) */}
                    {selectedGroupName && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-end md:items-center justify-center z-[150] p-0 md:p-4 animate-in">
                            <div className="bg-white rounded-t-[30px] md:rounded-[30px] w-full max-w-md shadow-2xl h-[85vh] flex flex-col">
                                <div className="p-6 bg-slate-800 text-white shrink-0 relative rounded-t-[30px] flex justify-between items-start">
                                    <div>
                                        <h3 className="text-xl font-black">{selectedGroupName}</h3>
                                        <p className="text-slate-400 text-xs font-bold mt-1">ÊâãÂãïÈÖçÂñÆÊ®°Âºè</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => {
                                            setProxyForm(prev => ({ ...prev, productName: selectedGroupName }));
                                            setShowProxyOrder(true);
                                        }} className="bg-white/20 p-2 rounded-full hover:bg-white/30 text-white" title="Êñ∞Â¢ûÊ≠§ÂïÜÂìÅË®ÇÂñÆ">
                                            <Plus size={18} />
                                        </button>
                                        <button onClick={() => setIsEditingProduct(!isEditingProduct)} className={`p-2 rounded-full ${isEditingProduct ? 'bg-indigo-500 text-white' : 'bg-white/10 text-slate-300'}`}>
                                            <Edit size={18} />
                                        </button>
                                        <button onClick={() => setSelectedGroupName(null)} className="bg-white/10 p-2 rounded-full text-white"><X size={18}/></button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-20">
                                    
                                    {/* 1. Ê¨æÂºèÂ∫´Â≠òË°® (Âê´Â§ö‰ª∂ÂÑ™ÊÉ†Ë®≠ÂÆö) */}
                                    <div className="bg-slate-50 rounded-2xl p-3 border border-slate-100">
                                        <div className="flex justify-between items-center mb-2">
                                            <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Ê¨æÂºèÂ∫´Â≠òÁãÄÊÖã</h4>
                                            {isEditingProduct && <span className="text-[10px] text-indigo-600 font-bold">ÈªûÊìäÊï∏Èáè‰øÆÊîπ</span>}
                                        </div>
                                        <table className="w-full text-xs font-bold">
                                            <thead>
                                                <tr className="text-slate-400 border-b border-slate-200">
                                                    <th className="text-left pb-2">Ê¨æÂºè</th>
                                                    <th className="text-center pb-2 text-indigo-500">Â∑≤ÈÖç</th>
                                                    <th className="text-center pb-2 text-rose-500">ÂæÖÈÖç</th>
                                                    <th className="text-right pb-2 text-slate-800">ÁèæË≤®</th>
                                                    {isEditingProduct && <th className="w-8"></th>}
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {productsWithStats.filter(p=>p.name===selectedGroupName).map(p => (
                                                    <React.Fragment key={p.id}>
                                                        <tr>
                                                            <td className="py-3 text-slate-700">{p.variant}</td>
                                                            <td className="py-3 text-center text-indigo-600">{p.confirmed}</td>
                                                            <td className="py-3 text-center text-rose-500">{p.pending}</td>
                                                            <td className="py-3 text-right">
                                                                {isEditingProduct ? (
                                                                    <input 
                                                                        type="number" 
                                                                        className="w-12 bg-white border border-indigo-200 rounded text-center p-1 text-slate-900"
                                                                        defaultValue={p.spot}
                                                                        onBlur={(e) => handleUpdateProductInfo(p.id, 'spot', e.target.value)}
                                                                    />
                                                                ) : (
                                                                    <span className="text-slate-900">{p.spot}</span>
                                                                )}
                                                            </td>
                                                            {isEditingProduct && (
                                                                <td className="text-right">
                                                                    <button onClick={() => handleDeleteProduct(p.id)} className="text-rose-400 p-1"><Trash2 size={14}/></button>
                                                                </td>
                                                            )}
                                                        </tr>
                                                        {isEditingProduct && (
                                                            <tr className="bg-indigo-50/50">
                                                                <td colSpan="5" className="p-2">
                                                                    <div className="flex items-center gap-2 text-[10px]">
                                                                        <span className="font-bold text-indigo-600">Â§ö‰ª∂ÂÑ™ÊÉ†:</span>
                                                                        <span>Êªø</span>
                                                                        <input 
                                                                            type="number" placeholder="‰ª∂Êï∏" className="w-10 p-1 rounded border border-indigo-200 text-center"
                                                                            defaultValue={p.tierMinQty}
                                                                            onBlur={(e) => handleUpdateProductInfo(p.id, 'tierMinQty', e.target.value)}
                                                                        />
                                                                        <span>‰ª∂ÔºåÂñÆÂÉπËÆä</span>
                                                                        <input 
                                                                            type="number" placeholder="ÈáëÈ°ç" className="w-14 p-1 rounded border border-indigo-200 text-center"
                                                                            defaultValue={p.tierPrice}
                                                                            onBlur={(e) => handleUpdateProductInfo(p.id, 'tierPrice', e.target.value)}
                                                                        />
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        )}
                                                    </React.Fragment>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>

                                    {/* 2. Ë≥ºË≤∑‰∫∫ÈÖçÂñÆÈñãÈóú (Á∂≠ÊåÅÂéüÊ®£) */}
                                    <div>
                                        <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">ÂñäÂñÆÊòéÁ¥∞ (ÈªûÊìäÈÖçÂñÆ)</h4>
                                        <div className="space-y-2">
                                            {getGroupAllocations(selectedGroupName).length === 0 ? (
                                                <p className="text-center text-slate-400 text-sm py-4">ÁÑ°Ë≥áÊñô</p>
                                            ) : (
                                                getGroupAllocations(selectedGroupName).map((record, idx) => (
                                                    <div key={idx} className={`flex justify-between items-center p-3 border rounded-2xl shadow-sm transition-all ${record.isAllocated ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100'}`}>
                                                        <div className="flex items-center gap-3">
                                                            <button 
                                                                onClick={() => toggleAllocation(record.orderId, record.productId, record.isAllocated)}
                                                                className={`w-6 h-6 rounded-lg flex items-center justify-center border transition-all ${record.isAllocated ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white border-slate-300 text-transparent'}`}
                                                            >
                                                                <CheckSquare size={14} />
                                                            </button>
                                                            <div>
                                                                <div className="flex items-center gap-2">
                                                                    <span className="font-bold text-slate-700">{record.customer}</span>
                                                                    <span className="text-[10px] bg-white border border-slate-200 text-slate-500 px-1.5 py-0.5 rounded">{record.variant}</span>
                                                                </div>
                                                                <span className={`text-[10px] font-bold ${record.isAllocated ? 'text-indigo-600' : 'text-slate-400'}`}>
                                                                    {record.isAllocated ? 'Â∑≤ÈÖçÂà∞Ë≤®' : 'ÂæÖÊéíÂñÆ'}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <span className="font-black text-slate-700 text-lg">x{record.qty}</span>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal: È°ßÂÆ¢Ë©≥ÊÉÖ (ÁßªÈô§Êî∂Ê¨æÊåâÈàï) */}
                    {selectedCustomerDetail && currentSelectedCustomer && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-end md:items-center justify-center z-[160] p-0 md:p-4 animate-in">
                            <div className="bg-white rounded-t-[30px] md:rounded-[30px] w-full max-w-md shadow-2xl h-[85vh] flex flex-col">
                                {/* Header */}
                                <div className="p-6 bg-indigo-600 text-white shrink-0 relative rounded-t-[30px] flex justify-between">
                                    <div>
                                        <h3 className="text-xl font-black">{currentSelectedCustomer.name}</h3>
                                        <div className="flex flex-col gap-1 mt-2">
                                            <span className="text-indigo-200 text-xs font-bold">Ê∂àË≤ªÁ∏ΩÈ°ç ${currentSelectedCustomer.totalSpent.toLocaleString()}</span>
                                            {/* Â∑≤‰ªòÈáëÈ°çËàáÊ¨†Ê¨æÈ°ØÁ§∫ */}
                                            {currentSelectedCustomer.debt > 0 ? (
                                                <span className="text-rose-300 text-xs font-bold">Ê¨† ${currentSelectedCustomer.debt.toLocaleString()}</span>
                                            ) : (
                                                <span className="text-white/50 text-xs font-bold">‚úÖ Â∑≤ÁµêÊ∏Ö</span>
                                            )}
                                        </div>
                                    </div>
                                    <div className="flex gap-2 items-start">
                                        <button onClick={() => {
                                            setProxyForm(prev => ({ ...prev, customer: currentSelectedCustomer.name }));
                                            setShowProxyOrder(true);
                                        }} className="bg-white/20 p-2 rounded-full hover:bg-white/30 text-white" title="Âä†ÂñÆ">
                                            <Plus size={18} />
                                        </button>
                                        <button onClick={() => handleCopyCustomerDetails(currentSelectedCustomer)} className="bg-white/20 p-2 rounded-full hover:bg-white/30 text-white" title="Ë§áË£ΩÊòéÁ¥∞">
                                            <Copy size={18} />
                                        </button>
                                        <button onClick={() => setSelectedCustomerDetail(null)} className="bg-white/10 p-2 rounded-full hover:bg-white/20 text-white"><X size={18}/></button>
                                    </div>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto p-4 space-y-2 no-scrollbar pb-20">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Ë≥ºÁâ©ÊòéÁ¥∞ (ÈªûÊìäÊï∏Èáè‰øÆÊîπ)</h4>
                                    {currentSelectedCustomer.items.map((item, idx) => (
                                        <div key={idx} className="flex justify-between items-center p-3 border-b border-slate-50 last:border-0 group">
                                            <div>
                                                <p className="font-bold text-slate-800 text-sm flex items-center gap-1">
                                                    {item.name} 
                                                    {item.isDiscounted && <span className="text-[10px] bg-rose-100 text-rose-600 px-1 rounded font-bold">ÂÑ™ÊÉ†</span>}
                                                </p>
                                                <span className="text-xs font-normal text-slate-500">({item.variant})</span>
                                                <p className="text-xs text-slate-400 mt-0.5">${item.finalPrice} x {item.qty}</p>
                                            </div>
                                            <div className="text-right flex flex-col items-end gap-1">
                                                <div className="flex items-center gap-2">
                                                    {editingOrderQtyId === `${item.orderId}-${item.productId}` ? (
                                                        <input 
                                                            autoFocus
                                                            type="number"
                                                            className="w-12 bg-slate-100 border border-indigo-300 rounded text-center font-bold text-sm p-1 outline-none"
                                                            defaultValue={item.qty}
                                                            onBlur={(e) => handleUpdateOrderQty(item.orderId, item.productId, e.target.value)}
                                                            onKeyDown={(e) => {
                                                                if (e.key === 'Enter') handleUpdateOrderQty(item.orderId, item.productId, e.target.value);
                                                            }}
                                                        />
                                                    ) : (
                                                        <span className="font-bold text-slate-900 block">${item.itemTotal}</span>
                                                    )}
                                                    
                                                    {/* Á∑®ËºØÊåâÈàï */}
                                                    <button 
                                                        onClick={() => setEditingOrderQtyId(`${item.orderId}-${item.productId}`)}
                                                        className="text-slate-400 hover:text-indigo-600 p-1"
                                                    >
                                                        <Edit size={14} />
                                                    </button>
                                                    {/* Âà™Èô§ÂñÆÁ≠ÜÂïÜÂìÅÊåâÈàï */}
                                                    <button 
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            handleDeleteOrderItem(item.orderId, item.productId);
                                                        }}
                                                        className="text-slate-300 hover:text-rose-600 p-1 bg-slate-50 rounded-full"
                                                        title="Âà™Èô§Ê≠§ÂïÜÂìÅ"
                                                    >
                                                        <Trash2 size={16} />
                                                    </button>
                                                </div>
                                                <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${item.isAllocated ? 'bg-indigo-100 text-indigo-600' : 'bg-slate-100 text-slate-400'}`}>
                                                    {item.isAllocated ? 'Â∑≤ÈÖçË≤®' : 'ÂæÖÊéíÂñÆ'}
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal: Âª†ÂïÜÊé°Ë≥ºÂñÆ (È°ØÁ§∫Á≤æÊ∫ñÁº∫Ë≤®Êï∏Â≠ó) */}
                    {showPurchaseList && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-end md:items-center justify-center z-[150] p-0 md:p-4 animate-in">
                            <div className="bg-white rounded-t-[30px] md:rounded-[30px] w-full max-w-md shadow-2xl h-[85vh] flex flex-col">
                                <div className="bg-slate-800 text-white p-6 relative overflow-hidden rounded-t-[30px] shrink-0">
                                    <Truck className="absolute -right-6 -top-6 text-slate-700 w-32 h-32 opacity-50" />
                                    <h3 className="text-2xl font-black relative z-10">Âª†ÂïÜÊé°Ë≥ºÊ∏ÖÂñÆ</h3>
                                    <p className="text-slate-400 text-xs font-bold relative z-10">Purchase Order (Áº∫Ë≤®Áµ±Ë®à)</p>
                                    <button onClick={() => setShowPurchaseList(false)} className="absolute top-4 right-4 bg-white/10 p-2 rounded-full hover:bg-white/20"><X size={20}/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-2 no-scrollbar">
                                    {purchaseList.length === 0 ? (
                                        <div className="p-8 text-center text-slate-400 font-bold">ÁõÆÂâçÂ∫´Â≠òÂÖÖË∂≥ÔºåÁÑ°ÈúÄÊé°Ë≥º üéâ</div>
                                    ) : (
                                        purchaseList.map((p, idx) => (
                                            <div key={p.id} className="flex justify-between items-center p-4 border-b border-slate-50 last:border-0">
                                                <div className="flex items-center gap-3">
                                                    <span className="text-slate-300 font-mono text-xs font-bold">{idx + 1}</span>
                                                    <div>
                                                        <p className="font-bold text-slate-800">{p.name}</p>
                                                        <p className="text-[10px] text-slate-400">{p.variant}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-xs text-slate-400 font-bold mb-1">Áº∫</p>
                                                    <div className="bg-rose-50 text-rose-600 px-3 py-1 rounded-lg font-black text-lg">
                                                        {p.shortage}
                                                    </div>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
