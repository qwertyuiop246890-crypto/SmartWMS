<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Êô∫ÊÖßÈÄ£Á∑öÂÄâÂ∫´ÁÆ°ÁêÜÁ≥ªÁµ±</title>
    
    <!-- 1. ËºâÂÖ• Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ËºâÂÖ• Babel Áî®ÊñºËß£Êûê JSX (Ëàá ESM ÈÖçÂêà) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        * { -webkit-tap-highlight-color: transparent; }
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #4F46E5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4F46E5; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';
        import { 
            LayoutDashboard, Package, ShoppingCart, Users, Zap, Plus, ArrowRight, AlertCircle, 
            CheckCircle2, Combine, Split, MessageCircle, Truck, DollarSign, Search, Filter, 
            X, ChevronRight, ChevronUp, ClipboardList, User, ShoppingBag, ListOrdered, Tag, 
            Layers, Archive, CheckSquare, Square, Trash2, Edit, Save, Copy, CreditCard, 
            RotateCcw, Minus, TrendingUp, Wallet, BoxSelect, Undo2, PackageCheck, FileSpreadsheet
        } from 'https://esm.sh/lucide-react@0.263.1?dev';

        // Firebase Imports (‰øÆÊ≠£ÁâàÊú¨ËôüÁÇ∫Á©©ÂÆöÁâà 10.13.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, setDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const App = () => {
            const [user, setUser] = useState(null);
            const [products, setProducts] = useState([]);
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);

            // UI States
            const [activeTab, setActiveTab] = useState('products');
            const [showProxyOrder, setShowProxyOrder] = useState(false);
            const [showPurchaseList, setShowPurchaseList] = useState(false);
            const [showRevenueList, setShowRevenueList] = useState(false);
            
            const [selectedGroupName, setSelectedGroupName] = useState(null); 
            const [selectedCustomerDetail, setSelectedCustomerDetail] = useState(null);
            
            // Âà∞Ë≤®ÁÆ°ÁêÜÈÅ∏‰∏≠ÁöÑÈ°ßÂÆ¢ (ÂåÖÂê´ source: 'pending' | 'shipped')
            const [selectedArrivalCustomer, setSelectedArrivalCustomer] = useState(null); 
            
            const [isEditingProduct, setIsEditingProduct] = useState(false);
            const [showPaymentInput, setShowPaymentInput] = useState(false);
            const [paymentAmount, setPaymentAmount] = useState('');
            
            const [editingOrderQtyId, setEditingOrderQtyId] = useState(null);
            const [editingAllocatedQtyId, setEditingAllocatedQtyId] = useState(null);
            const [editingArrivedQtyId, setEditingArrivedQtyId] = useState(null);
            const [editingPurchaseQtyId, setEditingPurchaseQtyId] = useState(null);

            const [proxyForm, setProxyForm] = useState({
                productName: '',
                variant: '', 
                price: '',
                customer: '',
                qty: 1,
                purchasedQty: 0
            });

            const [notification, setNotification] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');

            // --- Firebase Auth & Sync ---
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user) return;

                const unsubProducts = onSnapshot(
                    collection(db, 'artifacts', appId, 'public', 'data', 'products'),
                    (snapshot) => {
                        const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setProducts(list);
                        if (list.length === 0 && !snapshot.metadata.hasPendingWrites) {
                             const initialProducts = [
                                { name: 'Êó•Êú¨Ê•µËá¥ÂêπÈ¢®Ê©ü', variant: 'ÁèçÁè†ÁôΩ', spot: 2, price: 3200, tierMinQty: 0, tierPrice: 0 },
                                { name: 'Êó•Êú¨Ê•µËá¥ÂêπÈ¢®Ê©ü', variant: 'Ê∂àÂÖâÈªë', spot: 3, price: 3200, tierMinQty: 0, tierPrice: 0 },
                                { name: 'Ê≥ïÂºèÈªëÂ∑ßÂÖãÂäõÁõí', variant: 'ÂñÆ‰∏ÄÊ¨æÂºè', spot: 20, price: 450, tierMinQty: 0, tierPrice: 0 },
                                { name: 'ÈüìÂúãÈôêÂÆöÈÅãÂãïÈûã', variant: '24cm', spot: 0, price: 2800, tierMinQty: 0, tierPrice: 0 },
                                { name: 'ËÜ†ÂéüËõãÁôΩÁ≤â', variant: 'ÁΩêË£ù', spot: 30, price: 980, tierMinQty: 0, tierPrice: 0 },
                                { name: 'Áí∞‰øùË≥ºÁâ©Ë¢ã', variant: 'ËóçËâ≤', spot: 2, price: 150, tierMinQty: 0, tierPrice: 0 },
                            ];
                            initialProducts.forEach(p => addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), p));
                        }
                    },
                    (error) => console.error("Products sync error:", error)
                );

                const unsubOrders = onSnapshot(
                    collection(db, 'artifacts', appId, 'public', 'data', 'orders'),
                    (snapshot) => {
                        const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setOrders(list);
                        setLoading(false);
                    },
                    (error) => console.error("Orders sync error:", error)
                );

                return () => {
                    unsubProducts();
                    unsubOrders();
                };
            }, [user]);

            const notify = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            // --- Core Logic Calculations ---

            const productsWithStats = useMemo(() => {
                return products.map(p => {
                    let allocated = 0; 
                    let confirmed = 0; 

                    orders.forEach(o => {
                        if (o.items) {
                            o.items.forEach(item => {
                                if (item.productId === p.id) {
                                    allocated += (item.qty || 0);
                                    confirmed += (item.allocatedQty || 0);
                                }
                            });
                        }
                    });

                    const pending = allocated - confirmed;
                    const totalOwned = (p.spot || 0) + confirmed;
                    const shortage = Math.max(0, allocated - totalOwned);

                    return { ...p, allocated, confirmed, pending, shortage };
                });
            }, [products, orders]);

            const customerList = useMemo(() => {
                const map = {};
                
                orders.forEach(o => {
                    if (!map[o.customer]) {
                        map[o.customer] = { 
                            name: o.customer, 
                            totalSpent: 0, 
                            totalPaid: o.paid || 0,
                            orderCount: 0, 
                            debt: 0, 
                            items: [],
                            rawItems: []
                        };
                    }
                    else {
                        map[o.customer].totalPaid += (o.paid || 0);
                    }
                    map[o.customer].orderCount += 1;
                    
                    if (o.items) {
                        o.items.forEach(item => {
                            map[o.customer].rawItems.push({ ...item, orderId: o.id });
                        });
                    }
                });

                Object.values(map).forEach(cust => {
                    const nameCounts = {};
                    cust.rawItems.forEach(item => {
                        const productInfo = products.find(p => p.id === item.productId);
                        const productName = productInfo ? productInfo.name : item.name;
                        if (!nameCounts[productName]) nameCounts[productName] = 0;
                        nameCounts[productName] += item.qty;
                    });

                    cust.rawItems.forEach(item => {
                        const productInfo = products.find(p => p.id === item.productId);
                        
                        let finalPrice = item.price;
                        let originalPrice = item.price;
                        let tierMinQty = 0;
                        let tierPrice = 0;

                        if (productInfo) {
                            originalPrice = productInfo.price;
                            tierMinQty = productInfo.tierMinQty;
                            tierPrice = productInfo.tierPrice;
                            const pName = productInfo.name;
                            if (tierMinQty > 0 && nameCounts[pName] >= tierMinQty) {
                                finalPrice = tierPrice;
                            }
                        }

                        const itemTotal = item.qty * finalPrice;
                        
                        cust.items.push({
                            ...item,
                            finalPrice: finalPrice, 
                            isDiscounted: finalPrice < originalPrice, 
                            itemTotal: itemTotal,
                            isAllocated: (item.allocatedQty || 0) >= item.qty
                        });
                        cust.totalSpent += itemTotal;
                    });

                    cust.debt = Math.max(0, cust.totalSpent - cust.totalPaid);
                });

                return Object.values(map);
            }, [orders, products]);

            const stats = useMemo(() => {
                const totalDebt = customerList.reduce((acc, curr) => acc + curr.debt, 0);
                const totalRevenue = customerList.reduce((acc, curr) => acc + curr.totalSpent, 0); 

                let shortageItemCount = 0; 
                let totalShortageQty = 0;  

                productsWithStats.forEach(p => {
                    if (p.shortage > 0) {
                        shortageItemCount += 1;
                        totalShortageQty += p.shortage;
                    }
                });

                return { totalDebt, totalRevenue, shortageItemCount, totalShortageQty };
            }, [productsWithStats, customerList]); 

            // 4. Âà∞Ë≤®ÁÆ°ÁêÜË≥áÊñô (Split into Pending and Shipped)
            const { pendingArrivalCustomers, shippedArrivalCustomers } = useMemo(() => {
                const pendingMap = {};
                const shippedMap = {};

                orders.forEach(o => {
                    // Â∑≤Âá∫Ë≤®ÁöÑË®ÇÂñÆÈÄ≤ÂÖ• shippedMapÔºåÂÖ∂È§òÈÄ≤ÂÖ• pendingMap
                    const targetMap = o.status === 'Â∑≤Âá∫Ë≤®' ? shippedMap : pendingMap;
                    
                    if (!targetMap[o.customer]) {
                        targetMap[o.customer] = { name: o.customer, items: [] };
                    }
                    if (o.items) {
                        o.items.forEach(item => {
                            targetMap[o.customer].items.push({
                                ...item,
                                orderId: o.id,
                                isShipped: o.status === 'Â∑≤Âá∫Ë≤®'
                            });
                        });
                    }
                });

                const processMap = (map, source) => {
                    return Object.values(map).map(cust => {
                        const totalItemsCount = cust.items.length; 
                        const arrivedItemsCount = cust.items.filter(i => (i.allocatedQty || 0) >= i.qty).length; 
                        
                        const totalQty = cust.items.reduce((sum, i) => sum + i.qty, 0); 
                        const allocatedQty = cust.items.reduce((sum, i) => sum + (i.allocatedQty || 0), 0);

                        const isFullyArrived = totalItemsCount > 0 && totalItemsCount === arrivedItemsCount;
                        
                        return {
                            ...cust,
                            source, // Ê®ôË®ò‰æÜÊ∫ê
                            totalItemsCount,
                            arrivedItemsCount,
                            totalQty,
                            allocatedQty,
                            isFullyArrived
                        };
                    }).sort((a, b) => {
                        // ÂÖ®Âà∞Ë≤®ÁöÑÊéíÂâçÈù¢
                        if (a.isFullyArrived && !b.isFullyArrived) return -1;
                        if (!a.isFullyArrived && b.isFullyArrived) return 1;
                        return 0;
                    });
                };

                return {
                    pendingArrivalCustomers: processMap(pendingMap, 'pending'),
                    shippedArrivalCustomers: processMap(shippedMap, 'shipped')
                };
            }, [orders, products]); // ‰æùË≥¥ orders Âíå products

            // *** ÈóúÈçµ‰øÆÊ≠£ÔºöÂú®Ê≠§ËôïÂÆöÁæ© selected objectsÔºåÁ¢∫‰øùËÆäÊï∏Â∑≤ÂÆ£Âëä ***
            
            // Á¢∫‰øùÈÅ∏‰∏≠Áâ©‰ª∂Êõ¥Êñ∞ (‰ΩøÁî® useMemo ‰∏≠ÁöÑ customerList ‰æÜÊü•Êâæ)
            const currentSelectedCustomer = selectedCustomerDetail 
                ? customerList.find(c => c.name === selectedCustomerDetail.name) || selectedCustomerDetail
                : null;
            
            // ‰øÆÊ≠£ÔºöÂú®Ê∏≤ÊüìÊôÇÂãïÊÖãÊü•ÊâæÂ∞çÊáâÊ∏ÖÂñÆ‰∏≠ÁöÑÈ°ßÂÆ¢Áâ©‰ª∂
            const currentSelectedArrivalCustomer = selectedArrivalCustomer
                ? (
                    // ÂÖàÁúãËÉΩ‰∏çËÉΩÂú®ÂæÖÂá∫Ë≤®ÊâæÂà∞
                    pendingArrivalCustomers.find(c => c.name === selectedArrivalCustomer.name) ||
                    // ÂÜçÁúãËÉΩ‰∏çËÉΩÂú®Â∑≤Âá∫Ë≤®ÊâæÂà∞
                    shippedArrivalCustomers.find(c => c.name === selectedArrivalCustomer.name) ||
                    // Ëã•ÈÉΩÊâæ‰∏çÂà∞ÔºåÂõûÂÇ≥ÂéüÊú¨ÁöÑ
                    selectedArrivalCustomer
                  )
                : null;

            // Âà§Êñ∑ÊòØÂê¶ÁÇ∫Â∑≤Âá∫Ë≤®ÁãÄÊÖã (Áî®Êñº UI È°ØÁ§∫)
            const isArrivalShipped = currentSelectedArrivalCustomer && !orders.some(o => o.customer === currentSelectedArrivalCustomer.name && o.status !== 'Â∑≤Âá∫Ë≤®');


            // 5. ÊêúÂ∞ãËàáÈÅéÊøæ
            const purchaseList = useMemo(() => productsWithStats.filter(p => p.shortage > 0).map(p => ({ ...p })), [productsWithStats]);
            
            const revenueCustomers = useMemo(() => {
                return customerList.filter(c => c.totalSpent > 0).sort((a, b) => b.totalSpent - a.totalSpent);
            }, [customerList]);

            const groupedProducts = useMemo(() => {
                const groups = {};
                productsWithStats.forEach(p => {
                    if (!groups[p.name]) {
                        groups[p.name] = { name: p.name, price: p.price, totalAllocated: 0, totalConfirmed: 0, totalSpot: 0, variants: [] };
                    }
                    groups[p.name].totalAllocated += p.allocated;
                    groups[p.name].totalConfirmed += p.confirmed;
                    groups[p.name].totalSpot += (p.spot || 0);
                    groups[p.name].variants.push(p);
                });
                return Object.values(groups);
            }, [productsWithStats]);

            const filteredGroupedProducts = groupedProducts.filter(g => g.name.includes(searchQuery));
            const filteredCustomers = customerList.filter(c => c.name.includes(searchQuery));
            
            const filteredPendingArrivals = pendingArrivalCustomers.filter(c => c.name.includes(searchQuery));
            const filteredShippedArrivals = shippedArrivalCustomers.filter(c => c.name.includes(searchQuery));
            
            const availableVariants = useMemo(() => {
                if (!proxyForm.productName) return [];
                return [...new Set(products.filter(p => p.name === proxyForm.productName).map(p => p.variant))];
            }, [products, proxyForm.productName]);

            // --- Handlers (Firestore Actions) ---

            const updateOrderDoc = async (orderId, data) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId), data);
                } catch (err) {
                    console.error("Update Order Error", err);
                    notify("Êõ¥Êñ∞Ë®ÇÂñÆÂ§±Êïó");
                }
            };

            const updateProductDoc = async (productId, data) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', productId), data);
                } catch (err) {
                    console.error("Update Product Error", err);
                    notify("Êõ¥Êñ∞ÂïÜÂìÅÂ§±Êïó");
                }
            };

            const handleUpdateOrderQty = async (orderId, productId, newQtyStr) => {
                const newQty = parseInt(newQtyStr, 10);
                if (isNaN(newQty) || newQty < 0) return;
                
                const order = orders.find(o => o.id === orderId);
                if (!order) return;
                
                const newItems = order.items.map(item => item.productId === productId ? { ...item, qty: newQty } : item).filter(item => item.qty > 0);
                
                if (newItems.length === 0) {
                    if(confirm("ÂïÜÂìÅÊï∏ÈáèÊ≠∏Èõ∂ÔºåÊòØÂê¶Âà™Èô§Ê≠§Ë®ÇÂñÆÔºü")) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId));
                    }
                } else {
                    await updateOrderDoc(orderId, { items: newItems });
                }
                
                setEditingOrderQtyId(null);
                notify("Êï∏ÈáèÂ∑≤Êõ¥Êñ∞");
            };

            const handleUpdateAllocatedQty = async (orderId, productId, newAllocatedQtyStr) => {
                const newAllocated = parseInt(newAllocatedQtyStr, 10);
                if (isNaN(newAllocated) || newAllocated < 0) return;

                const order = orders.find(o => o.id === orderId);
                const item = order?.items.find(i => i.productId === productId);
                const product = products.find(p => p.id === productId);

                if (!item || !product) return;
                if (newAllocated > item.qty) { notify(`ÈÖçË≤®‰∏çÂèØÂ§ßÊñºÂñäÂñÆÊï∏`); setEditingAllocatedQtyId(null); return; }

                const diff = newAllocated - (item.allocatedQty || 0);

                const newItems = order.items.map(i => i.productId === productId ? { ...i, allocatedQty: newAllocated } : i);
                await updateOrderDoc(orderId, { items: newItems });
                await updateProductDoc(productId, { spot: (product.spot || 0) - diff });

                setEditingAllocatedQtyId(null);
            };

            const handleUpdatePurchaseQty = async (productId, newShortageStr) => {
                const newShortage = parseInt(newShortageStr, 10);
                if (isNaN(newShortage) || newShortage < 0) return;

                const product = productsWithStats.find(p => p.id === productId);
                if (!product) return;

                const newSpot = product.allocated - product.confirmed - newShortage;
                
                await updateProductDoc(productId, { spot: newSpot });
                setEditingPurchaseQtyId(null);
                notify(`Â∫´Â≠òÂ∑≤Ë™øÊï¥`);
            };

            const handleDeleteOrderItem = async (orderId, productId) => {
                if(!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÂïÜÂìÅÂóéÔºüÂà™Èô§ÂæåÈáëÈ°çÂ∞áÈáçÊñ∞Ë®àÁÆó„ÄÇ')) return;
                
                const order = orders.find(o => o.id === orderId);
                const itemToRemove = order?.items.find(i => i.productId === productId);
                
                if (!itemToRemove) return;

                if ((itemToRemove.allocatedQty || 0) > 0) {
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        await updateProductDoc(productId, { spot: (product.spot || 0) + itemToRemove.allocatedQty });
                    }
                }

                const newItems = order.items.filter(i => i.productId !== productId);
                if (newItems.length === 0) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId));
                } else {
                    await updateOrderDoc(orderId, { items: newItems });
                }
                
                notify("Â∑≤Âà™Èô§ÂïÜÂìÅ");
            };

            const toggleAllocation = async (orderId, productId, currentAllocated, totalQty) => {
                const newAllocated = currentAllocated >= totalQty ? 0 : totalQty;
                const diff = newAllocated - currentAllocated;
                
                const product = products.find(p => p.id === productId);
                if (!product) return;

                if (diff > 0 && (product.spot || 0) < diff) notify("‚ö†Ô∏è Ê≥®ÊÑèÔºöÁèæË≤®‰∏çË∂≥");

                const order = orders.find(o => o.id === orderId);
                const newItems = order.items.map(item => item.productId === productId ? { ...item, allocatedQty: newAllocated } : item);
                
                await updateOrderDoc(orderId, { items: newItems });
                await updateProductDoc(productId, { spot: (product.spot || 0) - diff });
            };

            const handleAddOrder = async () => {
                const { productName, variant, price, customer, qty, purchasedQty } = proxyForm;
                const finalVariant = variant || 'ÂñÆ‰∏ÄÊ¨æÂºè';
                if (!productName || !price) { notify('Ë´ãÂ°´ÂØ´ÂÆåÊï¥Ë≥áË®ä'); return; }

                const quantity = parseInt(qty, 10) || 1;
                const pQty = parseInt(purchasedQty, 10) || 0;
                const finalPrice = parseInt(price, 10) || 0;

                let targetProduct = products.find(p => p.name === productName && p.variant === finalVariant);
                let productId = targetProduct?.id;

                if (!targetProduct) {
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), {
                        name: productName, variant: finalVariant, price: finalPrice, spot: pQty, tierMinQty: 0, tierPrice: 0
                    });
                    productId = docRef.id;
                } else if (pQty > 0) {
                    await updateProductDoc(productId, { spot: (targetProduct.spot || 0) + pQty });
                }

                if (customer) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
                        customer, 
                        total: finalPrice * quantity, 
                        paid: 0, 
                        status: 'ÂæÖÁµêÂñÆ', 
                        items: [{ productId, name: productName, variant: finalVariant, qty: quantity, price: finalPrice, allocatedQty: 0 }],
                        debt: 0, 
                        unclaimed: 0
                    });
                    notify(`Âä†ÂñÆÊàêÂäü`);
                } else {
                    notify(`Â∑≤ÂÖ•Â∫´`);
                }
                setShowProxyOrder(false);
                setProxyForm({ productName: '', variant: '', price: '', customer: '', qty: 1, purchasedQty: 0 });
            };

            const handleCustomerPayment = async () => {
                const amount = parseInt(paymentAmount, 10);
                if (isNaN(amount) || amount === 0 || !selectedCustomerDetail) return;
                
                const customerOrders = orders.filter(o => o.customer === selectedCustomerDetail.name);
                let remaining = Math.abs(amount);
                const isRefund = amount < 0;

                const batch = writeBatch(db);

                customerOrders.forEach(order => {
                    const orderRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', order.id);
                    const orderTotal = order.items.reduce((sum, i) => sum + i.qty * i.price, 0); 
                    const currentDebt = Math.max(0, orderTotal - (order.paid || 0));
                    
                    if (remaining > 0) {
                        if (!isRefund && currentDebt > 0) {
                            const pay = Math.min(currentDebt, remaining);
                            remaining -= pay;
                            batch.update(orderRef, { paid: (order.paid || 0) + pay });
                        } else if (isRefund && (order.paid || 0) > 0) {
                            const ref = Math.min(order.paid, remaining);
                            remaining -= ref;
                            batch.update(orderRef, { paid: (order.paid || 0) - ref });
                        }
                    }
                });
                
                await batch.commit();
                setPaymentAmount('');
                setShowPaymentInput(false);
                notify("ÈáëÈ°çÊõ¥Êñ∞ÊàêÂäü");
            };

            const handleShipCustomer = async (customerName) => {
                if(!window.confirm(`Á¢∫Ë™çÂ∞á ${customerName} ÁöÑÊâÄÊúâÂïÜÂìÅÊ®ôË®òÁÇ∫„ÄåÂ∑≤Âá∫Ë≤®„ÄçÂóéÔºü`)) return;
                
                const targetOrders = orders.filter(o => o.customer === customerName && o.status !== 'Â∑≤Âá∫Ë≤®');
                const batch = writeBatch(db);
                
                targetOrders.forEach(o => {
                    batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'orders', o.id), { status: 'Â∑≤Âá∫Ë≤®' });
                });
                
                await batch.commit();
                setSelectedArrivalCustomer(null);
                notify(`${customerName} Â∑≤Âá∫Ë≤®`);
            };

            const handleUnshipCustomer = async (customerName) => {
                if(!window.confirm(`ÂõûÂæ© ${customerName} ÁÇ∫„ÄåÂæÖÂá∫Ë≤®„ÄçÔºü`)) return;
                
                const targetOrders = orders.filter(o => o.customer === customerName && o.status === 'Â∑≤Âá∫Ë≤®');
                const batch = writeBatch(db);
                
                targetOrders.forEach(o => {
                    batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'orders', o.id), { status: 'ÂæÖÁµêÂñÆ' });
                });
                
                await batch.commit();
                setSelectedArrivalCustomer(null);
                notify(`Â∑≤ÂõûÂæ©`);
            };

            const handleDeleteCustomer = async (customerName, e) => {
                e.stopPropagation();
                if(confirm(`Âà™Èô§È°ßÂÆ¢ ${customerName} ÊâÄÊúâË≥áÊñôÔºü`)) {
                    const targetOrders = orders.filter(o => o.customer === customerName);
                    const batch = writeBatch(db);
                    targetOrders.forEach(o => {
                        batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'orders', o.id));
                    });
                    await batch.commit();
                    if (selectedCustomerDetail?.name === customerName) setSelectedCustomerDetail(null);
                    notify("Â∑≤Âà™Èô§È°ßÂÆ¢");
                }
            };
            
            const handleUpdateProductInfo = async (productId, field, value) => {
                const val = parseInt(value, 10);
                if (isNaN(val)) return;
                const targetProduct = products.find(p => p.id === productId);
                const targetName = targetProduct?.name;
                
                if (field.startsWith('tier')) {
                    const sameNameProducts = products.filter(p => p.name === targetName);
                    const batch = writeBatch(db);
                    sameNameProducts.forEach(p => {
                        batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'products', p.id), { [field]: val });
                    });
                    await batch.commit();
                } else {
                    await updateProductDoc(productId, { [field]: val });
                }
            };

            const handleDeleteProduct = async (productId) => {
                if(confirm("Âà™Èô§Ê≠§Ê¨æÂºèÔºü")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', productId));
                    notify("Â∑≤Âà™Èô§Ê¨æÂºè");
                }
            };
            
            const handleDeleteProductGroup = async (groupName, e) => {
                e.stopPropagation();
                if(confirm(`Âà™Èô§ÂïÜÂìÅ ${groupName}Ôºü`)) {
                    const targets = products.filter(p => p.name === groupName);
                    const batch = writeBatch(db);
                    targets.forEach(p => batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'products', p.id)));
                    await batch.commit();
                    if (selectedGroupName === groupName) setSelectedGroupName(null);
                    notify("Â∑≤Âà™Èô§ÂïÜÂìÅ");
                }
            };

            // Helpers
            const navigateTo = (tab) => { setActiveTab(tab); setSearchQuery(''); };
            const handleProxyProductChange = (e) => {
                const name = e.target.value;
                const existing = products.find(p => p.name === name);
                setProxyForm(prev => ({ ...prev, productName: name, price: existing ? existing.price : prev.price }));
            };
            const handleCopyCustomerDetails = (customer) => {
                 let itemsText = '';
                customer.items.forEach(item => {
                    const priceDisplay = item.isDiscounted ? `$${item.finalPrice} (ÂÑ™ÊÉ†)` : `$${item.finalPrice}`;
                    itemsText += `- ${item.name} ${item.variant !== 'ÂñÆ‰∏ÄÊ¨æÂºè' && item.variant ? `(${item.variant})` : ''} x${item.qty} ${priceDisplay}\n`;
                });
                const text = `Ë¶™ÊÑõÁöÑ ${customer.name} ÊÇ®Â•ΩÔºå\nÊÇ®Êú¨Ê¨°ÁöÑÈÄ£Á∑öË≥ºÁâ©ÊòéÁ¥∞Â¶Ç‰∏ãÔºö\n${itemsText}----------------\nÊ∂àË≤ªÁ∏ΩÈ°çÔºö$${customer.totalSpent.toLocaleString()}\n\nÂèØ‰ª•ÂÖàÂπ´ÊàëÊê≠Ê≥¢ÂçªÂèØ\nÊúâË™§ÁöÑË©±ÔΩûË´ãË∂ïÂø´Ë∑üÊàëË™™ÔºÅ\n‚Çä‚äπ Ëã•ÊòØÊ≤íÊúâÊºèÊéâÁöÑÂïÜÂìÅ ‚Çä‚äπ\nÂ∞±ÂèØ‰ª•Áõ¥Êé•ÁµêÂ∏≥ÂõâÔºÅ\nÁ∂≤ÂùÄÔºöÔºàÈÄôË£°ÁïôÁµ¶ÊàëËá™Â∑±Ëº∏ÂÖ•Á∂≤ÂùÄÔºâ\nÊâæÂà∞Ëá™Â∑±ÂêçÂ≠óÂæåÂÆåÊàê‰∏ãÂñÆÂ∞±ÂèØ‰ª•Âöï\nêôö Êî∂Âà∞ÊâÄÊúâÈÄ£ÁµêÂæåË´ãÁõ°ÈÄüÂÆåÊàê‰ªòÊ¨æ\n   ‰∏çË¶ÅËÄΩË™§Âà∞ÊúÄ‰Ω≥ÁöÑË≥ûÂë≥ÊúüÈôêÂî∑\n\n‚öù p.s. Ââç‰∏ÄÊ¨°ÈÄ£Á∑öÊúâÈñãÁÆ±ÂàÜ‰∫´ÁöÑÊúãÂèã~\n‰∏ãÂñÆÂæåË´ãÂπ´ÊàëÂÇôË®ª‰∏Ä‰∏ãÔºöÈñãÁÆ±Á¶Æ\nùê≠ùê°ùêöùêßùê§ ùê≤ùê®ùêÆ (‚Äû‚Ä¢ ÷ä ‚Ä¢‚Äû)‡©≠`;
                navigator.clipboard.writeText(text).then(() => notify("Â∑≤Ë§áË£Ω")).catch(() => notify("Ë§áË£ΩÂ§±Êïó"));
            };
            
            const handleExportToCSV = () => {
                let csv = "data:text/csv;charset=utf-8,\uFEFFÈ°ßÂÆ¢,ÂïÜÂìÅ,Ê¨æÂºè,Êï∏Èáè,ÂñÆÂÉπ,Á∏ΩÂÉπ\n";
                customerList.forEach(c => c.items.forEach(i => csv += `"${c.name}","${i.name}","${i.variant}",${i.qty},${i.finalPrice},${i.qty*i.finalPrice}\n`));
                const link = document.createElement("a");
                link.href = encodeURI(csv);
                link.download = `orders_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            };

            const getGroupAllocations = (groupName) => {
                const variants = products.filter(p => p.name === groupName);
                const result = [];
                variants.forEach(variant => {
                    orders.forEach(o => {
                        o.items.forEach(item => {
                            if (item.productId === variant.id) {
                                result.push({
                                    orderId: o.id,
                                    productId: variant.id,
                                    customer: o.customer,
                                    qty: item.qty,
                                    variant: variant.variant,
                                    allocatedQty: item.allocatedQty || 0,
                                    isAllocated: (item.allocatedQty || 0) >= item.qty
                                });
                            }
                        });
                    });
                });
                return result;
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-slate-400">Loading Cloud Data...</div>;

            return (
                <div className="min-h-screen pb-24">
                    {/* Notifications */}
                    {notification && <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[300] bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 animate-bounce"><CheckCircle2 size={18} className="text-green-400" />{notification}</div>}

                    {/* Header */}
                    <div className="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-50 flex justify-between items-center max-w-2xl mx-auto">
                        <h1 className="text-xl font-bold flex items-center gap-2" onClick={() => navigateTo('dashboard')}><Zap className="fill-yellow-400 text-yellow-400" /> Smart WMS <span className="text-[10px] bg-indigo-500 px-2 py-1 rounded">Cloud</span></h1>
                    </div>

                    {/* Nav */}
                    <div className="bg-white border-b sticky top-[60px] z-40">
                         <div className="flex max-w-2xl mx-auto overflow-x-auto no-scrollbar">
                            {[{id:'products',l:'ÂïÜÂìÅÂàóË°®',i:ShoppingBag},{id:'dashboard',l:'ÁãÄÊÖã',i:LayoutDashboard},{id:'customers',l:'È°ßÂÆ¢ÂàóË°®',i:Users},{id:'arrivals',l:'Âà∞Ë≤®ÁÆ°ÁêÜ',i:BoxSelect}].map(t => (
                                <button key={t.id} onClick={() => navigateTo(t.id)} className={`flex-1 py-4 px-2 flex flex-col items-center gap-1 text-[10px] font-bold ${activeTab === t.id ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-400'}`}><t.i size={18}/>{t.l}</button>
                            ))}
                        </div>
                    </div>

                    {/* Content */}
                    <main className="max-w-2xl mx-auto p-4 space-y-4">
                        {activeTab !== 'dashboard' && <div className="relative"><input type="text" placeholder="ÊêúÂ∞ã..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full bg-white rounded-2xl p-4 pl-12 shadow-sm outline-none" /><Search size={18} className="absolute left-4 top-4 text-slate-300" /></div>}

                        {/* Products */}
                        {activeTab === 'products' && filteredGroupedProducts.map(g => (
                            <div key={g.name} onClick={() => setSelectedGroupName(g.name)} className="bg-white rounded-3xl p-4 shadow-sm border border-slate-100 flex justify-between items-center cursor-pointer active:scale-98">
                                <div className="flex-1">
                                    <h4 className="font-black text-slate-800 text-lg">{g.name}</h4>
                                    <div className="flex gap-3 mt-1 text-xs text-slate-500">
                                        <span>Âñä {g.totalAllocated}</span><span>ÈÖç {g.totalConfirmed}</span><span>Áèæ {g.totalSpot}</span>
                                    </div>
                                </div>
                                <ChevronRight className="text-slate-300" />
                            </div>
                        ))}

                        {/* Dashboard */}
                        {activeTab === 'dashboard' && (
                            <div className="grid grid-cols-2 gap-4">
                                <div onClick={() => setShowPurchaseList(true)} className="bg-rose-500 text-white p-4 rounded-3xl shadow-lg relative overflow-hidden cursor-pointer">
                                    <p className="text-xs font-bold opacity-80">ÈúÄË£úË≤®</p>
                                    <p className="text-2xl font-black mt-1">{stats.totalShortageQty} ‰ª∂</p>
                                </div>
                                <div onClick={() => setShowRevenueList(true)} className="bg-amber-500 text-white p-4 rounded-3xl shadow-lg relative overflow-hidden cursor-pointer">
                                    <p className="text-xs font-bold opacity-80">Á∏ΩÁáüÊ•≠È°ç</p>
                                    <p className="text-2xl font-black mt-1">${stats.totalRevenue.toLocaleString()}</p>
                                </div>
                            </div>
                        )}

                        {/* Customers */}
                        {activeTab === 'customers' && (
                            <>
                                <div className="flex justify-end"><button onClick={handleExportToCSV} className="bg-emerald-500 text-white px-3 py-1.5 rounded-xl text-xs font-bold flex gap-1 shadow-sm"><FileSpreadsheet size={14}/> ÂåØÂá∫Â†±Ë°®</button></div>
                                {filteredCustomers.map(c => (
                                    <div key={c.name} onClick={() => setSelectedCustomerDetail(c)} className="bg-white rounded-3xl p-4 shadow-sm border border-slate-100 flex justify-between items-center cursor-pointer">
                                        <div className="flex items-center gap-3"><div className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center font-bold">{c.name[0]}</div><h4 className="font-bold text-slate-800">{c.name}</h4></div>
                                        <p className="font-black text-indigo-600">${c.totalSpent.toLocaleString()}</p>
                                    </div>
                                ))}
                            </>
                        )}

                        {/* Arrivals */}
                        {activeTab === 'arrivals' && (
                            <div className="space-y-6">
                                <div>
                                    <h3 className="text-lg font-black text-slate-800 mb-3 px-2 flex gap-2"><Package size={20} className="text-indigo-600"/> ÂæÖÂá∫Ë≤® / Âà∞Ë≤®‰∏≠</h3>
                                    <div className="space-y-4">
                                        {filteredPendingArrivals.length === 0 ? <div className="text-center p-8 text-slate-400 text-sm border-dashed border rounded-3xl">ÁÑ°ÂæÖËôïÁêÜ</div> : filteredPendingArrivals.map(c => (
                                            <div key={c.name} onClick={() => setSelectedArrivalCustomer(c)} className="bg-white rounded-3xl shadow-sm border border-slate-100 p-4 flex justify-between items-center cursor-pointer relative overflow-hidden">
                                                {c.isFullyArrived && <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-emerald-500"></div>}
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${c.isFullyArrived ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-500'}`}>{c.name[0]}</div>
                                                    <div>
                                                        <h4 className="font-bold text-slate-800 flex gap-2 items-center">{c.name} {c.isFullyArrived && <span className="text-[10px] bg-emerald-100 text-emerald-600 px-2 rounded-full">ÂÖ®Âà∞</span>}</h4>
                                                        <p className="text-xs text-slate-500">ÂÖ± {c.totalQty} ‰ª∂ ¬∑ Â∑≤Âà∞ {c.allocatedQty}</p>
                                                    </div>
                                                </div>
                                                <ChevronRight className="text-slate-300" />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="opacity-60">
                                    <h3 className="text-lg font-black text-slate-500 mb-3 px-2 flex gap-2"><PackageCheck size={20}/> Â∑≤Âá∫Ë≤®Á¥ÄÈåÑ</h3>
                                    <div className="space-y-4">
                                        {filteredShippedArrivals.map(c => (
                                            <div key={c.name} onClick={() => setSelectedArrivalCustomer(c)} className="bg-slate-50 rounded-3xl p-4 border border-slate-100 flex justify-between items-center cursor-pointer">
                                                <span className="font-bold text-slate-600">{c.name}</span>
                                                <span className="text-xs bg-gray-200 px-2 py-1 rounded-full">Â∑≤Âá∫Ë≤®</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Floating Action Button */}
                    <div className="fixed bottom-6 right-6 z-[100]">
                        <button onClick={() => setShowProxyOrder(true)} className="w-16 h-16 bg-indigo-600 text-white rounded-full shadow-2xl flex items-center justify-center active:scale-95 transition-all"><Plus size={32}/></button>
                    </div>

                    {/* Modals */}
                    
                    {/* Add Order */}
                    {showProxyOrder && (
                        <div className="fixed inset-0 bg-black/50 z-[200] flex items-end md:items-center justify-center p-4">
                            <div className="bg-white rounded-3xl w-full max-w-md overflow-hidden">
                                <div className="p-4 border-b flex justify-between items-center"><h3>Êñ∞Â¢ûË®ÇÂñÆ / ÂÖ•Â∫´</h3><button onClick={()=>setShowProxyOrder(false)}><X/></button></div>
                                <div className="p-5 space-y-4">
                                    <input type="text" list="prodList" placeholder="ÂïÜÂìÅÂêçÁ®±" className="w-full border p-3 rounded-xl" value={proxyForm.productName} onChange={handleProxyProductChange}/>
                                    <datalist id="prodList">{[...new Set(products.map(p=>p.name))].map(n=><option key={n} value={n}/>)}</datalist>
                                    
                                    <div className="flex gap-2">
                                        <input type="text" list="varList" placeholder="Ê¨æÂºè" className="w-full border p-3 rounded-xl" value={proxyForm.variant} onChange={e=>setProxyForm({...proxyForm,variant:e.target.value})}/>
                                        <datalist id="varList">{availableVariants.map(v=><option key={v} value={v}/>)}</datalist>
                                        <input type="number" placeholder="$" className="w-24 border p-3 rounded-xl" value={proxyForm.price} onChange={e=>setProxyForm({...proxyForm,price:e.target.value})}/>
                                    </div>

                                    <div className="flex gap-2">
                                        <input type="text" list="custList" placeholder="È°ßÂÆ¢ (ÁïôÁ©∫ÁÇ∫ÂÖ•Â∫´)" className="w-full border p-3 rounded-xl" value={proxyForm.customer} onChange={e=>setProxyForm({...proxyForm,customer:e.target.value})}/>
                                        <datalist id="custList">{customerList.map(c=><option key={c.name} value={c.name}/>)}</datalist>
                                        <input type="number" placeholder="Êï∏Èáè" className="w-24 border p-3 rounded-xl" value={proxyForm.qty} onChange={e=>setProxyForm({...proxyForm,qty:e.target.value})}/>
                                    </div>
                                    <div className="text-xs text-slate-500">Ëã•ÁÇ∫Á¥îÂÖ•Â∫´ÔºåË´ãÂ°´ÂØ´ÂïÜÂìÅË≥áË®ä‰∏¶Â∞áÈ°ßÂÆ¢ÁïôÁ©∫ÔºåÊï∏ÈáèÂ°´ÂÖ•„ÄåË≥ºË≤∑Êï∏Èáè„ÄçÊ¨Ñ‰Ωç(‰∏ãÊ¨Ñ)„ÄÇ</div>
                                    <input type="number" placeholder="Â∑≤Êé°Ë≥ºÂÖ•Â∫´Êï∏Èáè (ÈÅ∏Â°´)" className="w-full border p-3 rounded-xl bg-indigo-50" value={proxyForm.purchasedQty} onChange={e=>setProxyForm({...proxyForm,purchasedQty:e.target.value})}/>
                                    
                                    <button onClick={handleAddOrder} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Á¢∫Ë™ç</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Purchase List */}
                    {showPurchaseList && (
                        <div className="fixed inset-0 bg-black/50 z-[150] flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl w-full max-w-md h-[80vh] flex flex-col">
                                <div className="p-4 border-b flex justify-between"><h3>Êé°Ë≥ºÊ∏ÖÂñÆ</h3><button onClick={()=>setShowPurchaseList(false)}><X/></button></div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {purchaseList.length===0?<div className="text-center text-slate-400 mt-10">ÁÑ°Áº∫Ë≤®</div>:purchaseList.map(p=>(
                                        <div key={p.id} className="flex justify-between items-center p-3 border-b">
                                            <div><div className="font-bold">{p.name}</div><div className="text-xs text-slate-500">{p.variant}</div></div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs text-slate-400">Áº∫</span>
                                                {editingPurchaseQtyId === p.id ? 
                                                    <input autoFocus className="w-12 border rounded text-center" type="number" defaultValue={p.shortage} onBlur={e=>handleUpdatePurchaseQty(p.id,e.target.value)} /> :
                                                    <span onClick={()=>setEditingPurchaseQtyId(p.id)} className="text-rose-600 font-black text-lg cursor-pointer">{p.shortage}</span>
                                                }
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Revenue List */}
                    {showRevenueList && (
                         <div className="fixed inset-0 bg-black/50 z-[150] flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl w-full max-w-md h-[80vh] flex flex-col">
                                <div className="p-4 border-b flex justify-between"><h3>ÁáüÊî∂Á∏ΩË¶Ω</h3><button onClick={()=>setShowRevenueList(false)}><X/></button></div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {customerList.filter(c=>c.totalSpent>0).sort((a,b)=>b.totalSpent-a.totalSpent).map(c=>(
                                        <div key={c.name} onClick={()=>{setShowRevenueList(false);setSelectedCustomerDetail(c)}} className="flex justify-between p-3 border rounded-xl items-center cursor-pointer">
                                            <span className="font-bold">{c.name}</span>
                                            <span className="font-mono">${c.totalSpent.toLocaleString()}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Product Detail */}
                    {selectedGroupName && (
                        <div className="fixed inset-0 bg-black/50 z-[150] flex items-end md:items-center justify-center p-0 md:p-4">
                             <div className="bg-white rounded-t-[30px] md:rounded-3xl w-full max-w-md h-[85vh] flex flex-col">
                                <div className="p-6 border-b flex justify-between items-start">
                                    <div><h3 className="text-xl font-bold">{selectedGroupName}</h3><p className="text-xs text-slate-400">ÈÖçË≤®ÁÆ°ÁêÜ</p></div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>{setProxyForm(prev=>({...prev,productName:selectedGroupName}));setShowProxyOrder(true)}} className="p-2 bg-slate-100 rounded-full"><Plus size={18}/></button>
                                        <button onClick={()=>setIsEditingProduct(!isEditingProduct)} className={`p-2 rounded-full ${isEditingProduct?'bg-indigo-600 text-white':'bg-slate-100'}`}><Edit size={18}/></button>
                                        <button onClick={()=>setSelectedGroupName(null)} className="p-2 bg-slate-100 rounded-full"><X size={18}/></button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                    <div className="bg-slate-50 p-3 rounded-xl">
                                        <table className="w-full text-xs text-center">
                                            <thead><tr className="text-slate-400"><th>Ê¨æÂºè</th><th>Â∑≤ÈÖç</th><th>ÂæÖÈÖç</th><th>ÁèæË≤®</th>{isEditingProduct&&<th></th>}</tr></thead>
                                            <tbody>
                                                {productsWithStats.filter(p=>p.name===selectedGroupName).map(p=>(
                                                    <tr key={p.id} className="border-t border-slate-200">
                                                        <td className="py-3 text-left">{p.variant}</td>
                                                        <td className="text-indigo-600">{p.confirmed}</td>
                                                        <td className="text-rose-500">{p.pending}</td>
                                                        <td>{isEditingProduct?<input className="w-10 text-center border rounded" defaultValue={p.spot} onBlur={e=>handleUpdateProductInfo(p.id,'spot',e.target.value)}/>:p.spot}</td>
                                                        {isEditingProduct&&<td><button onClick={()=>handleDeleteProduct(p.id)} className="text-rose-500"><Trash2 size={14}/></button></td>}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        {isEditingProduct && <div className="mt-2 text-center"><button onClick={(e)=>handleDeleteProductGroup(selectedGroupName,e)} className="text-xs text-rose-500 flex items-center justify-center gap-1 w-full py-2 border border-rose-200 rounded-lg"><Trash2 size={12}/> Âà™Èô§Ê≠§ÂïÜÂìÅÂÖ®ÈÉ®Ë≥áÊñô</button></div>}
                                    </div>
                                    <div>
                                        <h4 className="text-xs font-bold text-slate-400 mb-2">ÈÖçË≤®ÊòéÁ¥∞</h4>
                                        {getGroupAllocations(selectedGroupName).map((r,i)=>(
                                            <div key={i} className={`flex justify-between items-center p-3 border rounded-xl mb-2 ${r.isAllocated?'bg-indigo-50 border-indigo-200':'bg-white'}`}>
                                                <div className="flex items-center gap-3">
                                                    <button onClick={()=>toggleAllocation(r.orderId,r.productId,r.allocatedQty,r.qty)} className={`w-6 h-6 rounded border flex items-center justify-center ${r.isAllocated?'bg-indigo-600 text-white border-indigo-600':''}`}><CheckSquare size={14}/></button>
                                                    <div><div className="font-bold text-sm">{r.customer}</div><div className="text-[10px] text-slate-500">{r.variant}</div></div>
                                                </div>
                                                <div className="flex items-center gap-1 text-sm">
                                                    <span className="text-slate-400 text-xs">ÈÖç</span>
                                                    {editingAllocatedQtyId===`${r.orderId}-${r.productId}` ? 
                                                        <input autoFocus className="w-8 text-center border-b border-indigo-500 outline-none bg-transparent" defaultValue={r.allocatedQty} onBlur={e=>handleUpdateAllocatedQty(r.orderId,r.productId,e.target.value)}/> : 
                                                        <span onClick={()=>setEditingAllocatedQtyId(`${r.orderId}-${r.productId}`)} className="font-bold text-indigo-600 cursor-pointer">{r.allocatedQty}</span>
                                                    }
                                                    <span className="text-slate-400 text-xs">/ Âñä</span>
                                                    {editingOrderQtyId===`${r.orderId}-${r.productId}` ? 
                                                        <input autoFocus className="w-8 text-center border-b border-slate-500 outline-none bg-transparent" defaultValue={r.qty} onBlur={e=>handleUpdateOrderQty(r.orderId,r.productId,e.target.value)}/> : 
                                                        <span onClick={()=>setEditingOrderQtyId(`${r.orderId}-${r.productId}`)} className="font-bold cursor-pointer">{r.qty}</span>
                                                    }
                                                    <button onClick={()=>handleDeleteOrderItem(r.orderId,r.productId)} className="ml-2 text-slate-300 hover:text-rose-500"><Trash2 size={14}/></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                             </div>
                        </div>
                    )}

                    {/* Modal: Customer Detail */}
                    {selectedCustomerDetail && currentSelectedCustomer && (
                        <div className="fixed inset-0 bg-black/50 z-[160] flex items-end md:items-center justify-center p-0 md:p-4">
                            <div className="bg-white rounded-t-[30px] md:rounded-3xl w-full max-w-md h-[85vh] flex flex-col">
                                <div className="p-6 border-b flex justify-between items-start">
                                    <div>
                                        <h3 className="text-xl font-bold">{currentSelectedCustomer.name}</h3>
                                        <div className="text-xs text-indigo-600 font-bold mt-1">Á∏ΩÈ°ç: ${currentSelectedCustomer.totalSpent.toLocaleString()}</div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>{setProxyForm(prev=>({...prev,customer:currentSelectedCustomer.name}));setShowProxyOrder(true)}} className="p-2 bg-slate-100 rounded-full"><Plus size={18}/></button>
                                        <button onClick={()=>handleCopyCustomerDetails(currentSelectedCustomer)} className="p-2 bg-slate-100 rounded-full"><Copy size={18}/></button>
                                        <button onClick={()=>setSelectedCustomerDetail(null)} className="p-2 bg-slate-100 rounded-full"><X size={18}/></button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {currentSelectedCustomer.items.map((item,idx)=>(
                                        <div key={idx} className="flex justify-between items-center p-3 border-b">
                                            <div>
                                                <div className="font-bold text-sm">{item.name}</div>
                                                <div className="text-xs text-slate-500">{item.variant} ¬∑ ${item.finalPrice}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="flex items-center gap-1 justify-end">
                                                    <span className="text-xs text-slate-400">x</span>
                                                    {editingOrderQtyId===`${item.orderId}-${item.productId}` ? 
                                                        <input autoFocus className="w-8 text-center border rounded" defaultValue={item.qty} onBlur={e=>handleUpdateOrderQty(item.orderId,item.productId,e.target.value)}/> :
                                                        <span onClick={()=>setEditingOrderQtyId(`${item.orderId}-${item.productId}`)} className="font-bold cursor-pointer">{item.qty}</span>
                                                    }
                                                    <button onClick={()=>handleDeleteOrderItem(item.orderId,item.productId)} className="ml-1 text-slate-300 hover:text-rose-500"><Trash2 size={12}/></button>
                                                </div>
                                                <div className="text-xs text-indigo-600 font-bold">${item.itemTotal}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal: Arrival Check */}
                    {currentSelectedArrivalCustomer && (
                        <div className="fixed inset-0 bg-black/50 z-[150] flex items-end md:items-center justify-center p-0 md:p-4">
                            <div className="bg-white rounded-t-[30px] md:rounded-3xl w-full max-w-md h-[85vh] flex flex-col">
                                <div className="p-6 bg-slate-800 text-white rounded-t-[30px] flex justify-between items-start shrink-0">
                                    <div>
                                        <h3 className="text-xl font-bold">{currentSelectedArrivalCustomer.name}</h3>
                                        <p className="text-xs opacity-70 mt-1">{isArrivalShipped ? 'Â∑≤Âá∫Ë≤®Ë®ÇÂñÆ' : 'ÈÖçË≤®Ê™¢Ê†∏'}</p>
                                    </div>
                                    <button onClick={()=>setSelectedArrivalCustomer(null)} className="bg-white/20 p-2 rounded-full"><X size={18}/></button>
                                </div>
                                
                                {/* ÁãÄÊÖãËàáÊìç‰ΩúÂçÄ */}
                                <div className="px-6 py-3 bg-slate-800 text-white flex justify-between items-center shrink-0">
                                    <div className="text-xs opacity-80">
                                        ÈÄ≤Â∫¶: {currentSelectedArrivalCustomer.arrivedItemsCount} / {currentSelectedArrivalCustomer.totalItemsCount} È†Ö
                                    </div>
                                    {/* Âè™ÊúâÂú®ÂæÖÂá∫Ë≤®ÁãÄÊÖã‰∏îÂ∑≤ÂÖ®Âà∞Ë≤®ÊôÇÈ°ØÁ§∫Âá∫Ë≤®ÊåâÈàï */}
                                    {!isArrivalShipped && currentSelectedArrivalCustomer.isFullyArrived && (
                                        <button onClick={()=>handleShipCustomer(currentSelectedArrivalCustomer.name)} className="bg-emerald-500 px-3 py-1 rounded-lg text-xs font-bold flex items-center gap-1 shadow animate-pulse">
                                            <Truck size={14}/> Á¢∫Ë™çÂá∫Ë≤®
                                        </button>
                                    )}
                                    {/* ÂèñÊ∂àÂá∫Ë≤®ÊåâÈàï */}
                                    {isArrivalShipped && (
                                        <button onClick={()=>handleUnshipCustomer(currentSelectedArrivalCustomer.name)} className="bg-amber-500 px-3 py-1 rounded-lg text-xs font-bold flex items-center gap-1 shadow">
                                            <Undo2 size={14}/> ÂõûÂæ©Êú™Âá∫Ë≤®
                                        </button>
                                    )}
                                </div>

                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                    {currentSelectedArrivalCustomer.items.map((item,idx)=>{
                                        const isDone = (item.allocatedQty||0) >= item.qty;
                                        return (
                                            <div key={idx} className={`flex justify-between items-center p-3 border rounded-xl ${isDone?'bg-emerald-50 border-emerald-200':'bg-white'} ${isArrivalShipped?'opacity-70':''}`}>
                                                <div className="flex items-center gap-3 flex-1">
                                                    {!isArrivalShipped ? (
                                                        <button onClick={()=>toggleAllocation(item.orderId,item.productId,item.allocatedQty||0,item.qty)} className={`w-6 h-6 rounded border flex items-center justify-center ${isDone?'bg-emerald-500 border-emerald-500 text-white':''}`}><CheckSquare size={14}/></button>
                                                    ) : <div className="w-6 h-6 flex items-center justify-center bg-gray-200 rounded text-gray-500"><PackageCheck size={14}/></div>}
                                                    <div>
                                                        <div className="font-bold text-sm text-slate-700">{item.name}</div>
                                                        <div className="text-[10px] text-slate-500">{item.variant}</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-1 text-sm">
                                                    <span className="text-xs text-slate-400">ÈÖç</span>
                                                    {!isArrivalShipped && editingAllocatedQtyId===`${item.orderId}-${item.productId}` ?
                                                        <input autoFocus className="w-8 text-center border-b border-indigo-500 outline-none bg-transparent" defaultValue={item.allocatedQty||0} onBlur={e=>handleUpdateAllocatedQty(item.orderId,item.productId,e.target.value)}/> :
                                                        <span onClick={()=>!isArrivalShipped && setEditingAllocatedQtyId(`${item.orderId}-${item.productId}`)} className={`font-bold ${isDone?'text-emerald-600':'text-indigo-600'} ${!isArrivalShipped && 'cursor-pointer'}`}>{item.allocatedQty||0}</span>
                                                    }
                                                    <span className="text-xs text-slate-400">/ Ë®Ç {item.qty}</span>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
